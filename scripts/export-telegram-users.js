require('dotenv').config();
const Firebird = require('node-firebird');
const fs = require('fs');
const path = require('path');

const config = {
 host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT) || 3050,
  database: process.env.DB_NAME || '/firebird/data/ITM_DB.FDB',
  user: process.env.DB_USER || 'SYSDBA',
  password: process.env.DB_PASSWORD || 'masterkey',
  lowercase_keys: false,
 charset: 'UTF8',
};

console.log('ðŸ”§ Export Telegram Users Script for MYugBotV3');
console.log('Connecting to:', config.database);
console.log('');

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
Firebird.attach(config, (err, db) => {
  if (err) {
    console.error('âŒ Connection error:', err.message);
    process.exit(1);
  }

  console.log('âœ… Connection established\n');

  // ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ TG_USERS Ð¸ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
 const tgUsersQuery = `
    SELECT 
      ID,
      CHAT_ID,
      FIRST_NAME,
      LAST_NAME,
      USERNAME,
      GROUP_ID,
      IS_ACTIVE,
      IS_REGISTERED,
      IS_BLOCKED,
      CREATED_AT,
      UPDATED_AT
    FROM TG_USERS
    ORDER BY ID
 `;

  db.query(tgUsersQuery, [], (err, users) => {
    if (err) {
      console.log('âŒ Error querying TG_USERS table:', err.message);
      db.detach(() => process.exit(1));
      return;
    }

    if (users.length === 0) {
      console.log('â„¹ï¸  No users found in TG_USERS table');
      db.detach(() => process.exit(0));
      return;
    }

    console.log(`âœ… Found ${users.length} users in TG_USERS table`);

    // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
    const formattedUsers = users.map(user => ({
      id: user.ID,
      chat_id: user.CHAT_ID,
      first_name: user.FIRST_NAME || '',
      last_name: user.LAST_NAME || '',
      username: user.USERNAME || '',
      group_id: user.GROUP_ID || 1,
      is_active: user.IS_ACTIVE,
      is_registered: user.IS_REGISTERED,
      is_blocked: user.IS_BLOCKED,
      created_at: user.CREATED_AT,
      updated_at: user.UPDATED_AT
    }));

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² JSON Ñ„Ð°Ð¹Ð»
    const outputPath = path.join(__dirname, 'telegram-users-seed.json');
    fs.writeFileSync(outputPath, JSON.stringify(formattedUsers, null, 2));

    console.log(`âœ… Telegram users exported successfully to ${outputPath}`);
    console.log(`ðŸ“Š Total exported users: ${formattedUsers.length}`);

    // Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ SQL-ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°
    const sqlOutputPath = path.join(__dirname, 'import-telegram-users.sql');
    const sqlLines = [];
    sqlLines.push('-- Telegram Users Import Script for MYugBotV3');
    sqlLines.push('-- Generated by export-telegram-users.js');
    sqlLines.push('');
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    sqlLines.push('-- Clear existing users (optional)');
    sqlLines.push('-- DELETE FROM TG_USERS;');
    sqlLines.push('');
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð´Ð»Ñ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
    sqlLines.push('-- Insert Telegram users');
    formattedUsers.forEach(user => {
      // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Firebird
      const createdAt = new Date(user.created_at).toISOString().replace('T', ' ').replace('Z', '');
      const updatedAt = new Date(user.updated_at).toISOString().replace('T', ' ').replace('Z', '');
      
      const insertQuery = `INSERT INTO TG_USERS (ID, CHAT_ID, FIRST_NAME, LAST_NAME, USERNAME, GROUP_ID, IS_ACTIVE, IS_REGISTERED, IS_BLOCKED, CREATED_AT, UPDATED_AT) VALUES (${user.id}, ${user.chat_id}, '${user.first_name.replace(/'/g, "''")}', '${user.last_name.replace(/'/g, "''")}', '${user.username.replace(/'/g, "''")}', ${user.group_id}, ${user.is_active}, ${user.is_registered}, ${user.is_blocked}, '${createdAt}', '${updatedAt}');`;
      sqlLines.push(insertQuery);
    });

    fs.writeFileSync(sqlOutputPath, sqlLines.join('\n'));

    console.log(`âœ… SQL import script created at ${sqlOutputPath}`);

    // Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð² Ð½Ð¾Ð²ÑƒÑŽ Ð‘Ð”
    const migrationOutputPath = path.join(__dirname, 'migrate-telegram-users.sql');
    const migrationLines = [];
    migrationLines.push('-- Telegram Users Migration Script for MYugBotV3');
    migrationLines.push('-- Used for deploying to new database');
    migrationLines.push('');
    migrationLines.push('-- First, ensure TG_USERS table exists');
    migrationLines.push('EXECUTE BLOCK AS BEGIN');
    migrationLines.push(' IF (NOT EXISTS(SELECT 1 FROM RDB$RELATIONS WHERE RDB$SYSTEM_FLAG=0 AND RDB$VIEW_BLR IS NULL AND RDB$RELATION_NAME=\'TG_USERS\')) THEN');
    migrationLines.push('    EXECUTE STATEMENT \'CREATE TABLE TG_USERS (ID INTEGER NOT NULL PRIMARY KEY, CHAT_ID BIGINT NOT NULL UNIQUE, FIRST_NAME VARCHAR(255), LAST_NAME VARCHAR(255), USERNAME VARCHAR(255), GROUP_ID INTEGER DEFAULT 1, PARENT_ID INTEGER, PHONENUMBER VARCHAR(50), CARD VARCHAR(50), CARDOWNER VARCHAR(255), IS_ACTIVE SMALLINT DEFAULT 1, IS_REGISTERED SMALLINT DEFAULT 0, IS_BLOCKED SMALLINT DEFAULT 0, BILLING_ID INTEGER, CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP, UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP)\';');
    migrationLines.push('END;');
    migrationLines.push('');
    migrationLines.push('-- Insert Telegram users with error handling');
    migrationLines.push('EXECUTE BLOCK AS BEGIN');
    formattedUsers.forEach(user => {
      // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð´Ð°Ñ‚Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Firebird
      const createdAt = new Date(user.created_at).toISOString().replace('T', ' ').replace('Z', '');
      const updatedAt = new Date(user.updated_at).toISOString().replace('T', ' ').replace('Z', '');
      
      migrationLines.push('  EXECUTE STATEMENT \'INSERT INTO TG_USERS (ID, CHAT_ID, FIRST_NAME, LAST_NAME, USERNAME, GROUP_ID, IS_ACTIVE, IS_REGISTERED, IS_BLOCKED, CREATED_AT, UPDATED_AT) VALUES (' + user.id + ', ' + user.chat_id + ', \'' + user.first_name.replace(/'/g, "''") + '\', \'' + user.last_name.replace(/'/g, "''") + '\', \'' + user.username.replace(/'/g, "''") + '\', ' + user.group_id + ', ' + user.is_active + ', ' + user.is_registered + ', ' + user.is_blocked + ', \'' + createdAt + '\', \'' + updatedAt + '\')\' WITH AUTONOMOUS TRANSACTION;');
    });
    migrationLines.push('END;');

    fs.writeFileSync(migrationOutputPath, migrationLines.join('\n'));

    console.log(`âœ… Migration script created at ${migrationOutputPath}`);

    db.detach(() => process.exit(0));
  });
});