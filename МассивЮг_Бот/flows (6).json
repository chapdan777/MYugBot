[
    {
        "id": "e2619ce4.622d3",
        "type": "tab",
        "label": "Tg Bot v3.9",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3c7a7b4d.4e0484",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Initialization",
        "func": "let APP = \"App\";\n\nlet app = flow.get(APP);\nlet errorsBank = flow.get(\"ErrorsBank\");\n\nif (!app) {\n  errorsBank.addMsg(\"SERVER RESTARTING...\");\n  app = {\n    isRestarting: true,\n    buttons: undefined,\n    keyboards: undefined,\n    user: undefined,\n    users: undefined,\n    documents: undefined,\n    evaluate(str) {\n      str = str.replace(/\\s+/g, \"\");\n      return parseFloat(eval(str));\n    },\n    phoneMask(phone) {\n      const regex = /(\\d?)(\\d{3})(\\d{3})(\\d{2})(\\d{2})/g;\n      const subst = \"+$1($2)$3-$4-$5\";\n      return phone.replace(regex, subst);\n    },\n    validateEmail(email) {\n      const re =\n        /^(([^<>()[\\]\\\\.,;:\\s@\\\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\\\"]+)*)|(\\\".+\\\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n      return re.test(email);\n    },\n    formatMonetary(value) {\n      value = parseFloat(String(value).replace(\",\", \".\").replace(\" \", \"\"));\n      value = value.toFixed(2);\n      let tempValue = [];\n      let i = 0;\n      [...value].reverse().forEach((element) => {\n        if (i >= 3) {\n          tempValue.push(\"\");\n          i = 0;\n        }\n        i++;\n        if (element == \".\") i = 0;\n        tempValue.push(element);\n      });\n      return \"<code>\" + tempValue.reverse().join(\"\") + \"</code> ₽\";\n    },\n    formatMessage(text) {\n      text = text.replace(new RegExp(\">\", \"g\"), \"&gt\");\n      text = text.replace(new RegExp(\"<\", \"g\"), \"&lt\");\n      return text;\n    },\n    stringToDate(txt) {\n      try {\n        let parts = txt\n          .replace(/\\./g, \"-\")\n          .replace(/\\,/g, \"-\")\n          .replace(/\\//g, \"-\")\n          .split(\"-\");\n        if (!parts[2]) {\n          parts.push(new Date().getFullYear());\n        }\n        return new Date(\n          parts[2].length == 2\n            ? new Date().getFullYear().toString().substr(0, 2) + parts[2]\n            : parts[2],\n          parts[1] - 1,\n          parts[0]\n        );\n      } catch (error) {\n        return false;\n      }\n    },\n    formatDateAndTime(date) {\n      return (\n        (\"0\" + date.getDate()).slice(-2) +\n        \".\" +\n        (\"0\" + (date.getMonth() + 1)).slice(-2) +\n        \".\" +\n        date.getFullYear() +\n        \" \" +\n        (\"0\" + date.getHours()).slice(-2) +\n        \":\" +\n        (\"0\" + date.getMinutes()).slice(-2)\n      );\n    },\n    formatDate(date) {\n      if (!date) return \"\";\n      let yy = date.getFullYear() % 100;\n      if (yy < 10) yy = \"0\" + yy;\n      return (\n        (\"0\" + date.getDate()).slice(-2) +\n        \".\" +\n        (\"0\" + (date.getMonth() + 1)).slice(-2) +\n        \".\" +\n        yy\n      );\n    },\n    formatDateToDb(date) {\n      if (!date) return \"\";\n      return date.toLocaleDateString();\n      //return (date.getFullYear() + \"-\" + (\"0\"+(date.getMonth()+1)).slice(-2) + \"-\" + \"0\" + date.getDate()).slice(-2);\n    },\n    isValidDate(date) {\n      return (\n        date &&\n        Object.prototype.toString.call(date) === \"[object Date]\" &&\n        !isNaN(date)\n      );\n    },\n  };\n  let users = {\n    userList: [],\n    groupOfUsers: [],\n    app: app,\n    loading(callback) {\n      let query = `select * from tg_users`;\n      return this.app.db\n        .executeRequest(null, \"cubic\", query)\n        .then((queryObject) => {\n          let res = queryObject.result;\n          res.forEach((u) => {\n            let user = this.createUser();\n            user.id = u.ID;\n            user.chatId = u.CHAT_ID;\n            user.groupId = u.GROUP_ID;\n            user.parentId = u.PARENT_ID;\n            user.first_name = u.FIRST_NAME;\n            user.last_name = u.LAST_NAME;\n            user.username = u.USER_NAME;\n            user._phoneNumber = u.PHONENUMBER;\n            user._card = u.CARD;\n            user._cardOwner = u.CARDOWNER;\n            user.isRegistered = Boolean(u.IS_REGISTERED);\n            user.isBlocked = Boolean(u.IS_BLOCKED);\n            user.billingAccountId = u.BILLING_ID;\n            this.userList.push(user);\n          });\n          return this.app.db\n            .executeRequest(null, \"cubic\", \"select * from tg_group\")\n            .then((queryObject) => {\n              let res = queryObject.result;\n              res.forEach((g) => {\n                this.groupOfUsers.push({ id: g.ID, name: g.NAME });\n              });\n              if (callback && typeof callback === \"function\")\n                callback(null, this);\n              return this;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\")\n                callback(\n                  new Error(\n                    \"Произошла ошибка при загрузке пользователей из базы данных.\"\n                  )\n                );\n              return err;\n            });\n        })\n        .catch((err) => {\n          if (callback && typeof callback === \"function\")\n            callback(\n              new Error(\n                \"Произошла ошибка при загрузке пользователей из базы данных.\"\n              )\n            );\n          return err;\n        });\n    },\n    count() {\n      return this.userList.length;\n    },\n    getUsersByGroupId(id, besides) {\n      return this.userList.filter(\n        (user) => user.groupId == id && user.id != besides\n      );\n    },\n    getUserToFirstName(name) {\n      return this.userList.find((user) => user.first_name == name);\n    },\n    getUserToId(id) {\n      return this.userList.find((user) => user.id == id);\n    },\n    getUserToChatId(chatId) {\n      return this.userList.find((user) => user.chatId == chatId);\n    },\n    sendMessageToAllUsers(message, isHideKeyboard = false) {\n      return app.msgBank.sendMessage(this.userList, message, isHideKeyboard);\n    },\n    sendMsgToGroupId(id, message, isHideKeyboard = false, besides) {\n      return app.msgBank.sendMessage(\n        this.getUsersByGroupId(id, besides),\n        message,\n        isHideKeyboard\n      );\n    },\n    createUser(callback) {\n      let user = {\n        id: 0,\n        chatId: 0,\n        groupId: 1,\n        parentId: null,\n        first_name: null,\n        last_name: null,\n        username: null,\n        _phoneNumber: null,\n        _card: null,\n        _cardOwner: null,\n        isRegistered: false,\n        isBlocked: false,\n        billingAccountId: null,\n        originalMessage: null,\n        editableUser: undefined,\n        editableDocument: undefined,\n        editableStage: undefined,\n        editableElement: undefined,\n        cassaOperationData: new Date(),\n        isNew: true,\n        mode: { id: 0, step: 0, date: new Date(), msg: undefined },\n        keyPointList: [],\n        users: undefined,\n        app: app,\n        balance() {},\n        phone() {\n          if (this._phoneNumber) {\n            return this._phoneNumber;\n          } else {\n            return null;\n          }\n        },\n        cardOwner() {\n          return this._cardOwner || \"Не указан\";\n        },\n        card() {\n          if (this._card) {\n            let formatCard = \"\";\n            let i = 0;\n            [...String(this._card)].forEach((element) => {\n              if (!isNaN(element) && element != \" \") {\n                if (i <= 3) {\n                  formatCard += element;\n                  i++;\n                } else {\n                  formatCard += \" \" + element;\n                  i = 1;\n                }\n              }\n            });\n            return \"<code>\" + formatCard + \"</code>\";\n          } else {\n            return \"Не указана\";\n          }\n        },\n        parent() {\n          return this.users.userList.find((user) => user.id == this.parentId);\n        },\n        group() {\n          return this.users.groupOfUsers.find(\n            (group) => group.id == this.groupId\n          );\n        },\n        setParent(user) {\n          this.parentId = user.id;\n        },\n        setGroup(g) {\n          this.groupId = g.id;\n        },\n        sendKeyboardInLine(\n          message,\n          isHideKeyboard = false,\n          keyboard,\n          callback\n        ) {\n          return this.app.msgBank.sendKeyboardInLine(\n            this,\n            message,\n            isHideKeyboard,\n            keyboard,\n            callback\n          );\n        },\n        sendMessage(message, isHideKeyboard = false, callback) {\n          return this.app.msgBank.sendMessage(\n            this,\n            message,\n            isHideKeyboard,\n            callback\n          );\n        },\n        sendKeyboard(keyboard, message, oneTime = false, resize = true) {\n          return this.app.msgBank.sendKeyboard(\n            this,\n            keyboard,\n            message,\n            oneTime,\n            resize\n          );\n        },\n        setMode(id, step, isKeyPoint, msg) {\n          if (isKeyPoint) this.addKeyPoint(this.mode);\n          this.mode.id = id;\n          this.mode.step = step;\n          this.mode.date = Date.now();\n          this.mode.msg = msg;\n        },\n        addKeyPoint(mode) {\n          if (this.keyPointList.length > 10) this.keyPointList.shift();\n          let tempMode = this.keyPointList[this.keyPointList.length - 1];\n\n          if (\n            !tempMode ||\n            (tempMode.id != mode.id &&\n              tempMode.step != mode.step &&\n              tempMode.msg != mode.msg)\n          ) {\n            this.keyPointList.push({\n              id: mode.id,\n              step: mode.step,\n              date: Date(),\n              msg: mode.msg,\n            });\n            return true;\n          }\n          return false;\n        },\n        getLastKeyPoint() {\n          let tempMode = this.keyPointList.pop();\n          return !tempMode\n            ? { id: 0, step: 0, date: new Date(), msg: undefined }\n            : tempMode;\n        },\n        reset() {\n          this.keyPointList = [];\n          this.mode = { id: 0, step: 0, date: new Date(), msg: undefined };\n\n          if (this.editableUser) this.editableUser.reload();\n          if (this.editableDocument) this.editableDocument.reload();\n          if (this.editableStage) this.editableStage.reload();\n\n          this.editableUser = undefined;\n          this.editableDocument = undefined;\n          this.editableStage = undefined;\n          this.tempData = undefined;\n\n          this.editableElement = undefined;\n        },\n        reload(callback) {\n          let query = `select * from tg_users u where u.id = ${this.id}`;\n          return this.app.db\n            .executeRequest(null, \"cubic\", query)\n            .then((queryObject) => {\n              let res = queryObject.result;\n              res.forEach((u) => {\n                this.id = u.ID;\n                this.chatId = u.CHAT_ID;\n                this.groupId = u.GROUP_ID;\n                this.parentId = u.PARENT_ID;\n                this.first_name = u.FIRST_NAME;\n                this.last_name = u.LAST_NAME;\n                this.username = u.USER_NAME;\n                this._phoneNumber = u.PHONENUMBER;\n                this._card = u.CARD;\n                this.isRegistered = Boolean(u.IS_REGISTERED);\n                this.isBlocked = Boolean(u.IS_BLOCKED);\n                this.billingAccountId = u.BILLING_ID;\n              });\n              if (callback && typeof callback === \"function\")\n                callback(null, this);\n              return this;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\")\n                callback(\n                  new Error(\n                    `Произошла ошибка при загрузке данных пользователя [ID: ${this.id}]`\n                  )\n                );\n              return err;\n            });\n        },\n        save(user, callback) {\n          let query;\n          if (!this.first_name) {\n            if (callback && typeof callback === \"function\")\n              callback(\"Не заполнено одно или несколько обязательных полей\");\n            return null;\n          }\n          if (this.id) {\n            // Изменение существующего пользователя.\n            query = `select RESULT from TGP_EDIT_USER (\n                        ${this.id}, \n                        ${!this.chatId ? null : this.chatId}, \n                        ${!this.groupId ? null : this.groupId}, \n                        ${!this.parentId ? null : this.parentId},\n                        ${\n                          !this.first_name ? null : \"'\" + this.first_name + \"'\"\n                        },\n                        ${!this.last_name ? null : \"'\" + this.last_name + \"'\"},\n                        ${!this.username ? null : \"'\" + this.username + \"'\"},\n                        ${\n                          !this._phoneNumber\n                            ? null\n                            : \"'\" + this._phoneNumber + \"'\"\n                        },\n                        ${!this._card ? null : \"'\" + this._card + \"'\"}, \n                        ${\n                          !this._cardOwner ? null : \"'\" + this._cardOwner + \"'\"\n                        }, \n                        ${\n                          !this.billingAccountId ? null : this.billingAccountId\n                        })`;\n\n            return this.app.db\n              .executeRequest(user, \"cubic\", query)\n              .then((res) => {\n                if (res.result[0].RESULT == 0) {\n                  if (callback && typeof callback === \"function\")\n                    callback(\n                      new Error(\"Не удалось изменить данные пользователя.\")\n                    );\n                  return this;\n                } else {\n                  if (callback && typeof callback === \"function\")\n                    callback(null, this);\n                  return this;\n                }\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\") callback(err);\n                return err;\n              });\n          } else {\n            // Создание пользователя\n            query = `select ID, CHAT_ID, GROUP_ID, FIRST_NAME, LAST_NAME, USER_NAME, IS_REGISTERED, IS_BLOCKED, BILLING_ID, PARENT_ID\n                    from TGP_CREATE_USER(\n                        '${this.first_name}', \n                        ${this.chatId == 0 ? null : this.chatId},\n                        ${this.groupId == 0 ? null : this.groupId},\n                        ${!this.last_name ? null : \"'\" + this.last_name + \"'\"},\n                        ${!this.username ? null : \"'\" + this.username + \"'\"},\n                        ${!user ? null : user.id})`;\n\n            return this.app.db\n              .executeRequest(user, \"cubic\", query)\n              .then((queryObject) => {\n                let res = queryObject.result;\n                this.id = res[0].ID;\n                this.chatId = res[0].CHAT_ID;\n                this.groupId = res[0].GROUP_ID;\n                this.parentId = res[0].PARENT_ID;\n                this.first_name = res[0].FIRST_NAME;\n                this.last_name = res[0].LAST_NAME;\n                this.username = res[0].USER_NAME;\n                this.isRegistered = Boolean(res[0].IS_REGISTERED);\n                this.isBlocked = Boolean(res[0].IS_BLOCKED);\n                this.billingAccountId = res[0].BILLING_ID;\n                this.users.userList.push(this);\n                if (callback && typeof callback === \"function\")\n                  callback(null, this);\n                return this;\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\") callback(err);\n                return err;\n              });\n          }\n        },\n      };\n      user.users = this;\n      if (callback && typeof callback === \"function\") callback(user);\n      return user;\n    },\n    getUser(originalMessage, callback) {\n      if (!originalMessage) {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n      let user = this.getUserToChatId(originalMessage.from.id);\n      if (user) {\n        user.originalMessage = originalMessage;\n        if (callback && typeof callback === \"function\") callback(user);\n        return user;\n      } else {\n        this.createUser((tempUser) => {\n          user = tempUser;\n          user.chatId = originalMessage.from.id;\n          user.first_name = originalMessage.from.first_name;\n          user.last_name = originalMessage.from.last_name;\n          user.username = originalMessage.from.username;\n          user.save(null, (err, u) => {\n            if (err) {\n              if (callback && typeof callback === \"function\") callback(null);\n              return null;\n            }\n            u.originalMessage = originalMessage;\n            if (callback && typeof callback === \"function\") callback(u);\n            return u;\n          });\n        });\n      }\n    },\n    printUsers(reg = true, id) {\n      try {\n        let USER_ID_PREFIX = \"/user\";\n        let tempUsers = [];\n        if (id) {\n          tempUsers = this.userList.filter((u) => u.group().id == id);\n        } else {\n          if (reg) {\n            tempUsers = this.userList.filter(\n              (item) => item.isRegistered == true\n            );\n          } else {\n            tempUsers = this.userList.filter(\n              (item) => item.isRegistered == false\n            );\n          }\n        }\n        let i = 1;\n        return tempUsers.map((item) => {\n          return `${i++}. [${USER_ID_PREFIX}${item.id}] ${\n            item?.first_name || \"Нет имени\"\n          } роль: ${item.group()?.name || \"Группа не задана\"} ${\n            item.isBlocked ? \"(Заблокирован)\" : \"\"\n          }`\n            .replace(new RegExp(\">\", \"g\"), \"&gt\")\n            .replace(new RegExp(\"<\", \"g\"), \"&lt\");\n        });\n      } catch (error) {\n        return [`Ошибка обработки данных ${error?.message}`];\n      }\n    },\n    openUser(text, callback) {\n      let USER_ID_REG = /\\/user/;\n      if (!text) {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n      if (text.match(USER_ID_REG)) {\n        let [command, id] = text.split(USER_ID_REG);\n        let user = this.userList.find((u) => u.id == id);\n\n        if (user) {\n          if (callback && typeof callback === \"function\") callback(null, user);\n          return user;\n        } else {\n          if (callback && typeof callback === \"function\")\n            callback(\"Пользователь не найден.\", null);\n          return null;\n        }\n      } else {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n    },\n  };\n  let documents = {\n    documentList: [],\n    stageList: [],\n    elementList: [],\n    materilList: [],\n    statusList: [],\n    typeElementList: [],\n    app: app,\n    averagePriceMassiv(user, massiv, doc, callback) {\n      query = `\n        select D.id, M.NAME,\n        (select coalesce(sum(L2.RESULT_VALUE), 0)\n        from TG_STAGES S2\n        left join TG_STAGE_ELEMENTS L2 on (L2.ID_STAGE = S2.ID)\n        left join TG_TYPE_ELEMENT T2 on (L2.TYPE_ELEMENT_ID = T2.ID)\n        where S2.MATERIAL_ID = S.MATERIAL_ID and\n              T2.ELEMENT_GROUP = 6 and\n              S2.DOCUMENT_ID = D.ID) as RES, coalesce(sum(L.RESULT_SUM * TR.MODIFER), 0) as SUMM\n        from TG_STAGES S\n        left join MATERIAL M on (S.MATERIAL_ID = M.ID)\n        left join TG_DOCUMENTS D on (S.DOCUMENT_ID = D.ID)\n        left join TG_STAGE_ELEMENTS L on (L.ID_STAGE = S.ID)\n        left join TG_TRANSACTIONS TR on (TR.ID_STAGE_ELEMENT = L.ID)\n        left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n        left join TG_USERS U on (TR.ID_BILLING_ACCOUNT = U.BILLING_ID)\n        where T.ELEMENT_GROUP != 1 and\n            (d.isdeleted is null or (d.isdeleted = 0)) and\n            (s.isdeleted is null or (s.isdeleted = 0)) and\n            T.ELEMENT_GROUP != 10 and\n            TR.MODIFER = -1 and\n            d.status_id = 2 and\n            UPPER(m.name) = '${massiv.toUpperCase()}'\n        group by D.id, M.NAME, S.MATERIAL_ID`;\n\n      return this.app.db\n        .executeRequest(user, \"cubic\", query)\n        .then((queryObject) => {\n          let res = queryObject.result;\n          if (res) {\n            let tempArr = res\n              .map((item) => {\n                if (item.SUMM && item.RES) {\n                  return item.SUMM / item.RES;\n                }\n                return 0;\n              })\n              .filter((item) => item != 0);\n            let tempSumm = tempArr.reduce((total, item) => {\n              return total + item;\n            }, 0);\n            if (tempSumm) {\n              if (callback && typeof callback === \"function\")\n                callback(null, Math.abs(tempSumm) / res.length);\n              return Math.abs(tempSumm) / tempArr.length;\n            }\n          }\n          if (callback && typeof callback === \"function\") callback(null, 0);\n          return 0;\n        })\n        .catch((err) => {\n          if (callback && typeof callback === \"function\") callback(err);\n          return err;\n        });\n    },\n    getReportForAgent(user, idDoc) {\n      let query = `select BILLING_ID, MODIFER, ELEMENT_GROUP_ID, NAME, SUMM from TGP_GET_AGENT_TOTAL_DATA (${idDoc})`;\n      return this.app.db\n        .executeRequest(user, \"cubic\", query)\n        .then((queryObject) => {\n          let dataArr = queryObject.result;\n          let tempArr = [];\n          if (dataArr.length <= 0) return tempArr;\n          let billingsUniqueID = [\n            ...new Set(\n              dataArr.map((item) => {\n                return item.BILLING_ID;\n              })\n            ),\n          ];\n          billingsUniqueID.forEach((bId) => {\n            let a = { billingId: bId, type: 0, summ: 0, prepaid: 0 };\n            dataArr.forEach((element) => {\n              if (element.BILLING_ID == a.billingId) {\n                if (element.ELEMENT_GROUP_ID == 1 && element.MODIFER == 1) {\n                  if (a.type == 0) a.type = 1;\n                  a.prepaid += element.SUMM;\n                }\n                a.summ += element.SUMM;\n              }\n            });\n            if (a.type == 1) {\n              tempArr.push(a);\n            } else {\n              if (a.summ > 0) {\n                a.type = 2;\n                tempArr.push(a);\n              }\n            }\n          });\n          return tempArr;\n        })\n        .catch((err) => {\n          throw err;\n        });\n    },\n    getMoneyStage(user, idStage) {\n      let billingId = null;\n      let stage = this.stageList.find((s) => s.id == idStage);\n      if (!stage) return;\n      if (!stage.firstElement()) return;\n      if (stage.firstElement().type().groupId == 1) {\n        if (stage.firstElement().recipient()) {\n          billingId = stage.firstElement().recipient().billingAccountId;\n        }\n      } else {\n        if (stage.firstElement().sender()) {\n          billingId = stage.firstElement().sender().billingAccountId;\n        }\n      }\n      let query = `select * from tgp_get_money_stage (${stage.documentId}, ${stage.id}, ${billingId})`;\n      return this.app.db\n        .executeRequest(user, \"cubic\", query)\n        .then((queryObject) => {\n          return queryObject.result ? queryObject.result[0] : undefined;\n        })\n        .catch((err) => {\n          node.error(err);\n        });\n    },\n    count() {\n      return this.documentList.length;\n    },\n    openDoc(text, callback) {\n      let DOC_ID_REG = /\\/doc/;\n      if (!text) {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n      if (text.match(DOC_ID_REG)) {\n        let [command, id] = text.split(DOC_ID_REG);\n        let doc = this.documentList.find((d) => d.id == id);\n        if (doc) {\n          if (callback && typeof callback === \"function\") callback(null, doc);\n          return doc;\n        } else {\n          if (callback && typeof callback === \"function\")\n            callback(\"Документ не найден.\", null);\n          return null;\n        }\n      } else {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n    },\n    openStage(text, callback) {\n      let STAGE_ID_REG = /\\/stg/;\n      if (!text) {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n      if (text.match(STAGE_ID_REG)) {\n        let [command, id] = text.split(STAGE_ID_REG);\n        let stage = this.stageList.find((s) => s.id == id);\n        if (stage) {\n          if (callback && typeof callback === \"function\") callback(null, stage);\n          return stage;\n        } else {\n          if (callback && typeof callback === \"function\")\n            callback(\"Этап не найден.\", null);\n          return null;\n        }\n      } else {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n    },\n    openElement(text, callback) {\n      let ELEMENT_ID_REG = /\\/item/;\n      if (!text) {\n        if (callback && typeof callback === \"function\") callback(null);\n        return null;\n      }\n      if (text.match(ELEMENT_ID_REG)) {\n        let [command, id] = text.split(ELEMENT_ID_REG);\n        let item = this.elementList.find((l) => l.id == id);\n        if (item) {\n          if (callback && typeof callback === \"function\") callback(null, item);\n          return item;\n        } else {\n          if (callback && typeof callback === \"function\")\n            callback(\"Документ не найден.\", null);\n          return null;\n        }\n      } else {\n        callback(null);\n        return null;\n      }\n    },\n    loadingSettings(callback) {\n      return this.app.db\n        .executeRequest(\n          null,\n          \"cubic\",\n          \"select m.id, m.name from material m where m.massiv != 0\"\n        )\n        .then((queryObject) => {\n          let res = queryObject.result;\n          this.materilList = [];\n          res.forEach((m) => {\n            this.materilList.push({ id: m.ID, name: m.NAME });\n          });\n          return this.app.db\n            .executeRequest(null, \"cubic\", \"select * from tg_statuses\")\n            .then((queryObject) => {\n              let res = queryObject.result;\n              this.statusList = [];\n              res.forEach((s) => {\n                this.statusList.push({ id: s.ID, name: s.NAME });\n              });\n              return this.app.db\n                .executeRequest(\n                  null,\n                  \"cubic\",\n                  \"select * from tg_type_element t order by t.SORT_COLUMN\"\n                )\n                .then((queryObject) => {\n                  let res = queryObject.result;\n                  this.typeElementList = [];\n                  res.forEach((t) => {\n                    this.typeElementList.push({\n                      id: t.ID,\n                      name: t.NAME,\n                      unit: t.UNIT,\n                      calculation: t.TYPE_CALCULATION,\n                      groupId: t.ELEMENT_GROUP,\n                    });\n                  });\n                  if (callback && typeof callback === \"function\")\n                    callback(null, this);\n                  return this;\n                })\n                .catch((err) => {\n                  if (callback && typeof callback === \"function\") callback(err);\n                  return err;\n                });\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        })\n        .catch((err) => {\n          if (callback && typeof callback === \"function\") callback(err);\n          return err;\n        });\n    },\n    loading(callback) {\n      return this.app.db\n        .executeRequest(\n          null,\n          \"cubic\",\n          `select *\n                                                    from TG_DOCUMENTS d\n                                                    where d.isdeleted is null or (d.isdeleted = 0)\n                                                    order by id`\n        )\n        .then((queryObject) => {\n          let res = queryObject.result;\n          this.documentList = [];\n          res.forEach((d) => {\n            let doc = this.createDocument();\n            doc.id = d.ID;\n            doc.statusId = d.STATUS_ID;\n            doc.authorId = d.AUTHOR_ID;\n            doc.documentName = d.DOCUMENT_NAME;\n            doc.commentary = d.COMMENTARY;\n            doc.dateCreation = new Date(d.DATE_CREATION);\n            doc.markedForDeletion = d.MARKED_FOR_DELETION;\n            this.documentList.push(doc);\n          });\n          return this.app.db\n            .executeRequest(\n              null,\n              \"cubic\",\n              `select *\n                                                                from TG_STAGES S\n                                                                where S.ISDELETED is null or (S.ISDELETED = 0)\n                                                                order by ID`\n            )\n            .then((queryObject) => {\n              let res = queryObject.result;\n              this.stageList = [];\n              res.forEach((s) => {\n                let stage = this.createStage();\n                stage.id = s.ID;\n                stage.documentId = s.DOCUMENT_ID;\n                stage.stageNumber = s.STAGE_NUMBER;\n                stage.authorId = s.AUTHOR_ID;\n                stage.statusId = s.STATUS_ID;\n                stage.materialId = s.MATERIAL_ID;\n                stage.stageName = s.STAGE_NAME;\n                stage.dateCreation = new Date(s.DATE_CREATION);\n                stage.commentary = s.COMMENTARY;\n                stage.dateStage = s.DATE_STAGE ? new Date(s.DATE_STAGE) : null;\n                stage.isNotification = s.IS_NOTIFICATION;\n                stage.markedForDeletion = s.MARKED_FOR_DELETION;\n                this.stageList.push(stage);\n              });\n              return this.app.db\n                .executeRequest(\n                  null,\n                  \"cubic\",\n                  `select * from tg_stage_elements order by id`\n                )\n                .then((queryObject) => {\n                  let res = queryObject.result;\n                  this.elementList = [];\n                  res.forEach((e) => {\n                    let element = this.createElement();\n                    element.id = e.ID;\n                    element.stageId = e.ID_STAGE;\n                    element.typeElementId = e.TYPE_ELEMENT_ID;\n                    element.authorId = e.AUTHOR_ID;\n                    element.h = e.H;\n                    element.w = e.W;\n                    element.l = e.L;\n                    element.a = e.A;\n                    element.price = e.PRICE;\n                    element.value = e.RESULT_VALUE;\n                    element.summ = e.RESULT_SUM;\n                    element.dateCreation = new Date(e.DATE_CREATION);\n                    element.dateElement = new Date(e.DATE_ELEMENT);\n                    element.senderId = e.SENDER_ID;\n                    element.recipientId = e.RECIPIENT_ID;\n                    element.typePayment = e.TYPE_PAYMENT;\n                    this.elementList.push(element);\n                  });\n                  if (callback && typeof callback === \"function\")\n                    callback(null, this);\n                  return this;\n                })\n                .catch((err) => {\n                  if (callback && typeof callback === \"function\") callback(err);\n                  return err;\n                });\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        })\n        .catch((err) => {\n          if (callback && typeof callback === \"function\") callback(err);\n          return err;\n        });\n    },\n    createDocument(author, callback) {\n      let document = {\n        id: 0,\n        statusId: 0,\n        authorId: 0,\n        documentName: null,\n        commentary: null,\n        dateCreation: null,\n        markedForDeletion: null,\n        documents: documents,\n        app: app,\n        getClosedData(user, callback) {\n          let query = `\n                select M.NAME,\n                (select coalesce(sum(L2.RESULT_VALUE), 0)\n                    from TG_STAGES S2\n                    left join TG_STAGE_ELEMENTS L2 on (L2.ID_STAGE = S2.ID)\n                    left join TG_TYPE_ELEMENT T2 on (L2.TYPE_ELEMENT_ID = T2.ID)\n                    where S2.MATERIAL_ID = S.MATERIAL_ID and\n                        T2.ELEMENT_GROUP = 6 and\n                        S2.DOCUMENT_ID = ${this.id}) as RES, coalesce(sum(L.RESULT_SUM * TR.MODIFER), 0) as SUMM \n                from TG_STAGES S\n                left join MATERIAL M on (S.MATERIAL_ID = M.ID)\n                left join TG_DOCUMENTS D on (S.DOCUMENT_ID = D.ID)\n                left join TG_STAGE_ELEMENTS L on (L.ID_STAGE = S.ID)\n                left join TG_TRANSACTIONS TR on (TR.ID_STAGE_ELEMENT = L.ID)\n                left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n                left join TG_USERS U on (TR.ID_BILLING_ACCOUNT = U.BILLING_ID)\n                where T.ELEMENT_GROUP != 1 and\n                (d.isdeleted is null or (d.isdeleted = 0)) and\n                (s.isdeleted is null or (s.isdeleted = 0)) and\n                T.ELEMENT_GROUP != 10 and\n                T.ELEMENT_GROUP != 11 and\n                TR.MODIFER = -1 and\n                D.ID = ${this.id}\n                group by M.NAME, S.MATERIAL_ID`;\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              if (callback && typeof callback === \"function\")\n                callback(null, queryObject.result);\n              return queryObject.result;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        markForDeletion(user, callback) {\n          let query =\n            \"update tg_documents d set d.marked_for_deletion = -1 where d.id = \" +\n            this.id;\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              this.markedForDeletion = -1;\n              if (callback && typeof callback === \"function\")\n                callback(null, true);\n              return true;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        delete(user, callback) {\n          let query = `update tg_documents d set d.isdeleted = -1 where d.id = ${this.id}`;\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              this.documents.documentList.forEach((doc, index, arr) => {\n                if (doc.id == this.id) {\n                  arr.splice(index, 1);\n                }\n              });\n              if (callback && typeof callback === \"function\")\n                callback(null, true);\n              return true;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        summ() {\n          return this.stages().reduce((total, item) => {\n            return total + item.summ();\n          }, 0);\n        },\n        AmountOfPayments() {\n          return this.stages().reduce((total, item) => {\n            return total + item.AmountOfPayments();\n          }, 0);\n        },\n        dynamicName() {\n          let txt = undefined;\n          if (this.count()) {\n            let s = this.stages()[0];\n            if (s) {\n              let l = s.firstElement();\n              if (l) {\n                if (l.type().groupId == 1) {\n                  txt =\n                    \"<b>\" +\n                    this.app.formatMessage(l.recipient().first_name) +\n                    \"</b>\";\n                } else {\n                  txt =\n                    \"<b>\" +\n                    this.app.formatMessage(l.sender().first_name) +\n                    \"</b>\";\n                }\n              }\n              txt += \", \" + this.app.formatMessage(s.stageName);\n            }\n          }\n          return txt;\n        },\n        unpaid() {\n          for (const iterator of this.stages()) {\n            if (iterator.unpaid()) return true;\n          }\n          return false;\n        },\n        count() {\n          return this.documents.stageList.filter(\n            (stage) => stage.documentId == this.id\n          ).length;\n        },\n        stages() {\n          return this.documents.stageList\n            .filter(\n              (stage) => stage.documentId == this.id && stage.firstElement()\n            )\n            .sort((a, b) => {\n              ElementA = a.firstElement();\n              ElementB = b.firstElement();\n              if (!ElementA) return 0;\n              if (!ElementB) return 0;\n              typeElementIdA = ElementA.type().groupId;\n              typeElementIdB = ElementB.type().groupId;\n              if (typeElementIdA > typeElementIdB) return 1;\n              if (typeElementIdA < typeElementIdB) return -1;\n              if (typeElementIdA == typeElementIdB) {\n                if (a.dateStage > b.dateStage) return 1;\n                if (a.dateStage < b.dateStage) return -1;\n              }\n              return 0;\n            });\n        },\n        status() {\n          return this.documents.statusList.find(\n            (status) => status.id == this.statusId\n          );\n        },\n        author() {\n          return this.app.users.userList.find(\n            (user) => user.id == this.authorId\n          );\n        },\n        reload(callback) {\n          let query = `select * from tg_documents d where d.id = ${this.id}`;\n          if (!this.id || this.id == 0) {\n            if (callback && typeof callback === \"function\")\n              callback(\n                new Error(\n                  `Произошла ошибка при загрузке документа № ${this.id}`\n                )\n              );\n            return new Error(\n              `Произошла ошибка при загрузке документа № ${this.id}`\n            );\n          }\n          return this.app.db\n            .executeRequest(null, \"cubic\", query)\n            .then((queryObject) => {\n              let res = queryObject.result[0];\n              this.statusId = res.STATUS_ID;\n              this.authorId = res.AUTHOR_ID;\n              this.documentName = res.DOCUMENT_NAME;\n              this.commentary = res.COMMENTARY;\n              this.dateCreation = new Date(res.DATE_CREATION);\n              if (callback && typeof callback === \"function\")\n                callback(null, this);\n              return this;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\")\n                callback(\n                  new Error(\n                    `Произошла ошибка при загрузке документа № ${this.id}`\n                  )\n                );\n              return err;\n            });\n        },\n        save(user, callback) {\n          let query;\n          if (!this.id || this.id == 0) {\n            query = `select ID from TGP_CREATE_DOCUMENT (\n                        ${user.id}, \n                        ${\n                          !this.documentName\n                            ? null\n                            : \"'\" + this.documentName + \"'\"\n                        },\n                        ${\n                          !this.commentary ? null : \"'\" + this.commentary + \"'\"\n                        })`;\n            return this.app.db\n              .executeRequest(user, \"cubic\", query)\n              .then((queryObject) => {\n                let tempId = queryObject.result[0].ID;\n                if (tempId) {\n                  this.id = tempId;\n                  this.reload((err, doc) => {\n                    if (err) throw err;\n                    this.documents.documentList.push(doc);\n                    if (callback && typeof callback === \"function\")\n                      callback(null, doc);\n                    return this;\n                  });\n                } else {\n                  return callback(\n                    new Error(\"Во время создания заказа, произошла ошибка.\")\n                  );\n                }\n              })\n              .catch((err) => {\n                callback(\n                  new Error(\"Во время создания заказа, произошла ошибка.\")\n                );\n                return err;\n              });\n          } else {\n            query = `\n                            update tg_documents d set\n                            d.status_id = ${this.statusId},\n                            d.document_name = ${\n                              !this.documentName\n                                ? null\n                                : \"'\" + this.documentName + \"'\"\n                            }, \n                            d.commentary = ${\n                              !this.commentary\n                                ? null\n                                : \"'\" + this.commentary + \"'\"\n                            }\n                            where d.id = ${this.id}`;\n            return this.app.db\n              .executeRequest(user, \"cubic\", query)\n              .then((queryObject) => {\n                return this.reload((err, doc) => {\n                  if (err) throw err;\n                  if (callback && typeof callback === \"function\")\n                    callback(null, doc);\n                  return doc;\n                });\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\") callback(err);\n                return err;\n              });\n          }\n        },\n        createStage(author, callback) {\n          let stage = this.documents.createStage();\n          if (author) {\n            stage.authorId = author.id;\n            author.editableStage = stage;\n          }\n          if (!this.id) {\n            callback(\n              new Error(\"Документ не сохранен, создание этапа не возможно.\"),\n              null\n            );\n            return null;\n          } else {\n            stage.documentId = this.id;\n            callback(null, stage);\n            return stage;\n          }\n        },\n      };\n      if (author) {\n        document.authorId = author.id;\n        author.editableDocument = document;\n      }\n      if (callback && typeof callback === \"function\") callback(document);\n      return document;\n    },\n    createStage() {\n      let stage = {\n        id: null,\n        documentId: null,\n        stageNumber: null,\n        authorId: null,\n        statusId: null,\n        materialId: null,\n        stageName: null,\n        dateCreation: null,\n        dateStage: null,\n        commentary: null,\n        isNotification: null,\n        markedForDeletion: null,\n        documents: documents,\n        app: app,\n        markForDeletion(user, callback) {\n          let query =\n            \"update tg_stages s set s.marked_for_deletion = -1 where s.id = \" +\n            this.id;\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              this.markedForDeletion = -1;\n              if (callback && typeof callback === \"function\")\n                callback(null, true);\n              return true;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        delete(user, callback) {\n          let query = `update tg_stages s set s.isdeleted = -1 where s.id = ${this.id}`;\n\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              this.documents.stageList.forEach((stg, index, arr) => {\n                if (stg.id == this.id) {\n                  arr.splice(index, 1);\n                }\n              });\n              if (callback && typeof callback === \"function\")\n                callback(null, true);\n              return true;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        notificationComplit(callback) {\n          this.app.db\n            .executeRequest(\n              null,\n              \"cubic\",\n              \"update tg_stages s set s.is_notification = -1 where s.id = \" +\n                this.id\n            )\n            .then((qOb) => {\n              this.isNotification = -1;\n              if (callback && typeof callback === \"function\") callback();\n            })\n            .catch();\n        },\n        async money(user) {\n          let billingId = null;\n          if (this.firstElement.type().groupId == 1) {\n            if (this.firstElement.recipient) {\n              billingId = this.firstElement.recipient.billingAccountId;\n            }\n          } else {\n            if (this.firstElement.sender) {\n              billingId = this.firstElement.sender.billingAccountId;\n            }\n          }\n          let query = `select * from tgp_get_money_stage (${this.documentId}, ${this.id}, ${billingId})`;\n          let queryObject = await this.app.db.executeRequest(\n            user,\n            \"cubic\",\n            query\n          );\n          let res = queryObject.result;\n          return res;\n        },\n        summ() {\n          return this.elements().reduce((total, item) => {\n            if (item.type().groupId >= 2 && item.type().groupId <= 6) {\n              return total + item.summ;\n            } else {\n              return total;\n            }\n          }, 0);\n        },\n        AmountOfPayments() {\n          return this.elements().reduce((total, item) => {\n            if (item.type().groupId == 10 || item.type().groupId == 11) {\n              return total + item.summ;\n            } else {\n              return total;\n            }\n          }, 0);\n        },\n        balance() {\n          return this.summ() - this.AmountOfPayments();\n        },\n        unpaid() {\n          try {\n            let check = this.balance() > 0;\n            if (\n              this.firstElement() &&\n              this.firstElement().type().groupId == 1\n            ) {\n              check = this.balance() <= 0;\n            }\n            return check;\n          } catch (error) {\n            return false;\n          }\n        },\n        dynamicName() {\n          let txt =\n            \" \" +\n            this.app.formatDate(\n              this.dateStage ? this.dateStage : this.dateCreation\n            ) +\n            \" <b>\" +\n            this.stageName +\n            \"</b>\";\n          let l = this.firstElement();\n          if (!l) return txt;\n          switch (l.type().groupId) {\n            case 1:\n              txt +=\n                \" - \" +\n                this.app.formatMonetary(l.summ) +\n                \" \" +\n                l.recipient().first_name +\n                \" (\" +\n                l.typePayment +\n                \")\";\n              break;\n            case 2:\n            case 3:\n            case 4:\n            case 5:\n              if (l.typeElementId == 1) {\n                txt +=\n                  \" - \" +\n                  (this.material() ? this.material().name + \", \" : \"\") +\n                  (l.sender() ? l.sender().first_name : \" \") +\n                  \", \" +\n                  l.value +\n                  \" м3\" +\n                  \" × \" +\n                  this.app.formatMonetary(l.price);\n                if (l.recipient())\n                  txt +=\n                    \"\\nПолучатель: \" +\n                    l.recipient().first_name +\n                    (l.summ > 0\n                      ? \" (на сумму \" + this.app.formatMonetary(l.summ) + \")\"\n                      : \"\");\n              } else {\n                txt +=\n                  \" - \" +\n                  (this.material() ? this.material().name + \", \" : \"\") +\n                  (l.sender() ? l.sender().first_name : \" \") +\n                  \", \" +\n                  l.value +\n                  \" м3\" +\n                  \" × \" +\n                  this.app.formatMonetary(l.price);\n              }\n              break;\n            case 6:\n              txt +=\n                \" - \" +\n                (this.material() ? this.material().name + \", \" : \"\") +\n                (l.sender() ? l.sender().first_name : \" \") +\n                \", \" +\n                l.value +\n                \" м3\";\n              break;\n            default:\n              break;\n          }\n          return txt;\n        },\n        count() {\n          return this.documents.elementList.filter((e) => e.stageId == this.id)\n            .length;\n        },\n        material() {\n          return this.documents.materilList.find(\n            (m) => m.id == this.materialId\n          );\n        },\n        document() {\n          return this.documents.documentList.find(\n            (doc) => doc.id == this.documentId\n          );\n        },\n        elements() {\n          return this.documents.elementList\n            .filter((element) => element.stageId == this.id)\n            .sort((a, b) => {\n              if (a.type().groupId > b.type().groupId) return 1;\n              if (a.type().groupId < b.type().groupId) return -1;\n              return 0;\n            });\n        },\n        payments() {\n          return this.documents.elementList.filter((element) => {\n            return (\n              element.stageId == this.id &&\n              (element.type().groupId == 10 || element.type().groupId == 11)\n            );\n          });\n        },\n        firstElement() {\n          if (this.count() > 0) return this.elements()[0];\n          return undefined;\n        },\n        author() {\n          return this.app.users.userList.find(\n            (user) => user.id == this.authorId\n          );\n        },\n        status() {\n          return this.documents.statusList.find(\n            (status) => status.id == this.statusId\n          );\n        },\n        reload(callback) {\n          let query = `select * from tg_stages s where s.id = ${this.id}`;\n          if (!this.id) {\n            let err = new Error(\"Этап еще не сохранен в базу данных.\");\n            if (callback && typeof callback === \"function\") callback(err);\n            return err;\n          }\n          return this.app.db\n            .executeRequest(null, \"cubic\", query)\n            .then((queryObject) => {\n              let res = queryObject.result[0];\n              this.documentId = res.DOCUMENT_ID;\n              this.stageNumber = res.STAGE_NUMBER;\n              this.authorId = res.AUTHOR_ID;\n              this.statusId = res.STATUS_ID;\n              this.materialId = res.MATERIAL_ID;\n              this.stageName = res.STAGE_NAME;\n              this.dateCreation = new Date(res.DATE_CREATION);\n              this.commentary = res.COMMENTARY;\n              if (callback && typeof callback === \"function\")\n                callback(null, this);\n              return this;\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        save(author, callback) {\n          let query;\n          if (!this.id) {\n            query = `select ID from TGP_CREATE_STAGE(\n                        ${this.documentId}, \n                        ${author.id}, \n                        ${this.stageName ? \"'\" + this.stageName + \"'\" : null}, \n                        ${this.materialId ? this.materialId : null},\n                        ${this.commentary ? \"'\" + this.commentary + \"'\" : null},\n                        ${\n                          this.dateStage\n                            ? \"'\" +\n                              this.app.formatDateToDb(this.dateStage) +\n                              \"'\"\n                            : null\n                        })`;\n            return this.app.db\n              .executeRequest(author, \"cubic\", query)\n              .then((queryObject) => {\n                let tempId = queryObject.result[0].ID;\n                this.id = tempId;\n                return this.reload((err, s) => {\n                  if (err) {\n                    if (callback && typeof callback === \"function\")\n                      callback(err);\n                    return err;\n                  }\n                  this.documents.stageList.push(this);\n                  if (callback && typeof callback === \"function\")\n                    callback(null, s);\n                  return s;\n                });\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\") callback(err);\n                return err;\n              });\n          } else {\n            query = `select RESULT from TGP_EDIT_STAGE (\n                        ${this.id},\n                        ${this.stageName ? \"'\" + this.stageName + \"'\" : null},\n                        ${this.statusId},\n                        ${this.materialId},\n                        ${this.commentary ? \"'\" + this.commentary + \"'\" : null},\n                        ${\n                          this.dateStage\n                            ? \"'\" +\n                              this.app.formatDateToDb(this.dateStage) +\n                              \"'\"\n                            : null\n                        }\n                    )`;\n            return this.app.db\n              .executeRequest(author, \"cubic\", query)\n              .then((queryObject) => {\n                let res = queryObject.result[0].RESULT;\n                if (res) {\n                  return this.reload((err, s) => {\n                    if (err) {\n                      if (callback && typeof callback === \"function\")\n                        callback(err);\n                      return err;\n                    } else {\n                      if (callback && typeof callback === \"function\")\n                        callback(null, s);\n                      return s;\n                    }\n                  });\n                } else {\n                  let err = new Error(\"Поля этапа не были изменены.\");\n                  if (callback && typeof callback === \"function\") callback(err);\n                  return err;\n                }\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\") callback(err);\n                return err;\n              });\n          }\n        },\n        createElement(author, callback) {\n          let element = this.documents.createElement();\n          if (author) {\n            element.authorId = author.id;\n            author.editableElement = element;\n          }\n          if (!this.id) {\n            return callback(\n              new Error(\"Этап не сохранен, создание элемента не возможно.\"),\n              null\n            );\n          } else {\n            element.stageId = this.id;\n            return callback(null, element);\n          }\n        },\n      };\n      return stage;\n    },\n    createElement() {\n      let element = {\n        id: null,\n        stageId: null,\n        typeElementId: null,\n        authorId: null,\n        h: 0,\n        w: 0,\n        l: 0,\n        a: 0,\n        price: 0,\n        value: null,\n        summ: null,\n        senderId: null,\n        recipientId: null,\n        dateCreation: null,\n        dateElement: null,\n        typePayment: null,\n        documents: documents,\n        app: app,\n        delete(user) {\n          if (this.type().groupId != 10 && this.type().groupId != 11)\n            return false;\n          let query = \"delete from tg_stage_elements l where l.id = \" + this.id;\n          let res = false;\n          return this.app.db\n            .executeRequest(user, \"cubic\", query)\n            .then((queryObject) => {\n              this.documents.elementList.forEach((element, i, arr) => {\n                if (element.id == this.id) {\n                  arr.splice(i, 1);\n                  res = true;\n                }\n              });\n              return res;\n            })\n            .catch((err) => {\n              return err;\n            });\n        },\n        save(author, callback) {\n          let query = \"\";\n          if (this.id) {\n            query = `update TG_STAGE_ELEMENTS L\n                            set L.H = ${this.h},\n                                L.W = ${this.w},\n                                L.L = ${this.l},\n                                L.A = ${this.a},\n                                L.PRICE = ${this.price},\n                                L.SENDER_ID = ${this.senderId},\n                                L.RECIPIENT_ID = ${this.recipientId},\n                                L.TYPE_ELEMENT_ID = ${this.typeElementId}\n                            where L.ID = ${this.id}`;\n\n            return this.app.db\n              .executeRequest(author, \"cubic\", query)\n              .then((queryObject) => {\n                query = `\n                        select L.RESULT_VALUE, L.RESULT_SUM\n                        from TG_STAGE_ELEMENTS L\n                        where L.ID = ${this.id}`;\n                return this.app.db\n                  .executeRequest(author, \"cubic\", query)\n                  .then((queryObject2) => {\n                    let res = queryObject2.result[0];\n\n                    this.value = res.RESULT_VALUE;\n                    this.summ = res.RESULT_SUM;\n\n                    if (callback && typeof callback === \"function\")\n                      callback(null, this);\n                  })\n                  .catch((err) => {\n                    if (callback && typeof callback === \"function\")\n                      callback(err, null);\n                  });\n              })\n              .catch((err) => {\n                if (callback && typeof callback === \"function\")\n                  callback(err, null);\n              });\n            return;\n          }\n\n          query = `SELECT * FROM TGP_CREATE_ELEMET(\n                    ${this.stageId},\n                    ${author.id},\n                    ${this.typeElementId},\n                    ${this.senderId ? this.senderId : null},\n                    ${this.recipientId ? this.recipientId : null},\n                    ${this.h}, ${this.w}, ${this.l}, ${this.a}, \n                    ${this.price},\n                    ${\n                      this.dateElement\n                        ? \"'\" + this.app.formatDateToDb(this.dateElement) + \"'\"\n                        : null\n                    },\n                    ${this.typePayment ? \"'\" + this.typePayment + \"'\" : null})`;\n\n          return this.app.db\n            .executeRequest(author, \"cubic\", query)\n            .then((queryObject) => {\n              let res = queryObject.result[0];\n              this.id = res.ID;\n              this.stageId = res.ID_STAGE;\n              this.typeElementId = res.TYPE_ELEMENT_ID;\n              this.authorId = res.AUTHOR_ID;\n              this.h = res.H;\n              this.w = res.W;\n              this.l = res.L;\n              this.a = res.A;\n              this.price = res.PRICE;\n              this.value = res.RESULT_VALUE;\n              this.summ = res.RESULT_SUM;\n              this.senderId = res.SENDER_ID;\n              this.recipientId = res.RECIPIENT_ID;\n              this.dateCreation = new Date(res.DATE_CREATION);\n              this.dateElement = new Date(res.DATE_ELEMENT);\n              this.typePayment = res.TYPE_PAYMENT;\n              if (!res.ID) {\n                if (callback && typeof callback === \"function\")\n                  callback(new Error(\"Ошибка создания элемента.\"));\n                return null;\n              } else {\n                this.documents.elementList.push(this);\n                if (callback && typeof callback === \"function\")\n                  callback(null, this);\n                return this;\n              }\n            })\n            .catch((err) => {\n              if (callback && typeof callback === \"function\") callback(err);\n              return err;\n            });\n        },\n        dynamicName() {\n          let txt = \"\";\n          return txt;\n        },\n        stage() {\n          return this.documents.stageList.find((s) => (s.id = this.stageId));\n        },\n        sender() {\n          return this.app.users.userList.find(\n            (user) => user.id == this.senderId\n          );\n        },\n        recipient() {\n          return this.app.users.userList.find(\n            (user) => user.id == this.recipientId\n          );\n        },\n        type() {\n          return this.documents.typeElementList.find(\n            (t) => t.id == this.typeElementId\n          );\n        },\n      };\n      return element;\n    },\n  };\n  let msgBank = {\n    //disable_notification:  тихая отправка\n    messages: [],\n    app: app,\n    sendMessageMarkdown(users, message, isHideKeyboard = false) {\n      let addressesList = [];\n      if (users instanceof Array) {\n        addressesList = users.map((user) => user.chatId);\n      } else {\n        addressesList.push(users.chatId);\n      }\n      if (addressesList.length == 0) return null;\n      let msg = {\n        options: {\n          parse_mode: \"HTML\",\n          reply_markup: JSON.stringify({ hide_keyboard: isHideKeyboard }),\n        },\n        chatId: addressesList,\n        type: \"message\",\n        date: new Date(),\n        content: message,\n      };\n      this.messages.unshift(msg);\n      return msg;\n    },\n    sendMessage(users, message, isHideKeyboard = false, callback) {\n      let addressesList = [];\n      if (users instanceof Array) {\n        addressesList = users.map((user) => user.chatId);\n      } else {\n        addressesList.push(users.chatId);\n      }\n      if (addressesList.length == 0) return null;\n      let msg = {\n        options: {\n          parse_mode: \"HTML\",\n          reply_markup: JSON.stringify({ hide_keyboard: isHideKeyboard }),\n        },\n        chatId: addressesList,\n        type: \"message\",\n        date: new Date(),\n        content: message,\n        callback: callback,\n      };\n      this.messages.unshift(msg);\n      return msg;\n    },\n    editMessage(user, message, isHideKeyboard = false, messageId, keyboard) {\n      if (!messageId) return;\n      reply_markup = {};\n      if (isHideKeyboard) reply_markup.hide_keyboard = isHideKeyboard;\n      if (keyboard) reply_markup.inline_keyboard = keyboard;\n      let msg = {\n        options: {\n          chat_id: user.chatId,\n          parse_mode: \"HTML\",\n          disable_web_page_preview: false,\n          reply_markup: JSON.stringify(reply_markup),\n          message_id: messageId,\n        },\n        type: \"editMessageText\",\n        date: new Date(),\n        content: message,\n        callback: undefined,\n      };\n      this.messages.unshift(msg);\n      return msg;\n    },\n    sendKeyboard(users, keyboard, message, oneTime = false, resize = true) {\n      let addressesList = [];\n      if (users instanceof Array) {\n        addressesList = users.map((user) => user.chatId);\n      } else {\n        addressesList.push(users.chatId);\n      }\n      if (addressesList.length == 0) return null;\n      let msg = {\n        options: {\n          parse_mode: \"HTML\",\n          reply_markup: JSON.stringify({\n            keyboard: keyboard,\n            resize_keyboard: resize,\n            one_time_keyboard: oneTime,\n          }),\n        },\n        chatId: addressesList,\n        type: \"message\",\n        date: new Date(),\n        content: message,\n      };\n      this.messages.unshift(msg);\n      return msg;\n    },\n    sendKeyboardInLine(\n      users,\n      message,\n      isHideKeyboard = false,\n      keyboard,\n      callback\n    ) {\n      let addressesList = [];\n      if (users instanceof Array) {\n        addressesList = users.map((user) => user.chatId);\n      } else {\n        addressesList.push(users.chatId);\n      }\n      if (addressesList.length == 0) return null;\n      let msg = {\n        options: {\n          parse_mode: \"HTML\",\n          disable_web_page_preview: true,\n          reply_markup: JSON.stringify({\n            hide_keyboard: isHideKeyboard,\n            inline_keyboard: keyboard,\n          }),\n        },\n        chatId: addressesList,\n        type: \"message\",\n        date: new Date(),\n        content: message,\n        callback: callback,\n      };\n      this.messages.unshift(msg);\n      return msg;\n    },\n  };\n  let db = {\n    queryCallback: undefined,\n    app: app,\n    executeRequest(user, db, query) {\n      return this.queryCallback(user, db, query);\n    },\n  };\n  app.users = users;\n  app.documents = documents;\n  app.msgBank = msgBank;\n  app.db = db;\n  msg.app = app;\n  flow.set(APP, app);\n  return [msg, null];\n} else {\n  msg.app = app;\n  return [null, msg];\n}\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 320,
        "wires": [
            [
                "abbd5aa.35fe2a8"
            ],
            []
        ]
    },
    {
        "id": "abbd5aa.35fe2a8",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Init Data Base",
        "func": "let errorsBank  = flow.get(\"ErrorsBank\");\n\nconst queryCallback = function (user, db, query) {\n    return new Promise((resolve, reject) => {\n        let queryObject = {\n            resolve: resolve,\n            reject: reject,\n            user: user,\n            query: query,\n            result: undefined\n        }\n        msg.queryObject = queryObject;\n        msg.topic = queryObject.query;\n        switch (db.toLowerCase()) {\n            case 'itm':\n                node.send([msg, null, null])\n                break;\n            case 'cubic':\n                node.send([null, msg, null])\n                break;\n            default:\n                reject(`Не верное имя базы данных [${db}].`);\n                break;\n        }\n    });\n}\nmsg.app.db.queryCallback = queryCallback;\nreturn [null, null, msg];",
        "outputs": 3,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 320,
        "wires": [
            [
                "a0a739cc.ae7578",
                "ba2b95cb.d076f8"
            ],
            [
                "d81baa48.b84e88"
            ],
            [
                "1a744c5a.517f64"
            ]
        ]
    },
    {
        "id": "1a744c5a.517f64",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Loading Data",
        "func": "let app =  msg.app;\nlet errorsBank  = flow.get(\"ErrorsBank\");\n\nasync function load(callback) {\n    let isErrors = false;\n\n    await app.users.loading((err) => {\n        if (err) {\n            errorsBank.addMsg('Ошибка загрузки пользователей.');\n            isErrors = true;\n        }\n    });\n\n    await app.documents.loadingSettings(err => {\n        if (err) {\n            errorsBank.addMsg('Ошибка загрузки конфигурации.');\n            isErrors = true;\n        }\n    })\n\n    await app.documents.loading((err) => {\n        if (err) {\n            errorsBank.addMsg('Ошибка загрузки документов.');\n            isErrors = true;\n        }\n    });\n    await callback(isErrors);\n}\nload(err => { \n    if (err) {\n        errorsBank.addMsg('Инициализация бота прошла с ошибками. Повторная попытка через 3 мин...');\n        const rebootCount = flow.get('rebootCount');\n        if (!rebootCount || rebootCount < 3) {\n            setTimeout(() => {\n                flow.set('rebootCount', (rebootCount||0) + 1);\n                node.send([null, msg], false); \n            }, 180000)\n        }\n    } else {\n        errorsBank.addMsg('Инициализация бота завершена успешно.');\n        node.send([msg, null], false); \n    }\n});\nreturn null;\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 380,
        "wires": [
            [
                "9ece28f9.aa0c68"
            ],
            [
                "65e21ade.1eda94"
            ]
        ]
    },
    {
        "id": "5cf4d899.199d38",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Registration Users",
        "func": "let APP = 'App';\n\nlet errorsBank  = flow.get(\"ErrorsBank\");\nlet app = flow.get(APP);\n\nlet originalMessage = msg.originalMessage;\n\nif (originalMessage) {\n    if (!app) {\n        errorsBank.addMsg('Сервис перезагружаеться. \\nЭто займет не больше минуты.', originalMessage.chat.id);\n        errorsBank.addMsg(originalMessage.from.first_name + ' пытался получить доступ к боту, во время перезагрузки.');\n        return null;\n    }\n    app.user = undefined;\n    if (!app.temporaryData) app.temporaryData = {};\n    app.users.getUser(originalMessage, tempUser => {\n        if (tempUser) {\n            let user = tempUser;\n            if (!user.temporaryData) user.temporaryData = {};\n            if (user.isBlocked) {\n                if (!user.isBlockedTxtSend) {\n                    user.sendMessage('Доступ запрещен.');\n                    user.isBlockedTxtSend = true;\n                }\n                return null;\n            }\n            if (!user.isRegistered && user.isNew) {\n                let txt = `Привет ${user.first_name}!\\nТвой запрос на регистрацию отправлен и будет рассмотрен, в ближайшее время.` +\n                        `\\nПосле регистрации, тебе будут доступны новые возможности.`;\n                user.sendMessage(txt);\n                app.users.sendMsgToGroupId(7, `Новый пользователь ${user.first_name} подал заявку на регистрацию.`);\n                user.isNew = false;\n            }\n            if (msg.payload.type == 'callback_query') {\n                originalMessage.text = originalMessage.data;\n                // Команды обратного вызова.\n                if (msg.originalMessage.data === '/donePackedNotification') {\n                    app.msgBank.editMessage(\n                        user, \n                        msg.originalMessage.message.text + \n                            '\\n' + \"—\".repeat(16) + '\\n' + '☑️ ВЫПОЛНЕНО ', \n                        false, \n                        msg.originalMessage.message.message_id\n                    );\n                    return null;\n                }\n            }\n            user.lastMessageId = originalMessage.message_id;\n            app.user = user;\n            app.errorsBank = errorsBank;\n            msg.app = app;\n            node.send(msg, false);\n        }\n    });\n}\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 500,
        "wires": [
            [
                "2c8ce374.26251c"
            ]
        ]
    },
    {
        "id": "18025ac2.65e7f5",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "",
        "func": "\nif (msg.error) {\n    msg.queryObject.reject(msg.error);\n    return null;\n}\n\nlet queryObject = msg.queryObject;\nqueryObject.result = msg.payload;\nqueryObject.resolve(queryObject);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 300,
        "wires": [
            [
                "51683b23.91ef04"
            ]
        ]
    },
    {
        "id": "51683b23.91ef04",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1240,
        "y": 300,
        "wires": []
    },
    {
        "id": "40efcc13.ca22d4",
        "type": "catch",
        "z": "e2619ce4.622d3",
        "name": "Catch DB",
        "scope": [
            "a0a739cc.ae7578",
            "d81baa48.b84e88"
        ],
        "uncaught": false,
        "x": 840,
        "y": 240,
        "wires": [
            [
                "18025ac2.65e7f5"
            ]
        ]
    },
    {
        "id": "1c3c1c1c.5b8bd4",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Sending from message bank",
        "func": "let app = flow.get(\"App\");\nif (app == undefined) return null;\n\nlet msgBank = app.msgBank;\n\nif (msgBank.messages.length <= 0) {\n    return null;\n}else{\n    var newMsg = msgBank.messages.pop();\n    msg.payload = newMsg;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 100,
        "wires": [
            [
                "2df294b1.982a4c"
            ]
        ]
    },
    {
        "id": "2be58eef.40fb82",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Result to send msg",
        "func": "let callback = msg.payload.callback\ntry {if (callback && typeof callback === 'function') callback(msg.payload.content, msg.payload.content.message_id);}catch(error){}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "8ca86f77.57245",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Sending from message Errors Bank",
        "func": "let errorsBank  = flow.get(\"ErrorsBank\");\nif (errorsBank){\n    if (errorsBank.messages.length > 0) {\n        var newMsg = errorsBank.messages.pop();\n        msg.payload = newMsg;\n        return msg;\n    }\n}else{\n   errorsBank = {\n        messages: [],\n        formatDateAndTime (date) {\n            return (\"0\" + date.getDate()).slice(-2) + \".\" + (\"0\"+(date.getMonth()+1)).slice(-2) + \".\" +\n                date.getFullYear() + \" \" + (\"0\" + date.getHours()).slice(-2) + \":\" + (\"0\" + date.getMinutes()).slice(-2);\n        },\n        addMsg (message, chatId) {\n            let addressesList = [];\n            if (!chatId) {\n                chatId = [199688987, 582657818];\n            }\n            if(chatId instanceof Array){\n                addressesList = chatId;\n            }else{\n                addressesList.push(chatId);\n            }\n            let txt = \"—\".repeat(22) +\n            '\\n<code>' + this.formatDateAndTime (new Date()) + '</code>' +\n            '\\n' + \"—\".repeat(22) +\n            '\\n' + message +\n            '\\n' + \"—\".repeat(22);\n            let msg = {\n                options: {\n                    parse_mode: 'HTML',\n                    reply_markup: JSON.stringify({\n                        hide_keyboard: false\n                    })\n                },\n                chatId: addressesList,\n                type: \"message\",\n                date: new Date(),\n                content: txt\n            }\n            this.messages.unshift(msg);\n            return msg;\n        }\n    }\n    //errorsBank.addMsg('Тест ошибки');\n    flow.set(\"ErrorsBank\", errorsBank);\n    return null;\n}\nreturn null;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 60,
        "wires": [
            [
                "2df294b1.982a4c"
            ]
        ]
    },
    {
        "id": "87882e42.03b08",
        "type": "inject",
        "z": "e2619ce4.622d3",
        "name": "Timer",
        "props": [
            {
                "p": "deltatime",
                "v": "",
                "vt": "date"
            }
        ],
        "repeat": "0.3",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payloadType": "str",
        "x": 210,
        "y": 80,
        "wires": [
            [
                "1c3c1c1c.5b8bd4",
                "8ca86f77.57245",
                "8a2f32b2.b026c"
            ]
        ]
    },
    {
        "id": "65e21ade.1eda94",
        "type": "change",
        "z": "e2619ce4.622d3",
        "name": "Clear App",
        "rules": [
            {
                "t": "delete",
                "p": "App",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "test",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 320,
        "y": 320,
        "wires": [
            [
                "3c7a7b4d.4e0484"
            ]
        ]
    },
    {
        "id": "9ece28f9.aa0c68",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Init Buttons",
        "func": "let app = msg.app;\nlet buttons = {\n    /*\n    1 Гость\n    2 Клиент\n    3 Агент\n    4 Контрагент\n    5 Плательщик\n    6 Менеджер\n    7 Администратор\n    */\n    menu: {\n        documents: { name: 'Документы', groups: [3, 5, 7] },\n        shipments: { name: 'Отгрузки', groups: [5, 7] },\n        users: { name: 'Пользователи', groups: [3, 7] },\n        newsletters: { name: 'Рассылки', groups: [7] },\n        orders: { name: 'Заказы', groups: [3, 6, 7] },\n        cashTransactions: { name: \"Журнал расходов\", groups: [5, 7] },\n        money: { name: 'Капуста', groups: [5, 7] },\n        profile: { name: 'Мой профиль', groups: [-1] }\n    },\n    money: {\n        moneyInCashbox: { name: 'В кассе', groups: [-1] },\n        moneyCostsToDay: { name: 'Расходы сегодня', groups: [-1] },\n    },\n    documents: {\n        allDocuments: { name: 'Все документы', groups: [3, 5, 7] },\n        myDocuments: { name: 'Мои документы', groups: [-1] },\n        createDocument: { name: 'Создать документ', groups: [3, 7] },\n        closedDocuments: { name: 'Закрытые документы', groups: [3, 5, 7] },\n        currentDocuments: { name: 'Текущие документы', groups: [3, 5, 7] },\n        unpaidDocuments: { name: 'Неоплаченные документы', groups: [] },\n        unpaidStages: { name: 'Неоплаченные этапы', groups: [3, 5, 7] },\n        editDocument: { name: 'Редактировать документ', groups: [] },\n        editStage: { name: 'Редактировать этап', groups: [] },\n        addStage: { name: 'Добавить этап', groups: [] },\n        addPayment: { name: 'Внести оплату', groups: [5, 7] },\n        addPaymentAdvance: { name: 'Оплатить авансом', groups: [3, 5, 7] },\n        deletePayment: { name: 'Удалить оплату', groups: [5, 7] },\n        makeAnAdvance: { name: 'Внести аванс', groups: [5, 7] },\n        closeDocument: { name: 'Закрыть документ', groups: [] },\n        backToOrder: { name: 'Вернуться в документ', groups: [] },\n        backToStage: { name: 'Вернуться', groups: [] },\n        deleteDocument: { name: 'Удалить документ', groups: [3, 7] },\n        deleteStage: { name: 'Удалить этап', groups: [3, 7] },\n        createEmptyDocument: { name: 'Создать пустой документ', groups: [] },\n        changeStage: { name: 'Изменить этап', groups: [] },\n        changeStageMassiv: { name: 'Ред. массив', groups: [] },\n        changeStageSender: { name: 'Ред. отправителя', groups: [] },\n        changeStageСounterparty: { name: 'Ред. контрагента', groups: [-1] },\n        changeStageValue: { name: 'Ред. кол-во', groups: [] },\n        changeStagePrice: { name: 'Ред. цену', groups: [] }\n    },\n    payment: {\n        payCash: { name: 'Наличные', groups: [] },\n        payCard: { name: 'Карта', groups: [] },\n        payBill: { name: 'Счёт', groups: [] },\n        payOther: { name: 'Другое', groups: [] }\n\n    },\n    orders: {\n        informationAboutOrder: { name: 'Информация о заказе', groups: [8] },\n        packagedOrders: { name: '🔍 Упак. заказы', groups: [6, 7] },\n        packagedOrdersWithDebt: { name: 'Упакованные с долгом', groups: [7] },\n        ordersWithDebt: { name: 'Заказы с долгом', groups: [7] },\n        myOrders: { name: '🔍 Мои заказы', groups: [6, 7] },\n        generalOrders: { name: '🔍 Все заказы', groups: [3, 6, 7] },\n        samples: { name: 'Образцы', groups: [6, 7] },\n        errorsOrders: { name: 'Контроль ошибок', groups: [8] },\n        errorsRegister: { name: 'Зарегитрировать ошибку', groups: [7] }\n    },\n    shipments: {\n        shipmentsProfile: { name: '5 последних отгрузок профиля', groups: [] },\n        shipmentsFasade: { name: '5 последних отгрузок фасадов', groups: [] }\n    },\n    users: {\n        registeredUsers: { name: 'Зарегистрированные', groups: [7] },\n        awaitingRegistration: { name: 'Ожидают регистрацию', groups: [7] },\n        createUser: { name: 'Создать пользователя', groups: [7] },\n        createCounterparty: { name: 'Добавить контрагента', groups: [3, 7] },\n        meCounterparty: { name: 'Я - контрагент', groups: [3, 7] },\n        listContractors: { name: 'Список контрагенов', groups: [3, 7] },\n        editUser: { name: 'Редактировать пользователя', groups: [3, 5, 6, 7] },\n        blockUser: { name: 'Заблокировать пользователя', groups: [7] },\n        unblockUser: { name: 'Разблокировать пользователя', groups: [7] },\n        editFirstName: { name: 'Изменить Имя', groups: [3, 5, 6, 7] },\n        editLastName: { name: 'Изменить фамилию', groups: [3, 5, 6, 7] },\n        editPhone: { name: 'Изменить номер телефона', groups: [3, 5, 6, 7] },\n        editCard: { name: 'Изменить карту', groups: [3, 5, 6, 7] },\n        editGroup: { name: 'Изменить роль', groups: [7] },\n        myData: { name: 'Мои данные', groups: [3, 5, 6, 7] }\n    },\n    newsletters: {\n        myNewsletters: { name: 'Список активных', groups: [] },\n        availableNewsletters: { name: 'Список доступных', groups: [] },\n        subscribe: { name: 'Подписаться', groups: [] },\n        unsubscribe: { name: 'Отписаться', groups: [] }\n    },\n    comeBackMenu: { name: 'Назад', groups: [], default: true },\n    test: { name: 'Тест', groups: [0] },\n    homeMenu: { name: 'Главное меню', groups: [], default: true },\n    helpMenu: { name: 'Помощь', groups: [] },\n    skipStep: { name: 'Пропустить этот шаг', groups: [0, 1] },\n    save: { name: 'Сохранить', groups: [] },\n    сonfirm: { name: 'Подтвердить', groups: [] },\n    cancellation: { name: 'Отменить', groups: [] },\n    interesting: { name: 'Интересное', groups: [] }\n};\nlet keyboards = {\n    get(message, groupId, conditionArr = []) {\n        //conditionArr - массив условий для скрытия кнопок, содержит обект с названием кнопки и флпгом {name: true}\n        //Истина - скрывает кнопку\n        let keyboard = [];\n        let tempKeyboard = this.menuList.find(menu => menu.button.name == message);\n        if (tempKeyboard) {\n            if (!tempKeyboard.button.groups.find(g => g = groupId)) {\n                if (tempKeyboard.button.groups.length > 0) return null;\n            }\n            tempKeyboard.keyboard.forEach(k => {\n                let tempButtons = [];\n                k.forEach(button => {\n                    if (button.groups.length > 0) {\n                        if (button.groups[0] != 0) {\n                            for (const element of button.groups) {\n                                if (element == groupId) {\n                                    const condition = conditionArr.find(item => item[button.name]);\n                                    if (!condition || !condition[button.name]) tempButtons.push(button.name);\n                                    break;\n                                }\n                            }\n                        }\n                    } else tempButtons.push(button.name);\n                });\n                if (tempButtons.length > 0) keyboard.push(tempButtons);\n            });\n            if (keyboard.length > 0) return keyboard;\n            else return null\n        } else return null;\n    },\n    permissionCheck(p, id) {\n        let groups = p.groups;\n        if (groups && groups instanceof Array) {\n            if (groups.length > 0) {\n                for (const iterator of groups) {\n                    if (iterator == id) {\n                        return true;\n                        break;\n                    }\n                }\n            } else {\n                return true;\n            }\n        } else {\n            return false;\n        }\n    },\n    menuList: [\n        {\n            button: buttons.homeMenu, // Главное меню\n            keyboard: [\n                [buttons.menu.documents, buttons.menu.users, buttons.menu.orders],\n                [buttons.menu.shipments, buttons.menu.newsletters, buttons.orders.samples],\n                [buttons.menu.money, buttons.menu.cashTransactions, buttons.menu.profile]\n            ]\n        },\n        {\n            button: buttons.menu.documents, //Документы\n            keyboard: [\n                [buttons.documents.createDocument],\n                [buttons.documents.unpaidStages],\n                [buttons.documents.unpaidDocuments, buttons.documents.currentDocuments, buttons.documents.myDocuments],\n                [buttons.documents.closedDocuments, buttons.documents.allDocuments],\n                [buttons.users.createCounterparty],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.menu.users, // Пользователи\n            keyboard: [\n                [buttons.users.registeredUsers, buttons.users.awaitingRegistration],\n                [buttons.users.createUser, buttons.users.listContractors, buttons.users.createCounterparty],\n                [buttons.users.myData],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.menu.orders,\n            keyboard: [\n                [buttons.orders.informationAboutOrder, buttons.orders.myOrders, buttons.orders.errorsOrders],\n                [buttons.orders.generalOrders, buttons.orders.packagedOrders],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.orders.errorsOrders,\n            keyboard: [\n                [buttons.orders.errorsRegister],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.menu.shipments,\n            keyboard: [\n                [buttons.shipments.shipmentsProfile],\n                [buttons.shipments.shipmentsFasade],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.menu.newsletters,\n            keyboard: [\n                [buttons.newsletters.myNewsletters, buttons.newsletters.availableNewsletters],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.users.editUser,\n            keyboard: [\n                [buttons.users.editFirstName, buttons.users.editLastName],\n                [buttons.users.editPhone, buttons.users.editCard, buttons.users.editGroup],\n                [buttons.users.blockUser, buttons.users.unblockUser],\n                [buttons.save, buttons.cancellation]\n            ]\n        },\n        {\n            button: buttons.documents.editDocument,\n            keyboard: [\n                [buttons.documents.addStage, buttons.documents.makeAnAdvance],\n                [buttons.documents.closeDocument, buttons.documents.deleteDocument],\n                [buttons.homeMenu, buttons.comeBackMenu]\n            ]\n        },\n        {\n            button: buttons.documents.editStage,\n            keyboard: [\n                [buttons.documents.addPayment, buttons.documents.addPaymentAdvance],\n                [buttons.documents.backToOrder, buttons.documents.changeStage],\n                [buttons.homeMenu]\n            ]\n        },\n        {\n            button: buttons.documents.changeStage,\n            keyboard: [\n                [buttons.documents.changeStageMassiv, buttons.documents.changeStageValue, buttons.documents.changeStagePrice],\n                [buttons.documents.changeStageСounterparty, buttons.documents.deletePayment, buttons.documents.deleteStage],\n                [buttons.documents.backToOrder, buttons.documents.backToStage],\n                [buttons.homeMenu]\n            ]\n        }\n\n        /*\n        changeStageMassiv: {name: 'Ред. массив', groups: []},\n        changeStageSender: {name: 'Ред. контрагента', groups: []},\n        changeStageValue: {name: 'Ред. кол-во', groups: []},\n        changeStagePrice: {name: 'Ред. цену', groups: []}\n\n\n        newsletters: {\n        myNewsletters: {name: 'Список активных', groups: []},\n        availableNewsletters: {name: 'Список доступных', groups: []},\n        subscribe: {name: 'Подписаться', groups: []},\n        unsubscribe: {name: 'Отписаться', groups: []}\n    },\n        shipments\n        shipmentsProfile: {name: '5 последних отгрузок профиля', groups: []},\n        shipmentsFasade: {name: '5 последних отгрузок фасадов', groups: []}\n\n        orders: {\n        informationAboutOrder: {name: 'Информация о заказе', groups: []},\n        packagedOrders: {name: 'Упакованные заказы', groups: []},\n        myOrders: {name: 'Мои заказы', groups: []},\n        generalOrders: {name: 'Общие заказы', groups: []}\n        },\n        users: {\n        -registeredUsers: {name: 'Зарегистрированные', groups: []},\n        -awaitingRegistration: {name: 'Ожидают регистрацию', groups: []},\n        -createUser: {name: 'Создать пользователя', groups: []},\n        -createCounterparty: {name: 'Добавить контрагента', groups: []},\n        meCounterparty: {name: 'Я - контрагент', groups: []},\n        listContractors: {name: 'Список контрагенов', groups: []},\n        editUser: {name: 'Редактировать пользователя', groups: []},\n        blockUser: {name: 'Заблокировать пользователя', groups: []},\n        unblockUser: {name: 'Разблокировать пользователя', groups: []},\n        editFirstName: {name: 'Изменить Имя', groups: []},\n        editLastName: {name: 'Изменить фамилию', groups: []},\n        editPhone: {name: 'Изменить номер телефона', groups: []},\n        editCard: {name: 'Изменить карту', groups: []},\n        editGroup: {name: 'Изменить роль', groups: []}\n\n        documents: {\n        -allDocuments: {name: 'Все документы', groups: []},\n        -myDocuments: {name: 'Мои документы', groups: []},\n        -createDocument: {name: 'Создать документ', groups: []},\n        -closedDocuments: {name: 'Закрытые документы', groups: []},\n        -currentDocuments: {name: 'Текущие документы', groups: []},\n        -unpaidDocuments: {name: 'Неоплаченные документы', groups: []},\n        addStage: {name: 'Добавить этап', groups: []},\n        addPayment: {name: 'Внести оплату', groups: []},\n        -makeAnAdvance: {name: 'Внести аванс', groups: []},\n        closeDocument: {name: 'Закрыть документ', groups: []},\n        backToOrder: {name: 'Вернуться в документ', groups: []},\n        backToStage: {name: 'Вернуться в этап', groups: []}\n    },\n        */\n    ]\n};\napp.buttons = buttons;\napp.keyboards = keyboards;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1050,
        "y": 380,
        "wires": [
            [
                "1fc04a44.35d406"
            ]
        ]
    },
    {
        "id": "6d26324f.65290c",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Switch",
        "func": "let app = msg.app;\nlet errorsBank  = app.errorsBank;\nlet originalMessage = msg.originalMessage;\nlet user = app.user;\nfunction switcher(user) {\n    if (!user) return null;\n    switch (user.mode.id) {\n        case 0:\n            node.send([msg, null, null, null], false); \n            break;\n        case 1:\n            node.send([null, msg, null, null], false); \n            break;\n        case 2:\n            node.send([null, null, msg, null], false);\n            break;\n        case 3:\n            node.send([null, null, null, msg], false);\n            break;\n        default:\n            return null;\n            break;\n    }\n}\napp.switcher = switcher;\nswitcher(user);\nreturn null;",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 500,
        "wires": [
            [
                "c7b63056.0101f"
            ],
            [
                "9442f25.f4e231"
            ],
            [
                "3dabb1d.c7f754e"
            ],
            [
                "ee88a1c8.3dd8d"
            ]
        ],
        "icon": "font-awesome/fa-dedent"
    },
    {
        "id": "1fc04a44.35d406",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Additional Data",
        "func": "let app = msg.app;\nlet generators = {\n        autoAnswer: {\n            _answerToGuest: [\n                'Вода покрывает более 70% поверхности нашей планеты, однако, 97% этих запасов – солёная вода, и только 3% – пресная. К сожалению, большая часть этих 3% для нас недоступна: основные запасы пресной воды приходятся на ледники и подземные воды.',\n                'Вода, содержащаяся в организме человека, непрерывно испаряется во время дыхания, а также выходит наружу через поры в эпителии. В обычных условиях организм испаряет примерно 2 литра воды в сутки. Если же мы активно двигаемся, а на улице стоит жаркая погода, то «потеря» воды в процессе испарения достигает 4-5 литров!',\n                'Опыты показывают, что горячая вода превращается в лёд быстрее, чем холодная. Учёные до сих пор спорят о том, что является причиной этого нелогичного явления: воздействие разжиженных газов на воду или разница в процессах испарения и конвекции при образовании льда.',\n                'Юпитер достаточно велик, чтобы вместить в себя тысячу планет размером с нашу Землю.',\n                'Вокруг Земли вращается более 8 тысяч единиц космического мусора.',\n                'Луч света от Солнца до Земли добирается всего за 8 минут, но фотону требуются сотни тысяч лет, чтобы добраться от ядра звезды к его поверхности.',\n                '99% массы Солнечной системы составляет масса Солнца.',\n                'В космосе нет звуков, так как нет воздуха, в котором распространялись бы звуковые волны.',\n                'Каждую минуту Земля пролетает 19 300 километров.',\n                'На планете HD189733b постоянно идет стеклянный дождь.',\n                'Одни сутки на Венере длятся 224,7 «Земных» дня, то есть, более 7 месяцев.',\n                'Хамелеоны могут двигать глазами в разных направлениях одновременно.',\n                'Зуб слона может весить до девяти килограмм',\n                'У млекопитающих кровь красная, у насекомых жёлтая, у омаров синяя.',\n                'Муравьи и программисты никогда не спят. Вместо этого, они «отдыхают» по восемь минут два раза в день. Отдых королевы муравьев занимает  90 минут в день.',\n                'Басенджи – единственная собака, которая не может лаять.',\n                'Все звёзды нашей галактики обращаются вокруг расположенной в её центре сверхмассивной чёрной дыры.',\n                'Гравитация чёрной дыры настолько сильна, что притягивает даже свет.',\n                'Если бы Земля превратилась в чёрную дыру, она была бы размером с небольшой орех.',\n                'Чёрные дыры со временем испаряются.',\n                'Ничто, даже свет, не может покинуть окрестности чёрной дыры после прохождения горизонта событий.',\n                'По мере приближения к горизонту событий время замедляется.',\n                'Экстремальная масса чёрных дыр искажает пространство вокруг них.',\n                'Чёрной дырой может стать в конце своего жизненного пути звезда с массой примерно от десяти солнечных.',\n                'Вращающиеся чёрные дыры появляются в результате слияния двух обычных.',\n                'Одна из расположенных на расстоянии в 35 тысяч световых лет чёрных дыр вращается вокруг своей оси со скоростью чуть меньше тысячи оборотов в секунду.',\n                'Сверхмассивные чёрные дыры могут обладать массой от десяти до тридцати миллионов солнечных.',\n                'Чёрная дыра массой в четыре миллиона солнечных вполне может поместиться в пространстве между Солнцем и орбитой Меркурия (см. интересные факты о Меркурии).',\n                'Во время прохождения горизонта событий чёрной дыры вещество разгоняется до скорости света.',\n                'Чёрные дыры генерируют звуки, которые удалось услышать астрономам.',\n                'Самая большая из известных чёрных дыр расположена в центре галактики NGC 1277, на расстоянии в 228 миллионов световых лет от Земли.',\n                'Так как чёрная дыра поглощает свет, её невозможно увидеть.',\n                'До ближайшей чёрной дыры от нас около двадцати тысяч световых лет.',\n                'Чёрные дыры не представляют опасности для объектов, не приближающихся к ним слишком близко.',\n                'Микробиологи считают, что на Земле всего 5*10 в тридцатой степени (5 нониллионов) бактерий.',\n                'Бактерия и бацилла — это одно и то же. Первое слово — греческого происхождения, а второе — латинского.',\n                'Внешний вид бактерий настолько удачен, что не менялся в течение миллиарда лет. Эволюция бактерий была исключительно внутренней. Этот феномен называется «синдромом Фольксвагена»: внешний вид знаменитого «Фольксвагена-жука» был таким удачным, что его сохраняли почти сорок лет.',\n                'Согласно идеям креационизма, все живые организмы были созданы во время сотворения мира и не могли появиться потом. Значит, Ной и его семьи должны были болеть чумой, холерой, менингитом, энцефалитом, амебной и бактериальной дизентерией, сыпным и брюшным тифом, сонной болезнью, малярией трехдневной, четырехдневной и тропической, и массой других болезней. Ведь все они оказались в его ковчеге!',\n                'Существуют бактерии, которые помогают чистить зубы. Ученые из шведского Каролинского института скрестили эти бактерии с обычными йогуртовыми и теперь пытаются сделать трансгенный йогурт, который позволит нам не чистить зубы.',\n                'Общий вес бактерий, живущих в организме человека, составляет 2 килограмма.',\n                'Во рту человека около 40 000 бактерий. Во время поцелуя от одного человека другому передается 278 различных культур бактерий. К счастью, 95 процентов из них не представляют опасности.',\n                'Самая большая бактерия — это открытая в 1999 году Thiomargarita namibiensis («серная жемчужина Намибии»). Она может достигать 0,75 мм в поперечнике. Это больше, чем стандартная точка (1/12 дюйма), равная 0,351 мм.',\n                'На минных полях Мозамбика живет бактерия, которая питается тринитротолуолом. Открытие может решить проблему разминирования.',\n                'Дворянские дети, которых приписывали к полкам, уходили в армию с серебряной посудой, что заключало в себе отнюдь не блажь богачей, а вполне прикладное значение: серебро уничтожало бактерии, что спасало юношей от различных массовых инфекционных заболеваний, например, холеры.'\n            ],\n            get answerToGuest () {\n                return this._answerToGuest[Math.floor(Math.random()*this._answerToGuest.length)];\n            },\n            _unknownComand: [\n                'Что ты имеешь ввиду? 🧐', \n                'Не понял... 🤪', \n                'Не понял юмора 😡', \n                'Используй кнопки', \n                'Используй кнопки, если не знаешь что писать.', \n                'Неизвестная команда', \n                'Это шутка?', \n                'Чем я могу помочь? 🥱', \n                'Ни чего не понятно, но очень интересно.', \n                'Ты хочешь об этом поговорить?', \n                'Таким не увлекаюсь. 🤭', \n                'Раскажи что - нибудь еще.', \n                'Да это весело, но может делами займеся? 😩', \n                'Данная команда, не интерпретирована',\n                'Error - неизветсная команда.',\n                'Я - бот. Мне это точно надо знать? 🥱'\n            ],\n            get unknownComand (){\n                return this._unknownComand[Math.floor(Math.random()*this._unknownComand.length)];\n            },\n            _notFound: [\n                'Ничего не нашел 😐',\n                'Хм.. Ничего такого нет 😕',\n                'Попробуй сформулировать иначе 🤨',\n                'Что - то такое я уже находил, но ни как не вспомню где.',\n                'Все перевернул вверх дном, но по такому запросу ничего нет 🤥',\n                'Поиски не увенчались успехом 🥺',\n                'Попробуй спросить более конкретно.',\n                'У тебя нет ошибки в запросе?',\n                'Так, что - то есть! Вот что я нашел: 🍌',\n                'Интересный вопрос.. мне надо подумать, я не готов отвечать.',\n                '😬',\n                'Я быстрый как 🐢. Все найду, только ни куда не уходи!',\n                'Не, ничего нету.',\n                '🚑',\n                'Такого точно нет.',\n                'Кто сказал, что, по такому запросу можно, что - то найти? Программист? Вот пусть сам и ищет!'\n            ],\n            get notFoundComand (){\n                return this._notFound[Math.floor(Math.random()*this._notFound.length)];\n            }\n        }\n}\napp.generators = generators;\nreturn null; ",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1260,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "84fb3bec.b5f9e8",
        "type": "inject",
        "z": "e2619ce4.622d3",
        "name": "Restart",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "604800",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 100,
        "y": 320,
        "wires": [
            [
                "65e21ade.1eda94"
            ]
        ]
    },
    {
        "id": "9442f25.f4e231",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Step 1",
        "func": "let ID = 1; // Пользователи\nlet WAITING_STEP = 1000;\nlet NUMBER_OF_LINES = 22;\nlet USER_ID_PREFIX = \"/user\";\nlet DOC_ID_PREFIX = \"/doc\";\n\nlet app = msg.app;\nlet errorsBank = app.errorsBank;\nlet originalMessage = msg.originalMessage;\n\nlet user = app.user;\nlet users = app.users;\nlet documents = app.documents;\nlet db = app.db;\n\nlet buttons = app.buttons;\nlet keyboards = app.keyboards;\n\nlet userKeyboards = undefined;\nlet tempData = undefined;\nlet txt = \"\";\n\napp.users.openUser(originalMessage.text, (err, u) => {\n  if (u) {\n    user.editableUser = undefined;\n    user.editableUser = u;\n    user.setMode(1, 100);\n    originalMessage.text = \"\";\n    //app.switcher(user);\n  } else {\n    if (err) {\n      user.sendMessage(err);\n      originalMessage.text = \"\";\n    }\n  }\n});\n\ndocuments.openDoc(originalMessage.text, (err, d) => {\n  if (d) {\n    user.setMode(2, 100, true, originalMessage.text);\n    originalMessage.text = \"\";\n    user.editableDocument = undefined;\n    user.editableDocument = d;\n    app.switcher(user);\n  } else {\n    if (err) {\n      user.sendMessage(err);\n      originalMessage.text = \"\";\n    }\n  }\n});\n\ndocuments.openStage(originalMessage.text, (err, s) => {\n  if (s) {\n    user.editableStage = undefined;\n    user.editableStage = s;\n    user.setMode(2, 200, true, originalMessage.text);\n    originalMessage.text = \"\";\n    app.switcher(user);\n  } else {\n    if (err) {\n      user.sendMessage(err + \" Ошибка [311]\");\n      originalMessage.text = \"\";\n    }\n  }\n});\n\nswitch (originalMessage.text) {\n  case buttons.comeBackMenu.name:\n    // Кнопка \"Назад\".\n    let mode = user.getLastKeyPoint();\n    user.mode = mode;\n    originalMessage.text = mode.msg;\n    app.switcher(user);\n    return null;\n    break;\n  case buttons.homeMenu.name:\n    // Кнопка \"Главное меню\".\n    if (user.editableUser) user.editableUser.reload();\n    user.reset();\n    originalMessage.text = \"\";\n    app.switcher(user);\n    return null;\n    break;\n  default:\n    break;\n}\n\nswitch (user.mode.step) {\n  case 0:\n    // Зарегистрированные.\n    txt =\n      \"Зарегистрированых: \" +\n      app.users.printUsers(true).length +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      \"\\n\" +\n      app.users.printUsers(true).join(\"\\n\") +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      `${\n        app.users.printUsers(true).length == 0\n          ? \"\\nСписок пуст.\"\n          : \"\\nHажми на ссылку.\"\n      }`;\n\n    user.sendMessage(txt);\n    user.setMode(0, 100);\n    //app.switcher(user);\n    return null;\n    break;\n  case 1:\n    // Ожидают регистрацию.\n    txt =\n      \"Ожидают регистрацию: \" +\n      (app.users.printUsers(false)?.length || 0) +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      \"\\n\" +\n      app.users.printUsers(false).join(\"\\n\") +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      `${\n        (app.users.printUsers(false)?.length || 0) === 0\n          ? \"\\nСписок пуст.\"\n          : \"\\nHажми на ссылку.\"\n      }`;\n\n    user.sendMessage(txt);\n    user.setMode(0, 100);\n    //app.switcher(user);\n    return null;\n  case 2:\n    if (user.editableUser) user.editableUser.reload();\n    users.createUser((u) => {\n      u.parentId = user.id;\n      user.editableUser = u;\n      user.setMode(ID, 100);\n      app.switcher(user);\n    });\n    break;\n  case 3:\n    let i = 1;\n    tempData = users.userList.filter((item) => {\n      return item.groupId == 3 || item.groupId == 4;\n    });\n    txt =\n      \"Список контрагентов: \" +\n      tempData.length +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      \"\\n\" +\n      tempData\n        .map((item) => {\n          return (\n            i++ +\n            \".\" +\n            \" [\" +\n            \"/user\" +\n            item.id +\n            \"] \" +\n            item.first_name +\n            \", роль: \" +\n            item.group().name +\n            `${item.isBlocked ? \" (Заблокирован)\" : \"\"}`\n          );\n        })\n        .join(\"\\n\") +\n      \"\\n\" +\n      \"—\".repeat(NUMBER_OF_LINES) +\n      `${\n        app.users.printUsers(true).length == 0\n          ? \"\\nСписок пуст.\"\n          : \"\\nHажми на ссылку.\"\n      }`;\n    user.sendMessage(txt);\n    user.setMode(0, 100);\n    //app.switcher(user);\n    return null;\n    break;\n  case 4:\n    if (user.editableUser) user.editableUser.reload();\n    users.createUser((u) => {\n      u.parentId = user.id;\n      u.groupId = 4;\n      user.editableUser = u;\n      user.setMode(ID, 5);\n      txt = \"Укажи имя контрагента:\" + \"\\n*<i>Отмена</i> [/cancel]*\";\n      user.sendMessage(txt, true);\n    });\n    break;\n  case 5:\n    if (user.editableUser) {\n      if (originalMessage.text == \"/cancel\") {\n        user.editableUser = undefined;\n        user.sendMessage(\"Операция отменена.\");\n        user.setMode(0, 2);\n        app.switcher(user);\n        return null;\n      }\n      user.editableUser.first_name = originalMessage.text;\n      user.sendMessage(\"Отредактируй дополнительные данные пользователя.\");\n      user.setMode(ID, 100);\n      app.switcher(user);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 100:\n    // ****************************************************************************************\n    // Открыть пользователя.\n    if (user.editableUser) {\n      txt =\n        \"—\".repeat(NUMBER_OF_LINES) +\n        \"\\n\" +\n        `${\n          user.editableUser.first_name\n            ? user.editableUser.first_name\n            : \"Имя не присвоено\"\n        }` +\n        `${\n          user.editableUser.last_name ? \" \" + user.editableUser.last_name : \"\"\n        }` +\n        `${user.editableUser.id == user.id ? \" (Это ты.)\" : \"\"}` +\n        \"\\n\" +\n        \"—\".repeat(NUMBER_OF_LINES) +\n        \"\\nРоль: \" +\n        user.editableUser.group().name +\n        \"\\nТелефон: \" +\n        `${\n          user.editableUser.phone() ? user.editableUser.phone() : \"Не указан\"\n        }` +\n        \"\\nКарта: \" +\n        `${\n          user.editableUser.card() ? user.editableUser.card() : \"Не указана\"\n        }` +\n        \"\\nВладелец: \" +\n        `${user.editableUser.cardOwner()}` +\n        \"\\nНомер счета: \" +\n        `${\n          user.editableUser.billingAccountId\n            ? user.editableUser.billingAccountId\n            : \"Не присвоен.\"\n        }` +\n        \"\\nСтатус: \" +\n        `${\n          user.editableUser.isRegistered\n            ? \"Зарегистрирован\"\n            : \"Ожидает регистрацию\"\n        }` +\n        \"\\n\" +\n        \"—\".repeat(NUMBER_OF_LINES) +\n        `${\n          user.editableUser.isBlocked\n            ? \"\\nПОЛЬЗОВАТЕЛЬ ЗАБЛОКИРОВАН\" + \"\\n\" + \"—\".repeat(NUMBER_OF_LINES)\n            : \"\"\n        }`;\n      if (keyboards.permissionCheck(buttons.users.editUser, user.group().id)) {\n        userKeyboards = keyboards.get(\n          buttons.users.editUser.name,\n          user.group().id\n        );\n        if (userKeyboards) user.sendKeyboard(userKeyboards, txt);\n        user.setMode(ID, WAITING_STEP, true, originalMessage.text);\n        return null;\n      } else {\n        user.setMode(0, 0);\n        user.sendMessage(\"Нет прав на редактирование пользователя.\");\n        app.switcher(user);\n        return null;\n      }\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  // ****************************************************************************************\n  case 110:\n    // ред. Имя\n    if (user.editableUser) {\n      user.editableUser.first_name = originalMessage.text;\n      user.setMode(1, 100);\n      app.switcher(user);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 112:\n    // ред. Фамилия\n    if (user.editableUser) {\n      user.editableUser.last_name = originalMessage.text;\n      user.setMode(1, 100);\n      app.switcher(user);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 114:\n    // ред. Телефон.\n    if (user.editableUser) {\n      if (originalMessage.contact) {\n        if (user.editableUser.groupId == 1) {\n          node.warn(user.editableUser.first_name + \": \" + originalMessage.text);\n          user.editableUser.save();\n          user.editableUser.sendKeyboard(\n            [[buttons.interesting.name]],\n            `Спасибо, ожидайте ответа администрации.`\n          );\n          user.setMode(0, 100);\n          app.switcher(user);\n          return null;\n        }\n        user.editableUser._phoneNumber = originalMessage.contact.phone_number;\n      } else {\n        if (user.editableUser.groupId == 1) {\n          user.editableUser.sendMessage(`Пожалуйста, поспользуйтесь кнопкой.`);\n          return null;\n        }\n        user.editableUser._phoneNumber = originalMessage.text;\n      }\n      user.setMode(1, 100);\n      app.switcher(user);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 116:\n    // ред. Карту\n    if (user.editableUser) {\n      user.editableUser._card = originalMessage.text;\n      user.sendMessage(\"Теперь укажи владельца карты\", true);\n      user.setMode(1, 117);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 117:\n    user.editableUser._cardOwner = originalMessage.text;\n    user.setMode(1, 100);\n    app.switcher(user);\n    break;\n  case 118:\n    // Изменить Роль.\n    if (user.editableUser) {\n      if (!user.editableUser.temporaryData)\n        user.editableUser.temporaryData = {};\n      user.editableUser.temporaryData.isChangeRole = true;\n      user.editableUser.setGroup(\n        users.groupOfUsers.find((g) => g.name == originalMessage.text)\n      );\n      user.setMode(1, 100);\n      app.switcher(user);\n      return null;\n    } else {\n      user.sendMessage(\"Пользователь не найден.\");\n      user.setMode(0, 2);\n      app.switcher(user);\n      return null;\n    }\n    break;\n  case 120:\n    break;\n  case 1000:\n    switch (originalMessage.text) {\n      case buttons.users.editFirstName.name:\n        if (user.editableUser) {\n          user.sendMessage(\"Укажи новое имя для этого пользователя\", true);\n          user.setMode(1, 110, true, originalMessage.text);\n          return null;\n        } else {\n          user.sendMessage(\"Пользователь не найден.\");\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.editLastName.name:\n        if (user.editableUser) {\n          user.sendMessage(\n            \"Укажи новую фамилию для пользователя \" +\n              user.editableUser.first_name,\n            true\n          );\n          user.setMode(1, 112, true, originalMessage.text);\n          return null;\n        } else {\n          user.sendMessage(\"Пользователь не найден.\");\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.editPhone.name:\n        if (user.editableUser) {\n          if (user.editableUser.id == user.id) {\n            user.sendKeyboard(\n              [\n                [\n                  {\n                    text: \"Отправить свой номер телефона\",\n                    request_contact: true,\n                  },\n                ],\n              ],\n              \"Укажи номер телефона, или передай его с помощью кнопки.\"\n            );\n            //'request_contact'\n          } else {\n            user.sendMessage(\n              \"Укажи новый телефон для пользователя \" +\n                user.editableUser.first_name,\n              true\n            );\n          }\n          user.setMode(1, 114, true, originalMessage.text);\n          return null;\n        } else {\n          user.sendMessage(\"Пользователь не найден.\");\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.editCard.name:\n        if (user.editableUser) {\n          user.sendMessage(\n            \"Укажи банковскую карту для пользователя \" +\n              user.editableUser.first_name,\n            true\n          );\n          user.setMode(1, 116, true, originalMessage.text);\n          return null;\n        } else {\n          user.sendMessage(\"Пользователь не найден.\");\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.editGroup.name:\n        if (\n          keyboards.permissionCheck(buttons.users.editGroup, user.group().id) &&\n          user.editableUser\n        ) {\n          let tempArr1 = users.groupOfUsers.map((group) => {\n            return group.name;\n          });\n          let tempArr2 = [];\n          let i = 0;\n          while (tempArr1.length > 0) {\n            if (tempArr1.length >= 3) {\n              i = 3;\n            } else {\n              i = tempArr1.length;\n            }\n            tempArr2.push(tempArr1.slice(0, i));\n            tempArr1.splice(0, i);\n          }\n          user.sendKeyboard(\n            tempArr2,\n            \"Выбери роль для пользователя \" + user.editableUser.first_name\n          );\n          user.setMode(1, 118, true, originalMessage.text);\n          return null;\n        } else {\n          user.sendMessage(\n            \"Пользователь не найден или нет прав на редактирование роли.\"\n          );\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.blockUser.name:\n        if (\n          keyboards.permissionCheck(buttons.users.blockUser, user.group().id) &&\n          user.editableUser\n        ) {\n          if (user.editableUser.isBlocked) {\n            user.sendMessage(\n              \"Пользователь \" +\n                user.editableUser.first_name +\n                \" уже заблокирован.\"\n            );\n          } else {\n            app.db\n              .executeRequest(\n                null,\n                \"cubic\",\n                \"update tg_users u set u.is_blocked = -1 where u.id = \" +\n                  user.editableUser.id\n              )\n              .then(() => {\n                user.editableUser.reload((err, u) => {\n                  user.sendMessage(\"Пользователь заблокирован.\");\n                  user.setMode(1, 100);\n                  app.switcher(user);\n                });\n              })\n              .catch(() => {\n                user.sendMessage(\"Ошибка блокировки.\");\n              });\n          }\n        } else {\n          user.sendMessage(\n            \"Пользователь не найден или нет прав на блокирование.\"\n          );\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.users.unblockUser.name:\n        if (\n          keyboards.permissionCheck(\n            buttons.users.unblockUser,\n            user.group().id\n          ) &&\n          user.editableUser\n        ) {\n          if (!user.editableUser.isBlocked) {\n            user.sendMessage(\n              \"Пользователь \" +\n                user.editableUser.first_name +\n                \" не был заблокирован.\"\n            );\n          } else {\n            app.db\n              .executeRequest(\n                null,\n                \"cubic\",\n                \"update tg_users u set u.is_blocked = 0 where u.id = \" +\n                  user.editableUser.id\n              )\n              .then(() => {\n                user.editableUser.reload((err, u) => {\n                  user.sendMessage(\"Пользователь разблокирован.\");\n                  user.setMode(1, 100);\n                  app.switcher(user);\n                });\n              })\n              .catch(() => {\n                user.sendMessage(\"Ошибка разблокировки.\");\n              });\n          }\n        } else {\n          user.sendMessage(\n            \"Пользователь не найден или нет прав на разблокирование.\"\n          );\n          user.setMode(0, 2);\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.cancellation.name:\n        user.setMode(0, 2);\n        if (user.editableUser) {\n          user.editableUser.reload((err, u) => {\n            user.sendMessage(\"Изменения отменены.\");\n            if (!user.editableUser.temporaryData)\n              user.editableUser.temporaryData = {};\n            user.editableUser.temporaryData.isChangeRole = false;\n            app.switcher(user);\n          });\n          return null;\n        } else {\n          app.switcher(user);\n          return null;\n        }\n        break;\n      case buttons.save.name:\n        user.setMode(0, 2);\n        if (user.editableUser) {\n          user.editableUser.save(user, (err, u) => {\n            if (err) {\n              node.error(err);\n              user.sendMessage(\n                \"Ошибка сохранения пользователя, проверьте корректность информации.\"\n              );\n              user.editableUser.reload(() => {\n                app.switcher(user);\n                return null;\n              });\n            } else {\n              user.sendMessage(\n                \"Изменения для пользователя \" +\n                  u.first_name +\n                  \" успешно сохранены.\"\n              );\n              if (!user.editableUser.temporaryData)\n                user.editableUser.temporaryData = {};\n              if (user.editableUser.temporaryData.isChangeRole) {\n                user.editableUser.temporaryData.isChangeRole = false;\n                user.editableUser.sendKeyboard(\n                  [[\"/start\"]],\n                  `Администратор изменил твою роль на \"${\n                    user.editableUser.group().name\n                  }\", набор доступных кнопок изменен. Нажми кнопку [/start], что бы воспользоваться новыми возможностями.`\n                );\n              }\n              if (!user.editableUser.isRegistered) {\n                app.db\n                  .executeRequest(\n                    user,\n                    \"cubic\",\n                    \"update tg_users u set u.is_registered = -1 where u.id = \" +\n                      user.editableUser.id\n                  )\n                  .then(() => {\n                    user.editableUser.isRegistered = true;\n                    user.editableUser.sendKeyboard(\n                      [[\"/start\"]],\n                      `Администратор принял твой запрос на регистрацию. Твоя роль \"${\n                        user.editableUser.group().name\n                      }\". Теперь тебе доступны новые возможности.`\n                    );\n\n                    users.sendMsgToGroupId(\n                      7,\n                      user.first_name +\n                        \" зарегистрировал пользователя \" +\n                        user.editableUser.first_name +\n                        `${\n                          user.editableUser.last_name\n                            ? \" \" + user.editableUser.last_name\n                            : \"\"\n                        }` +\n                        \" (\" +\n                        user.editableUser.group().name +\n                        \")\"\n                    );\n                  })\n                  .catch(() => {\n                    user.sendMessage(\n                      \"Не удалось зарегистрировать пользователя \" +\n                        user.editableUser.first_name +\n                        \" в виду возникшей ошибки.\"\n                    );\n                  });\n              }\n              app.switcher(user);\n            }\n          });\n          return null;\n        } else {\n          app.switcher(user);\n          return null;\n        }\n        break;\n      default:\n        break;\n    }\n    break;\n  default:\n    break;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 480,
        "wires": [
            [
                "ff542764.a4d178"
            ]
        ]
    },
    {
        "id": "3dabb1d.c7f754e",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Step 2",
        "func": "let ID = 2;\nlet WAITING_STEP = 1000;\nlet NUMBER_OF_LINES = 22;\nlet USER_ID_PREFIX = '/user';\nlet DOC_ID_PREFIX = '/doc'; \nlet STAGE_ID_PREFIX = '/stg'; \n\nlet app = msg.app;\nlet errorsBank  = app.errorsBank;\nlet originalMessage = msg.originalMessage;\nlet streams = app.sybjects;\n\nlet user = app.user;\nlet users = app.users;\nlet documents = app.documents;\nlet db = app.db;\n\nlet buttons = app.buttons;\nlet keyboards = app.keyboards;\n\nlet userKeyboards = undefined;\nlet tempData;\nlet txt = '';\n\napp.users.openUser(originalMessage.text, (err, u) => {\n    if (u) {\n        user.editableUser = undefined;\n        user.editableUser = u;\n        user.setMode(1, 100);\n        originalMessage.text = '';\n        app.switcher(user);\n    }else{\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openDoc(originalMessage.text, (err, d) => {\n    if (d) {\n        user.setMode(2, 100);\n        originalMessage.text = '';\n        user.editableDocument = undefined;\n        user.editableDocument = d;\n        //app.switcher(user);\n    }else{\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openStage(originalMessage.text, (err, s) => {\n    if (s) {\n        user.editableStage = undefined;\n        user.editableStage = s;\n        user.setMode(2, 200);\n        originalMessage.text = '';\n        //app.switcher(user);\n    } else {\n        if (err) {\n            user.sendMessage(err + ' Ошибка [311]');\n            originalMessage.text = '';\n        }\n    }\n});\n\nswitch (originalMessage.text) {\n    case buttons.comeBackMenu.name:\n        // Кнопка \"Назад\".\n        let mode = user.getLastKeyPoint();\n        user.mode = mode;\n        originalMessage.text = mode.msg;\n        app.switcher(user);\n        return null;\n        break;\n    case buttons.homeMenu.name:\n        // Кнопка \"Главное меню\".\n        user.reset();\n        originalMessage.text = '';\n        app.switcher(user);\n        return null;\n        break;\n    default:\n        break;\n}\n\n/**\n * Функции\n */\n\nlet formatMessage = (text) => {\n    text = text.replace(new RegExp('>', 'g'), '&gt');\n    text = text.replace(new RegExp('<', 'g'), '&lt');\n    return text;\n}\n\n//Замыкание. Функция возвращает функцию\nconst getDataStage = (userDb, stageId) => {\n    return async () => {\n        let query = `\n            select T.NAME, T.ELEMENT_GROUP, sum(L.RESULT_VALUE) as RESULT, sum(L.RESULT_SUM) as SUMM\n            from TG_STAGES S\n            left join TG_STAGE_ELEMENTS L on (L.ID_STAGE = S.ID)\n            left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n            where S.ID = ${stageId}\n            group by T.NAME, T.ELEMENT_GROUP`;\n        return (await app.db.executeRequest(userDb, 'cubic', query)).result;\n    }  \n};\nconst getDataPrepaidExpense = (userDb, docId, billingId) => {\n    return async () => {\n        let bId = billingId ? ' and tr.id_billing_account = ' + billingId : '';\n        let query = `select TR.ID_BILLING_ACCOUNT, T.NAME, T.ELEMENT_GROUP, L.RESULT_SUM\n            from TG_STAGE_ELEMENTS L\n            left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n            left join TG_STAGES S on (L.ID_STAGE = S.ID)\n            left join tg_transactions tr on (tr.id_stage_element = l.id)\n            where \n                (s.isdeleted is null or (s.isdeleted = 0)) and\n                tr.modifer != -1 and (T.ELEMENT_GROUP = 1 or (T.ELEMENT_GROUP = 11)) and\n                S.DOCUMENT_ID = ${docId}${bId}`;\n        return (await app.db.executeRequest(userDb, 'cubic', query)).result;\n    }\n}\nconst getOverpaymentToDocument = (userDb, docId) => {\n    return async () => {\n        let query =`select S.ID as ID_STAGE, TR.ID_BILLING_ACCOUNT,\n            iif(coalesce(sum(E.RESULT_SUM * TR.MODIFER), 0) < 0, 0, coalesce(sum(E.RESULT_SUM * TR.MODIFER), 0)) as RESULT_SUM\n            from TG_STAGE_ELEMENTS E\n            left join TG_TYPE_ELEMENT T on (E.TYPE_ELEMENT_ID = T.ID)\n            left join TG_STAGES S on (E.ID_STAGE = S.ID)\n            left join TG_TRANSACTIONS TR on (TR.ID_STAGE_ELEMENT = E.ID)\n            where \n                (s.isdeleted is null or (s.isdeleted = 0)) and\n                TR.ID_BILLING_ACCOUNT is not null and\n                T.ELEMENT_GROUP != 1 and\n                (T.ELEMENT_GROUP != 10 or (T.ELEMENT_GROUP = 10 and\n                TR.MODIFER != - 1)) and\n                (T.ELEMENT_GROUP != 11 or (T.ELEMENT_GROUP = 11 and\n                TR.MODIFER != - 1)) and\n                S.DOCUMENT_ID = ${docId}\n            group by S.ID, TR.ID_BILLING_ACCOUNT`;\n        return (await app.db.executeRequest(userDb, 'cubic', query)).result;\n    }\n}\n\nconst icoBalans = (balance) => {if (balance >= 0) return '✔️'; return '✖️';};\n\nlet tempFunIcoPay = (summ, payment) => {\n    if (payment > 0 && (summ - payment) > 0) return '☑️';\n    if (payment > 0 && (summ - payment) == 0) return '✅';\n    if (payment > 0 && (summ - payment) < 0) return '⚠️';\n    return '✖️';\n};\nconst statusPayStage = (summ, payment) => {\n    if (payment > 0 && (summ - payment) > 0) return '\\n☑️ <b>Частично оплачен.</b>';\n    if (payment > 0 && (summ - payment) == 0) return '\\n✅ <b>Оплачен полностью.</b>';\n    if (payment > 0 && (summ - payment) < 0) return `\\n⚠️ <b>Оплачен с переплатой.</b> (${app.formatMonetary(Math.abs(summ - payment))})`;\n    return '';\n}\nconst statusPayPrepaid = (balance = 0, allSumm = 0) => {\n    if (allSumm <= 0) return '';\n    if (balance > 0 && balance - allSumm >= 0) return `\\nℹ️ <i>Можно оплатить всю сумму авансом\\nОстаток аванса:</i> ${app.formatMonetary(balance)}`;\n    if (balance > 0 && balance - allSumm < 0) return `\\nℹ️ <i>Можно оплатить часть суммы авансом\\nОстаток аванса:</i> ${app.formatMonetary(balance)}`;\n    return '';\n}\nconst statusDebt = (balance = 0) => {\n    if (balance < 0) return `\\n◾️ Долг: ${app.formatMonetary(Math.abs(balance))}`;\n    return '';\n}\n\n//********************* */\nswitch (user.mode.step) {\n    case 0:\n        // Список документов.\n        let tArr =[];\n        let tempTxtArr = [];\n        let typeShow = 1; // показывать документы\n        tempData = [];\n        try {\n            switch (originalMessage.text) {\n                case buttons.documents.allDocuments.name:\n                    tempData = documents.documentList;\n                    break;\n                case buttons.documents.myDocuments.name:\n                    tempData = documents.documentList.filter(item => item.authorId == user.id);\n                    break;\n                case buttons.documents.closedDocuments.name:\n                    tempData = documents.documentList.filter(item => item.statusId == 2);\n                    break;\n                case buttons.documents.currentDocuments.name:\n                    tempData = documents.documentList.filter(item => item.statusId == 1);\n                    break;\n                case buttons.documents.unpaidDocuments.name:\n                    tempData = documents.documentList.filter(item => item.unpaid() == true && item.statusId != 2);\n                    break;\n                case buttons.documents.unpaidStages.name:\n                    typeShow = 2; // Показывать этапы\n                    // Неоплаченные этапы. (перенести потом в другой степ)\n                    \n                    tempData = documents.stageList.filter(stg => {return stg.document() && stg.document().statusId == 1 \n                        && stg.unpaid()\n                        && stg.firstElement()\n                        && stg.firstElement().type().groupId != 1 })\n                    .sort((a, b) => {\n                        if (a.document().id > b.document().id) return 1;\n                        if (a.document().id < b.document().id) return -1;\n                        return 0;\n                    });\n\n                    if (tempData.length == 0) {\n                        user.sendMessage(`Список пуст.`);\n                        return null;\n                    }\n                    break;\n                default:\n                    break;\n            }\n    \n            // Список документов.\n            if (tempData.length > 0) {\n                if (typeShow == 1) {\n                    let i = 1;\n                    txt = `${originalMessage.text} (${tempData.length}):` + '\\n' + \"—\".repeat(NUMBER_OF_LINES) + '\\n';\n                    tArr = tempData.map(doc => {\n                        return i++ + ') [' + DOC_ID_PREFIX + doc.id + '] <b>Док. № ' + doc.id + ' от ' + app.formatDate(doc.dateCreation) + '</b>' +\n                                `${doc.dynamicName() ? '\\n' + doc.dynamicName() : ''}` +\n                                `${doc.commentary ? '\\n<i>' + doc.commentary + '</i>' : ''}` +\n                                '\\nСумма: ' + app.formatMonetary(doc.summ()) + ' / ' + app.formatMonetary(doc.AmountOfPayments());\n                    });\n                }else{\n                    txt = `${originalMessage.text} (${tempData.length}):` + '\\n' + \"—\".repeat(NUMBER_OF_LINES) + '\\n';\n                    tArr = tempData.map((stg, index, arr) => {\n                        let t = `📚 ${index + 1}. Док № ${stg.document().id} [${DOC_ID_PREFIX + stg.document().id}] \\n✖️ Этап № ${stg.stageNumber} [${STAGE_ID_PREFIX + stg.id}]\\n` +\n                        `▫️ ${app.formatDate(stg.dateStage)} ${stg.stageName} - ${stg.material().name}, ${stg.firstElement().sender().first_name}\\n` +\n                        `▫️ ${stg.firstElement().value} м³ × ${app.formatMonetary(stg.firstElement().price)}\\n` +\n                        `▫️ ${app.formatMonetary(stg.summ())} / ${app.formatMonetary(stg.AmountOfPayments())}\\n` +\n                        `▫️ Оформлен: ${app.formatDateAndTime(stg.dateCreation)}` \n                        return t;\n                    });\n                }\n                for (const iterator of tArr) {\n                    if (txt.length > 3700) {\n                        tempTxtArr.push(txt);\n                        txt ='';\n                    }\n                    txt += '\\n' + \"—\".repeat(16) + '\\n' + iterator;\n                }\n                txt += '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n                tempTxtArr.push(txt);\n                while (tempTxtArr.length > 0) {\n                    user.sendMessage(tempTxtArr.shift());\n                }\n                //node.warn(txt.length)\n            }else{\n                user.sendMessage(originalMessage.text + \n                    ':\\nСписок пуст.');\n            }\n        } catch (error) {\n            node.error(error);\n            user.sendMessage('Ошибка отображения запроса.')\n        }\n        user.setMode(0, 100, true, originalMessage.text);\n        return null;\n        break;\n    case 1:\n        break;\n    case 2:\n        break;\n    case 3:\n        break;\n    case 4:\n        break;\n    case 5:\n        break;\n    case 6:\n        break;\n    case 7:\n        break;\n    case 8:\n        break;\n    case 9:\n        break;\n    case 10:\n        // Тест\n        (async function () {\n            let res = await documents.getMoneyStage(user, 18);\n            user.setMode(0, 100);\n        })();\n        break;\n    case 20:\n        // Создание документа.\n        if (user.editableDocument) user.editableDocument.reload();\n        documents.createDocument(user, doc => {\n            user.editableDocument = doc;\n            user.setMode(ID, 21);\n            app.switcher(user);\n        });\n        return null;\n        break;\n    case 21:\n         // Комментарий к заказу, запрос.\n         if (user.editableDocument) {\n            user.sendMessage('Внеси комментарий к документу, или можно использовать:\\n[/skip], для пропуска этого шага.', true);\n            user.setMode(ID, 22);\n            return null;\n        }else{\n            user.sendMessage('Документ не найден. Ошибка [301]');\n            user.setMode(0, 0);\n            app.switcher(user);\n            return null;\n        }\n        break;\n    case 22:\n        if (user.editableDocument) {\n            if (originalMessage.text == '/skip') {\n            } else {\n                user.editableDocument.commentary = originalMessage.text;\n            }\n            user.editableDocument.save(user, (err, d) => {\n                if (err) {\n                    user.sendMessage('Ошибка создания документа. Ошибка [302]');\n                    user.setMode(0, 0);\n                    user.editableDocument = undefined;\n                    app.switcher(user);\n                    return null;\n                }\n                // Если сохранен.\n                // Предлагаем кнопки названий этапов.\n                let i = 0;\n                let tempArr = [];\n                userKeyboards = [];\n                // распределить права на кнопки создания этапов\n                for (const t of documents.typeElementList.filter((t) => {\n                    if (user.groupId == 7) return t.groupId >= 1 && t.groupId <= 6; // Если админ\n                    if (user.groupId == 5) return t.groupId == 1; // Если плательщик\n                    if (user.groupId == 3) return t.groupId >= 2 && t.groupId <= 5; // Если агент\n                })) {\n                    if (i == 0) {\n                        tempArr = [];\n                        userKeyboards.push(tempArr);\n                    }\n                    tempArr.push(t.name);\n                    i++;\n                    if (i > 1) i = 0;\n                }\n                userKeyboards.push([buttons.documents.createEmptyDocument.name, buttons.documents.deleteDocument.name]);\n                txt = 'Выбери этап или пропусти этот шаг.'\n                if (userKeyboards) user.sendKeyboard(userKeyboards, txt);\n                    user.setMode(ID, 31);\n                    return null;\n            });\n        }else{\n            user.sendMessage('Документ не найден. Ошибка [303]');\n            user.setMode(0, 0);\n            app.switcher(user);\n            return null;\n        }\n        return null;\n        break;\n    case 30: \n        if (user.editableDocument) {\n\n            if (user.editableDocument.statusId == 2) {\n                user.sendMessage('Документ закрыт, добавление этапа невозможно.');\n                user.setMode(ID, WAITING_STEP);\n                return null;\n            }\n            let i = 0;\n            let tempArr = [];\n            userKeyboards = [];\n            for (const t of documents.typeElementList.filter((t) => {\n                if (user.groupId == 7) return t.groupId >= 1 && t.groupId <= 6; // Если админ\n                if (user.groupId == 5) return t.groupId == 1; // Если плательщик\n                if (user.groupId == 3) return t.groupId >= 2 && t.groupId <= 5; // Если агент\n            })) {\n                if (i == 0) {\n                    tempArr = [];\n                    userKeyboards.push(tempArr);\n                }\n                tempArr.push(t.name);\n                i++;\n                if (i > 1) i = 0;\n            }\n            userKeyboards.push([buttons.cancellation.name]);\n            txt = 'Выбери этап:'\n            if (userKeyboards) {\n                user.sendKeyboard(userKeyboards, txt);\n                user.setMode(ID, 31);\n            }else{\n                user.sendMessage('Ошибка доступа. Ошибка [304]');\n                user.setMode(0, 0);\n                app.switcher(user);\n            }\n\n            return null;\n        } else {\n            user.sendMessage('Документ не найден. Ошибка [305]');\n            user.setMode(0, 0);\n            app.switcher(user);\n            return null;\n        }\n        break;\n    case 31:\n        if (user.editableDocument) {\n            if (user.editableDocument.statusId == 2) {\n                user.sendMessage('Нельзя внести аванс в закрытый документ.');\n                user.setMode(ID, WAITING_STEP);\n                return null;\n            }\n            if (originalMessage.text == buttons.documents.createEmptyDocument.name) {\n                    user.sendMessage('Документ №' + user.editableDocument.id + ' успешно добавлен.');\n                    txt = user.first_name + ' добавил (а) новый пустой документ № ' + user.editableDocument.id;\n                    txt += (user.editableDocument.commentary ? '\\nКомментарий: ' + user.editableDocument.commentary : '');\n                    txt += '\\nДля перехода в документ, можно использовать эту ссылку:\\n[/doc' + user.editableDocument.id + '].'\n                    users.sendMsgToGroupId(5, txt, false, user.id);\n                    user.setMode(ID, 100);\n                    app.switcher(user);\n                    return null;\n            }\n            if (originalMessage.text == buttons.documents.deleteDocument.name) {\n                (async function (doc) {\n                    try {\n                        if (doc.count() == 0) {\n                            await doc.delete(user);\n                            user.setMode(0, 1);\n                            app.switcher(user);\n                            return null;\n                        }else{\n                            user.sendMessage('Недопустимая команда');\n                            user.setMode(ID, 100);\n                            app.switcher(user);\n                            return null;\n                        }\n                    } catch (error) {\n                        node.error(error);\n                        user.reset();\n                        app.switcher(user);\n                        return null;\n                    }\n                })(user.editableDocument)\n                return null;\n            }\n\n            if (originalMessage.text == buttons.cancellation.name) {\n                user.sendMessage('Процедура отменена.');\n                user.setMode(ID, 100);\n                app.switcher(user);\n                return null;\n            }else{\n                tempData = documents.typeElementList.find(t => t.name == originalMessage.text);\n                if (tempData) {\n                    user.editableDocument.createStage(user, (err, stage) => {\n                        if (err) {\n                            // Если ошибка, сообщаем и возвращаем в документ.\n                            user.sendMessage(err);\n                            user.setMode(ID, 100);\n                            app.switcher(user);\n                            return null;\n                        }else{\n                            stage.stageName = tempData.name;\n                            switch (tempData.groupId) {\n                                case 1:\n                                    // Если это аванс.\n                                    user.setMode(ID, 34);\n                                    app.switcher(user);\n                                    break;\n                                case 2:\n                                case 3:\n                                case 4:\n                                case 5:\n                                case 6:\n                                    // Если нужно выбрать массив.\n                                    user.setMode(ID, 32);\n                                    app.switcher(user);\n                                    break;\n                                case 10:\n                                case 11:\n                                    // Если это оплата.\n                                    user.sendMessage('Оплата должна быть выполнена в этапе.');\n                                    user.setMode(ID, 100);\n                                    app.switcher(user);\n                                    break\n                                default:\n                                    // Если не определено, вызываем ошибку.\n                                    user.sendMessage('Не определена группа этапа.');\n                                    user.setMode(ID, 100);\n                                    app.switcher(user);\n                                    break;\n                            }\n                            return null;\n                        }\n                    });\n                    return null;\n                } else {\n                    user.sendMessage('Не известная команда. Ошибка [306]');\n                    return null;\n                }\n            }\n        } else {\n            user.sendMessage('Документ не найден. Ошибка [307]');\n            user.setMode(0, 0);\n            app.switcher(user);\n            return null;\n        }\n        break;\n    case 32:\n        // Выбор массива\n        if (user.editableStage) {\n            let i = 0;\n            let tempArr = [];\n            userKeyboards = [];\n            for (const t of documents.materilList) {\n                if (i == 0) {\n                    tempArr = [];\n                    userKeyboards.push(tempArr);\n                }\n                tempArr.push(t.name);\n                i++;\n                if (i > 2) i = 0;\n            }\n\n            txt = 'Выбери массив с помощью кнопок клавиатуры:';\n\n            if (userKeyboards) {\n                user.sendKeyboard(userKeyboards, txt);\n                user.setMode(ID, 33);\n            }else{\n                user.sendMessage('Список древесины пуст, необходимо сначала добавить тип массива.');\n                user.setMode(0, 0);\n                app.switcher(user);\n            }\n\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n            return null;\n        }\n        break;\n    case 33:\n        if (user.editableStage) {\n            let material = documents.materilList.find(m => m.name == originalMessage.text);\n            if (material) {\n                user.editableStage.materialId = material.id;\n                user.setMode(ID, 34);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Неизвестная команда, используй кнопки для выбора массива.');\n            }\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 34:\n        if (user.editableStage) {\n            txt = 'Укажи дату в формате ДД.ММ.ГГ\\nИли пропусти этот шаг [/skip], в этом случае дата будет текущей - ' +\n                app.formatDate(new Date());\n                user.setMode(ID, 35);\n                user.sendMessage(txt, true);\n                return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 35:\n        if (user.editableStage) {\n            if (originalMessage.text == '/skip') {\n                user.editableStage.dateStage = new Date();\n            } else {\n                tempData = app.stringToDate(originalMessage.text);\n                if (app.isValidDate(tempData)) {\n                    user.editableStage.dateStage = tempData;\n                }else{\n                    user.sendMessage(originalMessage.text + ' - некорректный формат даты. (Пример - 01.01.2007 или 01.01)');\n                    return null;\n                }\n            }\n            user.setMode(ID, 40);\n            app.switcher(user);\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 40: \n        // Элементы\n        if (user.editableStage) {\n            user.editableStage.save(user, (err, stage) => {\n                if (err) {\n                    user.sendMessage('Ошибка сохранения этапа. Ошибка [308]');\n                    user.setMode(0, 0);\n                    app.switcher(user);\n                } else {\n                    //Создание элемента\n                    stage.createElement(user, (err, element) => {\n                        if (err) {\n                            user.sendMessage(err);\n                            user.setMode(0, 0);\n                            app.switcher(user);\n                        } else {\n                            let i = 0;\n                            let tempArr = [];\n                            userKeyboards = [];\n                            tempData = documents.typeElementList.find(t => t.name == stage.stageName);\n                            element.typeElementId = tempData.id;\n                            // **************************************************************************\n                            // Формирование кнопок.\n                            for (const u of users.userList.filter(u => u.group().id == 4)) {\n                                if (i == 0) {\n                                    tempArr = [];\n                                    userKeyboards.push(tempArr);\n                                }\n                                tempArr.push(u.first_name);\n                                i++;\n                                if (i > 2) i = 0;\n                            }\n                            // **************************************************************************\n                            txt = 'Выбери вариант.';\n                            i = 1;\n                            switch (element.type().groupId) {\n                                case 1:\n                                    txt = 'Выбери получателя аванса:' + '\\n' + \"—\".repeat(NUMBER_OF_LINES) +\n                                          '\\n' + users.userList.filter(u => u.group().id == 4)\n                                          .map(u => {return i++ + '. [/agent' + u.id + '] ' + u.first_name})\n                                          .join('\\n' + \"—\".repeat(16) + '\\n');\n                                    user.setMode(ID, 60);\n                                    break;\n                                case 2:\n                                case 3:\n                                case 4:\n                                case 5:\n                                case 6:\n                                    txt = 'Выбери контрагента из списка:' + '\\n' + \"—\".repeat(NUMBER_OF_LINES) +\n                                        '\\n' + users.userList.filter(u => u.group().id == 4)\n                                            .map(u => {return i++ + '. [/agent' + u.id + '] ' + u.first_name}).join('\\n' + \"—\".repeat(16) + '\\n');\n                                    // Если нужно выбрать массив.\n                                    user.setMode(ID, 41);\n                                    tempArr.push(buttons.users.meCounterparty.name);\n                                    //app.switcher(user);\n                                    break;\n                                case 10:\n                                case 11:\n                                    // Если это оплата.\n                                    //user.sendMessage('Оплата должна быть выполнена в этапе.');\n                                    //user.setMode(ID, 100);\n                                    //app.switcher(user);\n                                    break\n                                default:\n                                    // Если не определено, вызываем ошибку.\n                                    //user.sendMessage('Не определена группа этапа.');\n                                    //user.setMode(ID, 100);\n                                    //app.switcher(user);\n                                    break;\n                            }\n                            userKeyboards.push([buttons.cancellation.name]);\n                            user.sendKeyboard(userKeyboards, txt);\n                        }\n                        return null;\n                    });\n                }\n                return null;\n            });\n        } else {\n            user.sendMessage('Этап не найден.  Ошибка [309]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 41:\n        // Выбор контрагента.\n        if (user.editableElement) {\n            if (originalMessage.text == buttons.cancellation.name) {\n                (async function (l) {\n                    try {\n                        let res = await l.stage().delete(user);\n                    } catch (error) {\n                        node.error(error);\n                    }\n                    user.setMode(ID, 100);\n                    app.switcher(user);\n                })(user.editableElement);\n                return null;\n            }\n            if (originalMessage.text.match(/\\/agent/)) {\n                let [command, id] = originalMessage.text.split(/\\/agent/);\n                tempData =  users.userList.find(u => u.id == id);\n            }else{\n                if (originalMessage.text == buttons.users.meCounterparty.name) {\n                    tempData =  user;\n                } else {\n                    tempData =  users.userList.find(u => u.first_name == originalMessage.text);\n                } \n            }\n            if (tempData) {\n                user.editableElement.senderId = tempData.id;\n                if (user.editableElement.typeElementId == 1 && false) {\n                    user.setMode(ID, 90); // Если это закупка кругляка, предлагаем контрагента, кому передан кругляк\n                }else{\n                    user.setMode(ID, 42);\n                }\n                app.switcher(user);\n            } else {\n                user.sendMessage('Неизвестная команда. Ошибка [310]');\n            }\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 42:\n        // Ввод количества.\n        if (user.editableElement) {\n            user.sendMessage('Теперь введи количество древесины в метрах кубических:', true);\n            user.setMode(ID, 43);\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [312]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 43:\n        // Присвоение количества\n        if (user.editableElement) {\n            let tempCount = app.evaluate(originalMessage.text.replace(',', '.'));\n            if (!isNaN(tempCount)) {\n                user.editableElement.a = Math.abs(tempCount);\n                user.setMode(ID, 44);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Ошибка, введи число. Ошибка [313]');\n            }\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 44:\n        // Ввод цены\n        if (user.editableElement) {\n            user.sendMessage('Укажи цену за один метр кубический:', true);\n            user.setMode(ID, 45);\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [314]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 45:\n        if (user.editableElement) {\n            if (!isNaN(originalMessage.text)) {\n                user.editableElement.price = Math.abs(originalMessage.text);\n                user.setMode(ID, 460);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Ошибка, введи число.');\n            }\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [315]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 460:\n        if (user.editableElement) {\n            userKeyboards = [];\n            userKeyboards.push(['Карта', 'Наличка', 'Наличка + Счёт'], ['Карта + Счёт', 'Счёт'])\n            user.sendKeyboard(userKeyboards, 'Выбери предпочтительный метод оплаты, \\nили можно использовать: [/skip], для пропуска этого шага.');\n            user.setMode(ID, 461);\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [316]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 461:\n        if (user.editableStage) {\n            if (originalMessage.text == '/skip') {\n                user.setMode(ID, 46);\n                app.switcher(user);\n            }else{\n                // Комментарий к этапу\n                if (!user.editableStage?.commentary) user.editableStage.commentary = '';\n                user.editableStage.commentary += 'Оплатить:' + originalMessage.text + ' ';\n                user.editableStage.save(user, (err, stage) => {\n                    if (!err) {\n                    }\n                    user.setMode(ID, 46);\n                    app.switcher(user);\n                });\n                \n            }\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [317]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n\n    case 46:\n        if (user.editableElement) {\n            user.sendMessage('Внеси комментарий к этапу, \\nили можно использовать: [/skip], для пропуска этого шага.', true);\n            user.setMode(ID, 47);\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [316]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 47:\n        if (user.editableStage) {\n            if (originalMessage.text == '/skip') {\n                user.setMode(ID, 50);\n                app.switcher(user);\n            }else{\n                // Комментарий к этапу\n                if (!user.editableStage?.commentary) user.editableStage.commentary = '';\n                user.editableStage.commentary += originalMessage.text;\n                user.editableStage.save(user, (err, stage) => {\n                    if (!err) {\n                    }\n                    user.setMode(ID, 50);\n                    app.switcher(user);\n                });\n                \n            }\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [317]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 50:\n        // Сохранение элемента\n        if (user.editableElement) {\n            user.editableElement.save(user, (err, element) => {\n                if (err){\n                    user.sendMessage('Ошибка сохранения этапа. Ошибка [318]');\n                    user.setMode(ID, 100);\n                    app.switcher(user);\n                    return null;\n                }\n                user.sendMessage('Этап ' + user.editableStage.stageName + ' успешно добавлен.');\n                user.setMode(ID, 100);\n                app.switcher(user);\n            });\n        } else {\n            user.sendMessage('Этап не найден. Ошибка [319]');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 60:\n        // Выбор контрагента.\n        if (user.editableElement) {\n            if (originalMessage.text.match(/\\/agent/)) {\n                let [command, id] = originalMessage.text.split(/\\/agent/);\n                tempData =  users.userList.find(u => u.id == id);\n            }else{\n                tempData =  users.userList.find(u => u.first_name == originalMessage.text);\n            }\n            if (tempData) {\n                user.editableElement.senderId = user.id;\n                user.editableElement.recipientId = tempData.id;\n                user.setMode(ID, 61);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Неизвестная команда. Ошибка [3101]');\n            }\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break\n    case 61:\n        if (user.editableElement) {\n            try {\n                txt = 'Выбери тип оплаты:';\n                user.setMode(ID, 62);\n                user.sendKeyboard([[buttons.payment.payCard.name, buttons.payment.payCash.name, \n                                        buttons.payment.payBill.name], [buttons.payment.payOther.name], [buttons.cancellation.name]], txt); \n                return null;\n            } catch (error) {\n                node.error(error)\n            }\n            \n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 62:\n        if (user.editableElement) {\n            try {\n                if (originalMessage.text == buttons.payment.payCard.name || \n                    originalMessage.text == buttons.payment.payCash.name || \n                        originalMessage.text == buttons.payment.payBill.name ||\n                        originalMessage.text == buttons.payment.payOther.name\n                    ) {\n                    txt = 'Тип оплаты: ' + originalMessage.text;\n                    if (originalMessage.text == buttons.payment.payCard.name) {\n                        txt += '\\nНомер: ' + user.editableElement.recipient().card();\n                    }\n                    user.editableElement.typePayment = originalMessage.text;\n\n                    if (originalMessage.text == buttons.payment.payOther.name) {\n                        txt += `\\nКаким образом будет выполнена оплата?`;\n                        user.setMode(ID, 63);\n                    }else{\n                        txt += '\\nВведи сумму аванса:';\n                        user.setMode(ID, 64);\n                    }\n\n                    user.sendMessage(txt, true);\n\n            }else{\n                user.sendMessage('Неизветсная команда. Используй кнопки.');\n            }\n            } catch (e) {\n                node.warn(e)\n            }\n\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 63:\n        if (user.editableElement) {\n            user.editableElement.typePayment += ` \"${originalMessage.text}\"`;\n            txt = 'Введи сумму аванса:';\n            user.setMode(ID, 64);\n            user.sendMessage(txt, true);\n        }else{\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 64:\n        if (user.editableElement) {\n            if (!isNaN(originalMessage.text)) {\n                user.editableElement.a = 1;\n                /** Можно внести отрицательный аванс */\n                user.editableElement.price = originalMessage.text;\n               \n                user.setMode(ID, 46);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Сумма должна быть цифрой.');\n            }\n        }else{\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        return null;\n        break;\n    case 67:\n        (async function (u, st, text) {\n            u.setMode(ID, WAITING_STEP);\n            const elem = st.firstElement();\n            const sender = elem.sender();\n            if (elem.type().groupId == 1) return u.sendMessage('Нельзя внести оплату в этап \"Аванс\".');\n            if (!u.temporaryData.dataStage) return u.sendMessage('Оплату можно внести, только через меню этапа.');\n            try {\n                const {stagePayments, stageSumm, prepaid, docPaymentsPrepaid, overpayment} = u.temporaryData.dataStage;\n                if ((stageSumm - stagePayments) <= 0) return u.sendMessage(`Этап ${st.stageName} полностью оплачен. В оплате авансом нет необходимости.`);\n                if ((prepaid + overpayment) - docPaymentsPrepaid <= 0) return u.sendMessage(`К сожалению аванс у контрагента ${elem.sender().first_name} исчерпан`);\n\n                if (((prepaid + overpayment) - docPaymentsPrepaid) >= (Math.abs(stagePayments - stageSumm))) txt = `\\nДля оплаты всей суммы ${app.formatMonetary(stagePayments - stageSumm)} нажми [/payallsum]`;\n                else txt = `\\nДля оплаты на сумму ${app.formatMonetary((prepaid + overpayment) - docPaymentsPrepaid)} нажми [/paybalpr]`;\n\n                txt += `\\nИли введи свою сумму.`\n                txt += `\\nДля отмены нажми [/cancel]`\n                u.setMode(ID, 68);\n                u.sendMessage(txt, true);\n            } catch (error) {node.error(error);}\n        })(user, user.editableStage, originalMessage.text);\n        break;\n    case 68:\n        (async function (u, st, text) {\n            const {stagePayments, stageSumm, prepaid, docPaymentsPrepaid, overpayment} = u.temporaryData.dataStage;\n            const elem = st.firstElement();\n            const sender = elem.sender();\n            let paySum = 0;\n            if (text == '/cancel') {\n                u.setMode(ID, 200);\n                app.switcher(u);\n                return;\n            }\n            if (text == '/payallsum') paySum = Math.abs(stageSumm - stagePayments);\n            if (text == '/paybalpr') paySum = ((prepaid + overpayment) - docPaymentsPrepaid) > (stageSumm - stagePayments) ? \n                                                            (stageSumm - stagePayments) : ((prepaid + overpayment) - docPaymentsPrepaid);\n            if (!isNaN(text)) paySum = Math.abs(text);\n            if (!paySum) return u.sendMessage(`Некорректные данные. Введи сумму.`);\n            st.createElement(u, (err, element) => {\n                if (err) throw err;\n                element.typeElementId = 9;\n                element.recipientId = elem.senderId;\n                element.senderId = u.id;\n                element.a = 1;\n                element.typePayment = documents.typeElementList.find(item => item.id == 9).name || 'Оплата авансом';\n                element.dateElement = new Date();\n                originalMessage.text = String(paySum);\n                u.setMode(ID, 73);\n                app.switcher(u);\n                return;\n            });\n        })(user, user.editableStage, originalMessage.text);\n        //user.setMode(ID, WAITING_STEP);\n        break;\n    case 69:\n        //user.setMode(ID, WAITING_STEP);\n        break;\n    case 70:\n        if (user.editableStage) {\n            if (user.editableStage.firstElement()) {\n                if (user.editableStage.firstElement().type().groupId == 1) {\n                    user.sendMessage('Нельзя внести оплату в этап \"Аванс\".');\n                    user.setMode(ID, 200);\n                    app.switcher(user);\n                    return null;\n                }\n            }\n            user.editableStage.createElement(user, (err, elementl) => {\n                elementl.typeElementId = 7;\n                elementl.recipientId = user.editableStage.firstElement().senderId;\n                elementl.senderId = user.id\n                elementl.a = 1;\n                txt = 'Выбери тип оплаты:';\n                user.setMode(ID, 71);\n                user.sendKeyboard([[buttons.payment.payCard.name, buttons.payment.payCash.name, \n                                        buttons.payment.payBill.name], [buttons.cancellation.name]], txt);\n            })\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 71:\n        if (user.editableElement) {\n            if (originalMessage.text == buttons.cancellation.name) {\n                user.setMode(ID, 200);\n                app.switcher(user);\n                return null;\n            }\n            if (originalMessage.text == buttons.payment.payCard.name || \n                    originalMessage.text == buttons.payment.payCash.name || \n                        originalMessage.text == buttons.payment.payBill.name) {\n                        txt = 'Выбран тип оплаты: ' + originalMessage.text;\n                        txt += '\\nУкажи дату оплаты в формате ДД.ММ.ГГ\\nИли пропусти этот шаг [/skip], в этом случае дата будет текущей - ' +\n                                    app.formatDate(new Date());\n                        user.editableElement.typePayment = originalMessage.text;\n                        user.setMode(ID, 72);\n                        user.sendMessage(txt, true);\n            }\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.reset();\n            app.switcher(user);\n        }\n        break;\n    case 72:\n        if (user.editableElement) {\n            if (originalMessage.text == '/skip') {\n                user.editableElement.dateElement = new Date();\n            } else {\n                try {\n                    tempData = app.stringToDate(originalMessage.text);\n                    if (app.isValidDate(tempData)) {\n                        user.editableElement.dateElement = tempData;\n                    }else{\n                        user.sendMessage(originalMessage.text + ' - некорректный формат, или дата. (Пример - 01.01.2007 или 01.01)');\n                        return null;\n                    }\n                } catch (error) {\n                    user.sendMessage(originalMessage.text + ' - некорректный формат, или дата. (Пример - 01.01.2007 или 01.01)');\n                    return null;\n                }\n            }\n            user.sendMessage('Укажи сумму оплаты:', true);\n            user.setMode(ID, 73);\n            return null;\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.reset();\n            app.switcher(user);\n        }\n        break;\n    case 73:\n        if (user.editableElement) {\n            if (!isNaN(originalMessage.text)) {\n                user.editableElement.price = Math.abs(originalMessage.text);\n                txt = 'Оплата этапа ' + user.editableStage.stageName + ' на сумму ' + app.formatMonetary(user.editableElement.price);\n                txt += '\\n' + 'Тип оплаты: ' + user.editableElement.typePayment;\n                txt += '\\nПолучатель: ' +  users.getUserToId(user.editableElement.recipientId).first_name; \n                txt += '\\nДата: ' + app.formatDate(user.editableElement.dateElement);\n                txt += '\\n' + 'Подтвердить оплату?';\n                user.sendKeyboard([[buttons.сonfirm.name, buttons.cancellation.name]], txt);\n                user.setMode(ID, 74);\n            }else{\n                user.sendMessage('Неизвестная команда. Сумма должна быть цифрой.');\n            }\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 74:\n        if (user.editableElement) {\n            if (originalMessage.text == buttons.cancellation.name) {\n                user.sendMessage('Оплата отменена.');\n                user.setMode(ID, 200);\n                app.switcher(user);\n                return null;\n            }\n            if (originalMessage.text == buttons.сonfirm.name) {\n                (async function (u, st, elem,  text) {\n                    const sender = st.firstElement().sender();\n                    if (elem.type().groupId == 11) {\n                        const dataPrepaid = await u.temporaryData.tempFunction.getDataPrepaidExpense();\n                        const dataOverpayment = await u.temporaryData.tempFunction.getOverpaymentToDocument();\n                        //Вычисление данных\n                        const prepaid = dataPrepaid.reduce((total, item) => {\n                            if (item.ELEMENT_GROUP == 1) return total + (item.RESULT_SUM || 0)\n                            else return total}, 0);\n                        const docPaymentsPrepaid = dataPrepaid.reduce((total, item) => {\n                            if (item.ELEMENT_GROUP == 11) return total + (item.RESULT_SUM || 0)\n                            else return total}, 0);\n                        const overpayment = dataOverpayment.reduce((total, item) => {\n                            if (item.ID_BILLING_ACCOUNT == sender.billingAccountId) return total + (item.RESULT_SUM || 0)\n                            else return total;}, 0);\n                        if (((prepaid + overpayment) - docPaymentsPrepaid ) < parseFloat(elem.price)) {\n                            u.setMode(ID, 200);\n                            u.sendMessage('Не хватает средств для оплаты авансом, возможно аванс был уже реализован.');\n                            return app.switcher(u);\n                        }\n                    }\n                    elem.save(u, (err, element) => {\n                        if (err) {\n                            u.sendMessage('Ошибка при внесении оплаты.');\n                        }else{\n                            u.sendMessage('Оплата успешно добавлена.');\n                            txt = `${u.first_name} оплатил этап: [/stg${st.id}] \\n${st.dynamicName()}.\\nНа сумму ${app.formatMonetary(elem.price)}`;\n                            txt += `\\nТип оплаты: ${elem.typePayment}`;\n\n                        \n                                app.users.sendMsgToGroupId(7, txt, false, u.id);\n                                app.users.getUserToId(st.authorId).sendMessage(txt);\n                                app.users.getUserToId(70).sendMessage(txt);\n                            \n                        }\n                        u.setMode(ID, 200);\n                        app.switcher(u);\n                    });\n                })(user, user.editableStage, user.editableElement, originalMessage.text);\n            }\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 76:\n        (async function (stg) {\n            try {\n                if(stg){\n                    if (stg.payments().length > 0) {\n                        txt = 'Выбери оплату которую надо удалить:';\n                        txt += '\\n\\n' + stg.payments().map((item, i) => {\n                            return (i + 1) + '. Получатель: ' + app.users.getUserToId(item.recipientId).first_name + ', ' + item.typePayment + \n                                '\\nСумма: ' + app.formatMonetary(item.summ) + \n                                '\\nОплатил: ' + app.users.getUserToId(item.senderId).first_name + \n                                ', дата оплаты ' + app.formatDate(item.dateElement) + '\\nУдалить [/pdel' + item.id + ']';\n                        }).join('\\n\\n');\n                        user.sendKeyboard([[buttons.documents.backToStage.name]], txt)\n                        user.setMode(ID, 77);\n                    } else {\n                        user.sendMessage(`Этап № ${stg.stageNumber} не содержит оплат.`);\n                        user.setMode(ID, 200);\n                        app.switcher(user);\n                    }\n                }else{\n                    user.sendMessage('Этап не найден.');\n                    user.setMode(0, 0);\n                    app.switcher(user);\n                }\n            } catch (error) {\n                node.error(error);\n            }\n        })(user.editableStage);\n        break;\n    case 77:\n        (async function (text) {\n            if (text == buttons.documents.backToStage.name) {\n                user.setMode(ID, 200);\n                app.switcher(user);\n                return null;\n            }\n            if (text.match(/\\/pdel/)) {\n                \n                try {\n                    let [command, id] = text.split(/\\/pdel/);\n                    let TempElement =  documents.elementList.find(l => l.id == id);\n                    let res = await TempElement.delete(user);\n                    user.setMode(ID, 76);\n                    app.switcher(user);\n                } catch (error) {\n                    node.error(error);\n                }\n            }else{\n                user.sendMessage('Неизвестная команда');\n            }\n        })(originalMessage.text);\n        break;\n    case 80:\n        if (user.editableDocument) {\n            (async function (doc) {\n                let res;\n                if (user.groupId == 7) {\n                    txt = 'Ты собираешься удалить документ № ' + doc.id + ' от ' + app.formatDate(doc.dateCreation) + \n                        '\\nВ документе ' + (doc.count() > 0 ? ' создано ' + doc.count() + ' этапов.' : ' нет этапов.') + \n                        '\\nДокумент будет перемещен в корзину со всеми этапами, оплатами и т д.' + \n                        '\\n' + \"—\".repeat(NUMBER_OF_LINES) + \n                        '\\nДля подтверждения нажми на ссылку \\n[/confirm]' +\n                        '\\n\\nДля отмены удаления нажми ссылку \\n[/cancel]' +\n                        '\\nОтмена, так же снимет метку об удалении, если таковая есть.';\n                    user.sendMessage(txt);\n                    user.setMode(ID, 81);\n                }else{\n                    if (user.editableDocument.markedForDeletion) {\n                        user.sendMessage('Документ № ' + doc.id + ' уже помечен на удаление.');\n                    }else{\n                        res = await doc.markForDeletion(user);\n                        if (res) {\n                            user.sendMessage('Документ № ' + doc.id + ' помечен на удаление.');\n                            users.sendMsgToGroupId(7, user.first_name + ' пометил (а) документ № ' + doc.id + ' на удаление.' +\n                                '\\nОткрыть документ: [/doc' + doc.id + ']');\n                        }\n                    }\n                    user.setMode(0, 1);\n                    app.switcher(user);\n                }\n            })(user.editableDocument);\n        } else {\n            user.sendMessage('Документ не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 81:\n        (async function (doc, text) {\n            if (doc) {\n                try {\n                    let res\n                    switch (text) {\n                        case '/confirm':\n                            res = await doc.delete(user);\n                            if (res) {\n                                user.sendMessage('Документ № ' + doc.id + ' удален.');\n                            } else {\n                                user.sendMessage('Ошибка удаления документа № ' + doc.id + '.');\n                            }\n                            user.setMode(0, 1);\n                            app.switcher(user);\n                            break;\n                        case '/cancel':\n                            let query = 'update tg_documents d set d.marked_for_deletion = 1 where d.id = ' + doc.id;\n                            res = await app.db.executeRequest(user, 'cubic', query);\n                            user.sendMessage('Удаление документа № ' + doc.id + ' отменено.');\n                            user.setMode(0, 1);\n                            app.switcher(user);\n                            break;\n                        default:\n                            user.sendMessage('Неверная команда.');\n                            break;\n                    }\n                } catch (error) {\n                    user.sendMessage('При удалении документа, возникла ошибка.');\n                    user.setMode(0, 0);\n                    app.switcher(user);\n                }\n            }else{\n                user.sendMessage('Документ не найден.');\n                user.setMode(0, 0);\n                app.switcher(user);\n            }\n        })(user.editableDocument, originalMessage.text)\n        break;\n    case 85:\n        if (user.editableStage) {\n            (async function (stg) {\n                let res;\n                if (user.groupId == 7) {\n                    txt = 'Ты собираешься удалить этап № ' + stg.stageNumber + ' от ' + app.formatDate(stg.dateStage) + \n                        '\\nЭтап ' + (stg.payments().length > 0 ? ' содержит ' + stg.payments().length + ' оплат.' : ' не содержит оплат.') + \n                        '\\nЭтап будет перемещен в корзину со всеми оплатами и т д.' + \n                        '\\n' + \"—\".repeat(NUMBER_OF_LINES) + \n                        '\\nДля подтверждения нажми на ссылку \\n[/confirm]' +\n                        '\\n\\nДля отмены удаления нажми ссылку \\n[/cancel]' +\n                        '\\nОтмена, так же снимет метку об удалении, если таковая есть.';\n                    user.sendMessage(txt);\n                    user.setMode(ID, 86);\n                }else{\n                    if (user.editableStage.markedForDeletion) {\n                        user.sendMessage('Этап ' + stg.stageNumber + ' документа № ' + stg.documentId + ' уже помечен на удаление.');\n                    } else {\n                        res = await stg.markForDeletion(user);\n                        if (res) {\n                            user.sendMessage('Этап ' + stg.stageNumber + ' документа № ' + stg.documentId + ' помечен на удаление.');\n                            users.sendMsgToGroupId(7, user.first_name + ' пометил (а) этап № ' + stg.stageNumber + \n                                    ' документа № ' + stg.documentId + ', на удаление.' +\n                                        '\\nОткрыть этап: [/stg' + stg.id + ']');\n                        }\n                    }\n                    user.setMode(2, 100);\n                    app.switcher(user);\n                }\n            })(user.editableStage);\n        } else {\n            user.sendMessage('Этап не найден.');\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 86:\n        (async function (stg, text) {\n            try {\n                let res;\n                switch (text) {\n                    case '/confirm':\n                        tempData = {};\n                        tempData.stageNumber = stg.stageNumber;\n                        tempData.documentId = stg.documentId;\n                        tempData.authorId = stg.authorId;\n                        res = await stg.delete(user);\n                        if (res) {\n                            user.sendMessage('Этап ' + tempData.stageNumber + ' документа № ' + tempData.documentId + ' удален.');\n                            if (user.id != tempData.authorId) {\n                                app.users.getUserToId(tempData.authorId)\n                                    .sendMessage(`Этап № ${tempData.stageNumber}, документа № ${tempData.documentId} был удален пользователем ${user.first_name}`);\n                            }\n                        } else {\n                            user.sendMessage('Ошибка удаления этапа № ' + tempData.stageNumber + '.');\n                        }\n                        user.setMode(2, 100);\n                        app.switcher(user);\n                        break;\n                    case '/cancel':\n                        let query = 'update tg_stages s set s.marked_for_deletion = 1 where s.id = ' + stg.id;\n                        res = await app.db.executeRequest(user, 'cubic', query);\n                        stg.markedForDeletion = null;\n                        user.sendMessage('Удаление этапа № ' + stg.stageNumber + ' отменено.');\n                        user.setMode(2, 100);\n                        app.switcher(user);\n                        break;\n                    default:\n                        user.sendMessage('Неверная команда.');\n                        break;\n                }\n            } catch (error) {\n                user.sendMessage('Во время удаления этапа произошла ошибка.');\n                user.setMode(0, 0);\n                app.switcher(user);\n            }\n        })(user.editableStage, originalMessage.text);\n        break;\n    case 90:\n        let i = 0;\n        let tempArr = [];\n        userKeyboards = [];\n        // **************************************************************************\n        // Формирование кнопок.\n        for (const u of users.userList.filter(u => u.group().id == 4)) {\n            if (i == 0) {\n                tempArr = [];\n                userKeyboards.push(tempArr);\n            }\n            tempArr.push(u.first_name);\n            i++;\n            if (i > 2) i = 0;\n        }\n        txt = 'Кому будет передана поставка кругляка:' + '\\n' + \"—\".repeat(NUMBER_OF_LINES) +\n                            '\\n' + users.userList.filter(u => u.group().id == 4)\n                                    .map(u => {return i++ + '. [/agent' + u.id + '] ' + u.first_name}).join('\\n' + \"—\".repeat(16) + '\\n');\n        txt += '\\nМожно пропустить этот шаг.';\n            user.setMode(ID, 91);\n            tempArr.push(buttons.users.meCounterparty.name);\n            userKeyboards.push([buttons.skipStep.name]);\n            user.sendKeyboard(userKeyboards, txt);\n        break;\n    case 91:\n        if (originalMessage.text == buttons.skipStep.name) {\n            user.setMode(ID, 42);\n            app.switcher(user);\n        }else{\n            if (originalMessage.text.match(/\\/agent/)) {\n                let [command, id] = originalMessage.text.split(/\\/agent/);\n                tempData =  users.userList.find(u => u.id == id);\n            }else{\n                if (originalMessage.text == buttons.users.meCounterparty.name) {\n                    tempData =  user;\n                } else {\n                    tempData =  users.userList.find(u => u.first_name == originalMessage.text);\n                } \n            }\n            if (tempData) {\n                user.editableElement.recipientId = tempData.id;\n                user.setMode(ID, 42);\n                app.switcher(user);\n            } else {\n                user.sendMessage('Неизвестная команда.');\n            }\n        }\n        return null;\n        break;\n    case 92:\n        break;\n    case 100:  \n        if (user.editableDocument) {\n            if (keyboards.permissionCheck(buttons.documents.editDocument, user.group().id)) {\n                userKeyboards = keyboards.get(buttons.documents.editDocument.name, user.group().id);\n            } else {\n                user.setMode(0, 0);\n                user.sendMessage('Нет прав на редактирование документа. Ошибка [320]');\n                app.switcher(user);\n                return null;\n            }   \n            (async function (doc) {\n                try {\n                    let i = 1;\n                    let tArr;\n                    let tempMoney; \n                    let maxMassage = 3700; // Кол-во символов собщения\n                    let isShowButtons = false;\n                    let txtArr = [];\n                    let query;\n                    txt = \"—\".repeat(NUMBER_OF_LINES);\n                    txt += '\\n' + (doc.markedForDeletion ? '❗️' : '') + \n                        '<b>Документ № ' + user.editableDocument.id + ' от ' + app.formatDate(user.editableDocument.dateCreation) + '</b>';\n                    txt += '\\n' + \"—\".repeat(16);\n                    if (user.editableDocument.markedForDeletion) txt += '\\n❗️ <i>ДОКУМЕНТ ПОМЕЧЕН НА УДАЛЕНИЕ</i> ❗️' + \"—\".repeat(16);\n\n                    txt += '\\nСтатус: <i>' + user.editableDocument.status().name + '</i>' + \n                            '\\nАвтор: ' + user.editableDocument.author().first_name +\n                            `${user.editableDocument.commentary ? '\\n<i>' + user.editableDocument.commentary + '</i>' : ''}` + \n                            '\\n' + \"—\".repeat(16) +\n                            '\\nСумма: ' + app.formatMonetary(user.editableDocument.summ()) + ' / ' + \n                                        app.formatMonetary(user.editableDocument.AmountOfPayments()) +\n                            '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n\n                    let getPrepaidDoc = getDataPrepaidExpense(user, doc.id);\n                    let getOverpaymentToDoc = getOverpaymentToDocument(user, doc.id);\n                    // Получение данных\n                    let dataPrepaid = await getPrepaidDoc();\n                    let dataOverpayment = await getOverpaymentToDoc();\n\n                    let billingsUniqueID = [...new Set(\n                        doc.stages().map(item => {\n                            if (item.firstElement().type().groupId != 1) return item.firstElement().sender().billingAccountId;\n                            else return item.firstElement().recipient().billingAccountId;\n                        })\n                    )];\n                    tempData = [];\n                    //Вычисление данных\n                    billingsUniqueID.forEach(currentItem => {\n                        let prepaid = dataPrepaid.reduce((total, item) => {\n                            if (item.ELEMENT_GROUP == 1 && item.ID_BILLING_ACCOUNT == currentItem) return total + (item.RESULT_SUM || 0)\n                            else return total}, 0);\n\n                        let docPaymentsPrepaid = dataPrepaid.reduce((total, item) => {\n                            if (item.ELEMENT_GROUP == 11 && item.ID_BILLING_ACCOUNT == currentItem) return total + (item.RESULT_SUM || 0)\n                            else return total}, 0);\n\n                        let overpayment = dataOverpayment.reduce((total, item) => {\n                            if (item.ID_BILLING_ACCOUNT == currentItem) return total + (item.RESULT_SUM || 0)\n                            else return total;}, 0);\n                            \n                        if (prepaid > 0 || overpayment > 0) tempData.push({idBilling: currentItem, prepaid: prepaid, overpayment: overpayment, docPaymentsPrepaid: docPaymentsPrepaid});\n                    })\n                    if (tempData.length > 0) {\n                        txt += '\\n' + tempData.map(item => {\n                            const counterparty = users.userList.find(u => u.billingAccountId == item.idBilling);\n                            const counterpartyName = counterparty ? counterparty.first_name : 'Счет № ' + item.idBilling;\n                            const type = (item.prepaid > 0 ? '\"Аванс\"' : '\"Переплата\"');\n                            return `💰 ${counterpartyName} ${type} ${app.formatMonetary(item.prepaid + item.overpayment)} / ${app.formatMonetary((item.prepaid + item.overpayment) - item.docPaymentsPrepaid)}`;\n                        }).join('\\n');\n                        txt += '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n                    }\n                    // Если здокумент закрыт, выводим сводные данные \"На цех\"\n                    if (user.editableDocument.statusId == 2) {\n                        tempData = await user.editableDocument.getClosedData(user);\n\n                        if (tempData) {\n                            txt += '\\n<b>Обошлось на цех:</b>';\n                            tArr = await Promise.all(tempData.map(async function (item) {\n                                let t = '';\n                                let cmzD = 0;\n                                let cmz87 = 0;\n                                let cmz67 = 0;\n                                let cmz47 = 0;\n                                let cmzCubic = 0;\n                                let cruglyak = 0;\n                                \n                                let tempRes;\n                                let tempStages = doc.stages().filter(s => {\n                                    return s.firstElement().type().groupId == 6 &&\n                                    s.material().name == item.NAME\n                                })\n\n                                for (const iterator of tempStages) {\n                                    query = `select * from TGP_GET_RESULT_CLOSE_DOC (${iterator.id})`;\n                                    tempRes = (await app.db.executeRequest(user, 'cubic', query)).result;\n\n\n                                    cmzD += tempRes[0].AMOUNT;\n                                    cmz87 += tempRes[1].AMOUNT;\n                                    cmz67 += tempRes[2].AMOUNT;\n                                    cmz47 += tempRes[3].AMOUNT;\n                                    cmzCubic += tempRes[4].AMOUNT;\n                                }\n\n                                let cruglyakStages = doc.stages().filter(s => {\n                                    return s.firstElement().type().groupId == 2 &&\n                                    s.material().name == item.NAME\n                                })\n\n                                \n                                for (const iterator of cruglyakStages) {\n                                    cruglyak += iterator?.firstElement()?.value || 0;\n                                }\n\n                                t += `${item.NAME}:`;\n                                if (Math.abs(item.SUMM) > 0 || cruglyak > 0) {\n\n                                    /**\n                                     * Цены на ЧМЗ\n                                     */\n\n                                    const priceCMZ87 = 30000; \n                                    const priceCMZ67 = 22000;\n                                    const priceCMZ47 = 17000;\n                                    const priceCubic = 15000;\n                                    \n                                       \n                                    t += cmzD ? `\\nЧМЗ деловой: ${cmzD.toFixed(3)} × <code>${((Math.abs(item.SUMM) - (cmz87 * priceCMZ87) - (cmz67 * priceCMZ67) - (cmz47 * priceCMZ47) - (cmzCubic * priceCubic)) / (item.RES - (cmz87 + cmz67 + cmz47 + cmzCubic))).toFixed(2)}</code> руб./м³` : '';\n                                    if (cmz87 > 0) t += `\\nЧМЗ 87: ${cmz87.toFixed(3)} × ${priceCMZ87} руб./м³`;\n                                    if (cmz67 > 0) t += `\\nЧМЗ 67: ${cmz67.toFixed(3)} × ${priceCMZ67} руб./м³`;\n                                    if (cmz47 > 0) t += `\\nЧМЗ 47: ${cmz47.toFixed(3)} × ${priceCMZ47} руб./м³`;\n                                    if (cmzCubic > 0) t += `\\nКубики: ${cmzCubic.toFixed(3)} × ${priceCubic} руб./м³`;\n                                    if (cruglyak && cruglyak > 0) t += `\\nВсего куплено кругляка ${cruglyak.toFixed(3)} м³.`;\n                                }else{\n                                    t += ` Нет данных`;\n                                }\n                                return t;\n                            }));\n                            txt += '\\n' + tArr.join('\\n');\n                            txt += '\\n' + \"—\".repeat(16);\n                        }\n                    }\n                    //**************************************************************************** */\n                    if (user.editableDocument.count() > 0) {\n                        query =`select S.ID, M.NAME, S.STAGE_NUMBER, S.AUTHOR_ID, S.STAGE_NAME, \n                                                    S.COMMENTARY, S.DATE_STAGE, S.MARKED_FOR_DELETION,\n                                (select first 1 L.RESULT_VALUE\n                                            from TG_STAGE_ELEMENTS L\n                                            left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n                                            where L.ID_STAGE = S.ID and\n                                                (T.ELEMENT_GROUP != 10 and\n                                                T.ELEMENT_GROUP != 11)) as RESULT_VALUE,\n                                coalesce((select first 1 L.RESULT_SUM\n                                            from TG_STAGE_ELEMENTS L\n                                            left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n                                            where L.ID_STAGE = S.ID and\n                                                (T.ELEMENT_GROUP != 10 and\n                                                T.ELEMENT_GROUP != 11)), 0) as RESULT_SUM,\n                                coalesce((select sum(L.RESULT_SUM)\n                                            from TG_STAGE_ELEMENTS L\n                                            left join TG_TYPE_ELEMENT T on (L.TYPE_ELEMENT_ID = T.ID)\n                                            where L.ID_STAGE = S.ID and\n                                                (T.ELEMENT_GROUP = 10 or (T.ELEMENT_GROUP = 11))), 0) as PAYMENTS\n                            from TG_STAGES S\n                            left join MATERIAL M on (S.MATERIAL_ID = M.ID)\n                            where \n                            (s.isdeleted is null or (s.isdeleted = 0)) and\n                            S.DOCUMENT_ID = ${doc.id}\n                            order by S.ID`;\n                        tempData = (await app.db.executeRequest(user, 'cubic', query)).result;   \n                        \n\n                        tArr = doc.stages().map((item, i) => {\n                            const itemData = tempData.find(i => i.ID == item.id);\n                            let t =  `\\n${i + 1}. [${STAGE_ID_PREFIX + item.id}]${item.markedForDeletion == -1 ? ' (Удаление..)' : ''}${item.dynamicName() ? ' ' + item.dynamicName() : ''}`;\n                                        `${item.commentary ? '\\n<i>' + item.commentary + '</i>': ''}`;\n                            if (!item.firstElement()) return t;\n                            if (!itemData) return t;\n                            const groupId = item.firstElement().type().groupId;\n                            if (groupId == 1 || (groupId == 6 && itemData.RESULT_SUM == 0)) return t;\n                            t += `\\n${tempFunIcoPay(itemData.RESULT_SUM, itemData.PAYMENTS)} Сумма: ${app.formatMonetary(itemData.RESULT_SUM)} / ${app.formatMonetary(itemData.PAYMENTS)}`;\n                            t += (itemData.RESULT_SUM - itemData.PAYMENTS < 0 ? '\\n(Переплата - ' + app.formatMonetary(Math.abs(itemData.RESULT_SUM - itemData.PAYMENTS)) + ')' : '');\n                            return t;\n                        });\n\n                        /*\n                        let tempFunIcoPay = (balance) => {if (balance === 0) return '✅'; return '✖️';};\n                        tArr = await Promise.all(user.editableDocument.stages().map(async function (item, i) { \n                            tempMoney = await documents.getMoneyStage(user, item.id);\n                            if (!tempMoney) return '';\n                            let t = '\\n' + (i + 1) + '. [' + STAGE_ID_PREFIX + item.id + ']' + \n                                        (item.markedForDeletion == -1 ? ' (Удаление..)' : '') + `${item.dynamicName() ? ' ' + item.dynamicName() : ''}`;\n                            t += (item.commentary ? '\\n<i>' + item.commentary + '</i>': '');\n                            if (!item.firstElement()) return t;\n                            if (item.firstElement().type().groupId == 1 || (item.firstElement().type().groupId == 6 && Math.abs(tempMoney.CREDIT) == 0)) return t;\n                            if (tempMoney.CREDIT) {\n                                t += `\\n${tempFunIcoPay(tempMoney.CREDIT + tempMoney.DEBIT)} `;\n                                t += 'Сумма: ' + (tempMoney ? app.formatMonetary(Math.abs(tempMoney.CREDIT)) : 0) + \n                                                                        ' / ' + (tempMoney ? app.formatMonetary(tempMoney.DEBIT) : 0); \n                            }\n                            t += (tempMoney.STAGE_BALANCE > 0 ? '\\n(Переплата - ' + app.formatMonetary(tempMoney.STAGE_BALANCE) + ') ⚠️' : '');\n                            return t;\n                        }));\n                        */\n                        for (const iterator of tArr) {\n                            if (txt.length >= maxMassage) {\n                                txtArr.push(txt);\n                                txt = '';\n                            }\n                            txt += iterator + '\\n' + \"—\".repeat(16);\n                        }\n                    } else {txt += '\\nЭтапы не добавлены.';}\n                    txtArr.push(txt);\n                    while (txtArr.length > 0) {\n                        if (!isShowButtons) {\n                            if (userKeyboards) user.sendKeyboard(userKeyboards, txtArr.shift());\n                            isShowButtons = true;\n                        }else{if (userKeyboards) user.sendMessage(txtArr.shift());}\n                    }\n                } catch (error) {node.error(error);}\n            })(user.editableDocument);\n            user.setMode(ID, WAITING_STEP);\n            return null;\n        }else{\n            user.sendMessage('Документ не найден. Ошибка');\n            user.setMode(0, 1);\n            app.switcher(user); \n            return null;\n        }\n        break;\n    case 200:\n        //u.temporaryData\n        (async function (u, st, text) {\n            if (!st) {\n                user.sendMessage('Этап не найден.');\n                user.setMode(0, 1);\n                app.switcher(user);\n                return;\n            }\n            txt = '';\n            const doc = st.document();\n            const elem = st.firstElement();\n            const sender = elem.sender();\n            try {\n                //Замыкание функций и сохранение в временный объект\n                u.temporaryData.tempFunction = {}\n                u.temporaryData.tempFunction.getDataStage = getDataStage(u, st.id);\n                u.temporaryData.tempFunction.getDataPrepaidExpense = getDataPrepaidExpense(u, doc.id, sender.billingAccountId);\n                u.temporaryData.tempFunction.getOverpaymentToDocument = getOverpaymentToDocument(u, doc.id);\n                // Получение данных\n                const dataStage = await u.temporaryData.tempFunction.getDataStage();\n                const dataPrepaid = await u.temporaryData.tempFunction.getDataPrepaidExpense();\n                const dataOverpayment = await u.temporaryData.tempFunction.getOverpaymentToDocument();\n                //Вычисление данных\n\n                const stagePayments = dataStage.reduce((total, item) => {\n                    if (item.ELEMENT_GROUP == 10 || item.ELEMENT_GROUP == 11) return total + (item.SUMM || 0);\n                    else return total;\n                }, 0);\n\n                const stageSumm = dataStage.reduce((total, item) => {\n                    if (item.ELEMENT_GROUP != 10 && item.ELEMENT_GROUP != 11) return total + (item.SUMM || 0);\n                    else return total;\n                }, 0);\n\n                const prepaid = dataPrepaid.reduce((total, item) => {\n                    if (item.ELEMENT_GROUP == 1) return total + (item.RESULT_SUM || 0)\n                    else return total\n                }, 0);\n\n                const overpayment = dataOverpayment.reduce((total, item) => {\n                    if (item.ID_BILLING_ACCOUNT == sender.billingAccountId) return total + (item.RESULT_SUM || 0)\n                    else return total;\n                }, 0);\n\n                const docPaymentsPrepaid = dataPrepaid.reduce((total, item) => {\n                    if (item.ELEMENT_GROUP == 11) return total + (item.RESULT_SUM || 0)\n                    else return total\n                }, 0);\n                u.temporaryData.dataStage = {};\n                u.temporaryData.dataStage = {stagePayments, stageSumm, prepaid, docPaymentsPrepaid, overpayment};\n                // Формирование вывода в телеграм\n                txt += \"—\".repeat(NUMBER_OF_LINES);\n                txt += `\\n📚 Док. № ${doc.id} [${DOC_ID_PREFIX + doc.id}]`;\n                txt += `\\n◽️ Этап № ${st.stageNumber} от ${app.formatDate((st.dateStage ? st.dateStage : st.dateCreation))} [${STAGE_ID_PREFIX}${st.id}]`;\n                txt += `\\n◽️ ${st.stageName}`;\n                if (st.markedForDeletion) txt += '\\n🟥 ЭТАП ПОМЕЧЕН НА УДАЛЕНИЕ.';\n                txt += '\\n' + \"—\".repeat(16);\n                // Вывод суммы.\n\n                //node.warn('Оплаты: ' + stagePayments);\n\n                if (elem.type().groupId == 1) txt += `\\n💵 ${app.formatMonetary(elem.summ)}\\n${\"—\".repeat(16)}`;\n                else txt += `\\n💵 ${app.formatMonetary(st.summ())} / ${app.formatMonetary(stagePayments)}${statusPayStage(st.summ(), stagePayments)}${statusPayPrepaid((prepaid + overpayment) - docPaymentsPrepaid, stageSumm - stagePayments)}\\n${\"—\".repeat(16)}`\n                // Вывод данных\n                txt += `${st.material() ? '\\n▫️ Материал: ' + st.material().name : ''}`;\n                txt += `${st.author() ? '\\n▫️ Автор: ' + st.author().first_name : ''}`;\n                txt += `${st.dateCreation ? '\\n▫️ Дата оформления: ' + app.formatDateAndTime(st.dateCreation) : ''}`;\n                txt += `${st.commentary ? '\\n▫️ Примечание: ' + st.commentary : ''}`;\n                if (elem) {\n                    switch (elem.type().groupId) {\n                        case 1:\n                            txt += `${elem.summ ? '\\n▫️ Сумма: ' + app.formatMonetary(elem.summ) : ''}` + \n                                    `${elem.recipient() ? '\\n▫️ Получатель: ' + elem.recipient().first_name : ''}` + \n                                    `${elem.typePayment ? '\\n▫️ Тип оплаты: ' + elem.typePayment : ''}` + \n                                    '\\n' + \"—\".repeat(16) +\n                                    `${elem.recipient() ? '\\n▫️ Карта: ' + elem.recipient().card() : ''}` + \n                                    `${elem.recipient() ? '\\n▫️ Владелец: ' + elem.recipient().cardOwner() : ''}`;\n                            break;\n                        case 2:\n                        case 3:\n                        case 4:\n                        case 5:\n                        case 6:\n                            txt += `${elem.value ? '\\n▫️ Количество: ' + elem.value + ' м³' : ''}` + \n                                    `${elem.price ? '\\n▫️ Цена за м³ : ' + app.formatMonetary(elem.price) : ''}` +\n                                    `${elem.summ ? '\\n▫️ Сумма: ' + app.formatMonetary(elem.summ) : ''}` +\n                                    `${elem.sender()? '\\n▫️ Контрагент: ' + elem.sender().first_name : ''}` +\n                                    '\\n' + \"—\".repeat(16) +\n                                    `${stageSumm > 0 ? statusDebt(stagePayments - stageSumm) : ''}` +\n                                    `${elem.sender() ? '\\n▫️ Карта: ' + elem.sender().card() : ''}` + \n                                    `${elem.sender() && elem.sender()._cardOwner ? '\\n▫️ Владелец: ' + elem.sender().cardOwner() : ''}`;\n                            break;\n                        default:\n                            break;\n                    }\n                    let i = 1;\n                    const payments = st.payments();\n                    //Вывод оплат.\n                    if (payments.length > 0) {\n                        txt += '\\n' + \"—\".repeat(NUMBER_OF_LINES) + `\\nОплаты:` + '\\n';\n                        //Вывод оплат авансом\n                        txt += payments.filter(item => item.type().groupId == 11).map(item => {\n                            return `${i++}. ${item.typePayment} - ${app.formatMonetary(item.summ)} от ${app.formatDate(item.dateElement)}. (${item.sender().first_name})`;\n                        }).join('\\n');\n\n                        if (payments.filter(item => item.type().groupId == 11).length > 0 && \n                                payments.filter(item => item.type().groupId == 10).length > 0) txt += '\\n' + \"—\".repeat(16) + '\\n';\n                        //Вывод оплат\n                        txt += payments.filter(item => item.type().groupId == 10).map(item => {\n                            return `${i++}. ${item.typePayment} - ${app.formatMonetary(item.summ)} от ${app.formatDate(item.dateElement)}. (${item.sender().first_name})`\n                        }).join('\\n');\n                    }\n                }\n                userKeyboards = keyboards.get(buttons.documents.editStage.name, user.group().id, [\n                    {[buttons.documents.addPaymentAdvance.name]: !(((prepaid + overpayment) - docPaymentsPrepaid) > 0 && (stagePayments - stageSumm) < 0)}\n                ]);\n                if (userKeyboards) user.sendKeyboard(userKeyboards, txt);\n            } catch (error) {user.sendMessage(`Ошибка вывода этапа: \\n${error.message}`)}\n            user.setMode(ID, WAITING_STEP);\n        })(user, user.editableStage, originalMessage.text);\n        break;\n        // Редактирование этапа.\n    case 300:\n            let i2 = 0;\n            let tempArr2 = [];\n            userKeyboards = [];\n            if (user.editableStage.firstElement().type().groupId == 1) {\n                user.setMode(ID, WAITING_STEP);\n                user.sendMessage('Этап аванс не содержит параметр \"Массив\".');\n                return null;\n            }\n            for (const t of documents.materilList) {\n                if (i2 == 0) {\n                    tempArr2 = [];\n                    userKeyboards.push(tempArr2);\n                }\n                tempArr2.push(t.name);\n                i2++;\n                if (i2 > 2) i2 = 0;\n            }\n            userKeyboards.push([buttons.cancellation.name]);\n            txt = 'Выбери массив с помощью кнопок клавиатуры:';\n            user.sendKeyboard(userKeyboards, txt);\n            user.setMode(ID, 301);\n            return null;\n        break;\n    case 301:\n        if (originalMessage.text == buttons.cancellation.name) {\n            user.setMode(ID, WAITING_STEP);\n            originalMessage.text = buttons.documents.changeStage.name;\n            app.switcher(user);\n            return null;\n        }\n        let material = documents.materilList.find(m => m.name == originalMessage.text);\n        if (material) {\n            user.editableStage.materialId = material.id;\n            user.setMode(ID, 320);\n            app.switcher(user);\n        }else{\n            user.sendMessage('Массив ' + originalMessage.text + ' не найден, используй кнопки.');\n        }\n        break;\n    case 302:\n        // Изменение колличества\n        (async function (u, st, el) {\n            if (!el) {\n                u.sendMessage('Ошибка, этап не найден.');\n                user.setMode(ID, WAITING_STEP);\n                return null;\n            }\n            if (el.type().groupId == 1) {\n                u.sendMessage('Нельзя изменить кол-во для этапа \"Аванс\", измени сумму.');\n                user.setMode(ID, WAITING_STEP);\n                return;\n            }\n            if (st.payments().length > 0 && u.groupId != 7) {\n                u.sendMessage('Нельзя менять оплаченый этап.');\n                user.setMode(ID, WAITING_STEP);\n                return;\n            }\n            txt = `Введи новое количество для этапа`;\n            u.sendMessage(txt, true);\n            u.setMode(ID, 303);\n        })(user, user.editableStage, user.editableStage.firstElement());\n        break;\n    case 303:\n        (async function (u, st, el, text) {\n            let tempCount = app.evaluate(text.replace(',', '.'));\n            if (!isNaN(tempCount)) {\n                el.a = Math.abs(tempCount);\n                user.setMode(ID, 320);\n                app.switcher(user);\n            } else {\n                u.sendMessage(`\"${text}\" - не являеться числом.`);\n            }\n        })(user, user.editableStage, user.editableStage.firstElement(), originalMessage.text);\n        break;\n    case 304:\n        //Изменение стоимости\n        (async function (u, st, el) {\n            if (st.payments().length > 0 && u.groupId != 7) {\n                u.sendMessage('Нельзя менять оплаченый этап.');\n                user.setMode(ID, WAITING_STEP);\n                return;\n            }\n            if (el.type().groupId == 1 && (u.groupId != 7 || u.groupId != 5)) {\n                u.sendMessage('Аванс может изменить только плательщик.');\n                user.setMode(ID, WAITING_STEP);\n                return;\n            }\n            if (el.type().groupId == 1) {\n               txt = 'Внеси новую сумму аванса';\n            }else if (el.type().groupId == 6){\n                txt = 'Внеси новую сумму этапа поставки '  + st.stageName;\n            }else{\n                txt = 'Внеси новую цену для этапа ' + st.stageName;\n            }\n            u.sendMessage(txt);\n            u.setMode(ID, 305);\n        })(user, user.editableStage, user.editableStage.firstElement());\n        break;\n    case 305:\n         (async function (u, st, el, text) {\n            let tempCount = app.evaluate(text.replace(',', '.'));\n            if (!isNaN(tempCount)) {\n                el.price = Math.abs(tempCount);\n                user.setMode(ID, 320);\n                app.switcher(user);\n            } else {\n                u.sendMessage(`\"${text}\" - не являеться числом.`);\n            }\n        })(user, user.editableStage, user.editableStage.firstElement(), originalMessage.text);\n        break;\n    case 306:\n        (async function (us, st, el, text) {\n            let i = 0;\n            let tempArr = [];\n            userKeyboards = [];\n            // **************************************************************************\n            // Формирование кнопок.\n            for (const u of users.userList.filter(u => u.group().id == 4)) {\n                if (i == 0) {\n                    tempArr = [];\n                    userKeyboards.push(tempArr);\n                }\n                tempArr.push(u.first_name);\n                i++;\n                if (i > 2) i = 0;\n            }\n            // **************************************************************************\n            switch (el.type().groupId) {\n                case 1:\n                    txt = 'Выбери нового получателя аванса:' + '\\n' + \"—\".repeat(NUMBER_OF_LINES) +\n                          '\\n' + users.userList.filter(u => u.group().id == 4)\n                          .map(u => {return i++ + '. [/agent' + u.id + '] ' + u.first_name})\n                          .join('\\n' + \"—\".repeat(16) + '\\n');\n                    break;\n                case 2:\n                case 3:\n                case 4:\n                case 5:\n                case 6:\n                    txt = 'Выбери нового контрагента из списка:' + '\\n' + \"—\".repeat(NUMBER_OF_LINES) +\n                        '\\n' + users.userList.filter(u => u.group().id == 4)\n                            .map(u => {return i++ + '. [/agent' + u.id + '] ' + u.first_name}).join('\\n' + \"—\".repeat(16) + '\\n');\n                    tempArr.push(buttons.users.meCounterparty.name);\n                    break;\n                case 10:\n                    break\n                default:\n                    break;\n            }\n            userKeyboards.push([buttons.cancellation.name]);\n            us.sendKeyboard(userKeyboards, txt);\n            user.setMode(ID, 307);\n        })(user, user.editableStage, user.editableStage.firstElement(), originalMessage.text);\n        break;\n    case 307:\n        (async function (u, st, el, text) {\n            tempData = {};\n            if (text == buttons.cancellation.name) {\n                u.setMode(ID, WAITING_STEP);\n                originalMessage.text = buttons.documents.changeStage.name;\n                app.switcher(u);\n                return;\n            }\n            if (text.match(/\\/agent/)) {\n                let [command, id] = text.split(/\\/agent/);\n                tempData =  users.userList.find(us => us.id == id);\n            }else{\n                if (text == buttons.users.meCounterparty.name) {\n                    tempData =  u;\n                } else {\n                    tempData =  users.userList.find(us => us.first_name == text);\n                } \n            }\n            \n            if (!tempData) {\n                u.sendMessage('Контрагент не найден.');\n                u.setMode(ID, WAITING_STEP);\n                return;\n            }\n            switch (el.type().groupId) {\n                case 1:\n                    el.recipientId = tempData.id;\n                    break;\n                case 2:\n                case 3:\n                case 4:\n                case 5:\n                case 6:\n                    el.senderId = tempData.id;\n                    break;\n                case 10:\n                    break\n                default:\n                    break;\n            }\n            u.setMode(ID, 320);\n            app.switcher(u);\n        })(user, user.editableStage, user.editableStage.firstElement(), originalMessage.text);\n        break;\n    case 320:\n        //Сохранение этапа.\n        (async function (u, st, el) {\n            try {\n                txt = '';\n                if (st) {\n                        try {let rSt = await st.save(u);} catch (error) {\n                            st.reload();\n                            txt += 'Возникли ошибки при сохранении этапа.\\n';\n                        }\n                    }\n                if (el) {\n                   try {let rEl = await el.save(u);} \n                   catch (error) {txt += 'Возникли ошибки при сохранении элемента.';} \n                }\n                userKeyboards = keyboards.get(buttons.documents.changeStage.name, user.group().id);\n                if (userKeyboards) u.sendKeyboard(userKeyboards, 'Изменения сохранены.');\n            } catch (error) {\n                node.error(error);\n                u.sendMessage('Ошибка сохранения.');\n            }\n        })(user, user.editableStage, user.editableStage.firstElement());\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 1000:\n        switch (originalMessage.text) {\n            case buttons.documents.changeStage.name:\n                userKeyboards = keyboards.get(buttons.documents.changeStage.name, user.group().id);\n                if (userKeyboards) user.sendKeyboard(userKeyboards, 'Воспользуйся меню для изменения этапа.');\n                break;\n            case buttons.documents.backToStage.name:\n                user.setMode(ID, 200);\n                app.switcher(user);\n                break;\n            case buttons.documents.changeStageMassiv.name:\n                user.setMode(ID, 300);\n                app.switcher(user);\n                break;\n            case buttons.documents.changeStageValue.name:\n                user.setMode(ID, 302);\n                app.switcher(user);\n                break;\n            case buttons.documents.changeStagePrice.name:\n                user.setMode(ID, 304);\n                app.switcher(user);\n                break;\n            case buttons.documents.changeStageСounterparty.name:\n                user.setMode(ID, 306);\n                app.switcher(user);\n                break;\n            case buttons.test.name:\n                // Тест\n                user.setMode(ID, 10);\n                app.switcher(user);\n                break;\n                //addPaymentAdvance\n            case buttons.documents.addPayment.name:\n                user.setMode(ID, 70);\n                app.switcher(user);\n                break;\n            case buttons.documents.addPaymentAdvance.name:\n                user.setMode(ID, 67);\n                app.switcher(user);\n                break;\n            case buttons.documents.deletePayment.name:\n                user.setMode(ID, 76);\n                app.switcher(user);\n                break;\n            case buttons.documents.addStage.name:\n                user.setMode(ID, 30);\n                app.switcher(user);\n                break;\n            case buttons.documents.deleteDocument.name:\n                user.setMode(ID, 80);\n                app.switcher(user);\n                break;\n            case buttons.documents.deleteStage.name:\n                user.setMode(ID, 85);\n                app.switcher(user);\n                break;\n            case buttons.documents.makeAnAdvance.name:\n                tempData = documents.typeElementList.find(item => item.id == 6);\n                if (tempData) {\n                    originalMessage.text = tempData.name;\n                    user.setMode(ID, 31);\n                    app.switcher(user);\n                }\n                break;\n            case buttons.documents.closeDocument.name:\n                if (user.editableDocument) {\n                    (async function (doc) {\n                        try {\n                            if (user.editableDocument.statusId == 2) {\n                                user.sendMessage('Документ уже закрыт.');\n                                user.setMode(ID, WAITING_STEP);\n                                return null;\n                            }\n                            let query = `select \n                            S.ID as ID_STAGE, \n                            L.ID as ID_ELEMENT,\n                            (L.RESULT_SUM * T.MODIFER) as RESULT, \n                            TL.ELEMENT_GROUP, \n                            T.ID_BILLING_ACCOUNT, \n                            T.MODIFER\n                                from TG_STAGE_ELEMENTS L\n                                left join TG_TYPE_ELEMENT TL on (L.TYPE_ELEMENT_ID = TL.ID)\n                                left join TG_TRANSACTIONS T on (T.ID_STAGE_ELEMENT = L.ID)\n                                left join TG_STAGES S on (L.ID_STAGE = S.ID)\n                                where \n                                (s.isdeleted is null or (s.isdeleted = 0)) and\n                                S.DOCUMENT_ID = ${doc.id}`\n                            let queryObject = await app.db.executeRequest(user, 'cubic', query);\n                            let dataArr = queryObject.result;\n                            let balanceOfReceipts = dataArr.filter(item => {\n                                return ((item.ELEMENT_GROUP == 1 || item.ELEMENT_GROUP == 10) && item.MODIFER == -1);\n                            })\n                            .reduce((total, item) => total + (item.RESULT ? item.RESULT : 0), 0);\n                            let balanceOfSenders = dataArr.filter(item => {\n                                return ((item.ELEMENT_GROUP >= 2 && item.ELEMENT_GROUP <= 6) && item.MODIFER == 1);\n                            })\n                            .reduce((total, item) => total + (item.RESULT ? item.RESULT : 0), 0);\n                            if (Math.abs(balanceOfReceipts + balanceOfSenders) > 100) {\n                                txt = 'В документе есть неоплаченые этапы или незакрытый аванс.'\n                                user.sendMessage(txt);\n                                \n                            }else{\n                                user.editableDocument.statusId = 2;\n                                user.editableDocument.save(user, (err, stage) => {\n                                    if (err){\n                                        user.sendMessage('Во время изменения статуса заказа, произошла ошибка.'); \n                                        return;\n                                    }\n                                    user.sendMessage('Документ закрыт.'); \n                                });\n                            }\n                        } catch (error) {\n                            user.sendMessage('Ошибка при закрытии документа.');\n                        }\n                    })(user.editableDocument);\n                }else{\n                    user.sendMessage('Документ не найден.');\n                    user.setMode(0, 1);\n                    app.switcher(user);\n                }\n                break;\n            case buttons.documents.backToOrder.name:\n                if (user.editableDocument) {\n                    user.setMode(ID, 100);\n                    app.switcher(user);\n                }else{\n                    if (user.editableStage) {\n                        user.editableDocument = user.editableStage.document()\n                        user.setMode(ID, 100);\n                        app.switcher(user);\n                    }else{\n                        user.sendMessage('Документ не найден.');\n                        user.setMode(0, 1);\n                        app.switcher(user);\n                    }\n                }\n                break;\n            default:\n                break;\n        }\n        break;\n    default:\n        break;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 520,
        "wires": [
            [
                "eb3df53d.c859a8"
            ]
        ]
    },
    {
        "id": "ee88a1c8.3dd8d",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Step 3",
        "func": "let ID = 3;\nlet WAITING_STEP = 1000;\nlet NUMBER_OF_LINES = 22;\n\nlet USER_ID_PREFIX = '/user';\nlet DOC_ID_PREFIX = '/doc'; \nlet STAGE_ID_PREFIX = '/stg'; \nlet ORDER_ID_PREFIX = '/id';\nlet PROF_INDEX_PREFIX = '/pship'\n\nlet app = msg.app;\nlet errorsBank  = app.errorsBank;\nlet originalMessage = msg.originalMessage;\n\nlet user = app.user;\nlet users = app.users;\nlet documents = app.documents;\nlet db = app.db;\n\nlet buttons = app.buttons;\nlet keyboards = app.keyboards;\n\nlet userKeyboards = undefined;\nlet tempData;\nlet txt = '';\n//Функция конструктор запросов по заказам\nlet queryGetOrder = (extrQ) => {return `select DISTINCT O.ID, O.ITM_ORDERNUM, O.ORDERNUM, O.ORDER_TYPE, O.MANAGER, C.CLIENTNAME, C.CITY, C.PRICE_COLUMN,\n                                            O.FASAD_MAT, O.FASAD_MODEL, O.COLOR, O.ORDER_TOTAL_COST, O.ORDER_COST, O.ORDER_PAY,\n                                            (O.ORDER_TOTAL_COST - coalesce(O.ORDER_PAY, 0)) * -1 as ORDER_DEBT, ORDER_GENERALSQ,\n                                            O.FACT_DATE_FIRSTSAVE, O.PLAN_DATE_FIRSTSTAGE, O.PLAN_DATE_PACK, O.FACT_DATE_ORDER_OUT,\n                                            LIST_STATUSES.STATUS_DESCRIPTION, LIST_STATUSES.STATUS_NUM, O.FACT_DATE_FIRSTSAVE, C.IS_PREPAID,\n                                            O.COLOR_TYPE, O.COLOR_PATINA, O.PRIMECH\n                                    from ORDERS O\n                                    left join CLIENTS C on O.CLIENT = C.CLIENTNAME\n                                    left join LIST_STATUSES on LIST_STATUSES.STATUS_NUM = O.ORDER_STATUS\n                                    where O.ORDER_STATUS > -3 ${extrQ ? 'and ' + extrQ : ''}\n                                    order by O.ID desc;`;}\nlet queryGetOrderToElement = (extrQ) => {\n    return `select distinct O.ID, O.ITM_ORDERNUM, O.ORDERNUM, O.ORDER_TYPE, O.MANAGER, C.CLIENTNAME, C.CITY, C.PRICE_COLUMN,\n                O.FASAD_MAT, O.FASAD_MODEL, O.COLOR, O.ORDER_TOTAL_COST, O.ORDER_COST, O.ORDER_PAY,\n                (O.ORDER_TOTAL_COST - coalesce(O.ORDER_PAY, 0)) * -1 as ORDER_DEBT, ORDER_GENERALSQ,\n                O.FACT_DATE_FIRSTSAVE, O.PLAN_DATE_FIRSTSTAGE, O.PLAN_DATE_PACK, O.FACT_DATE_ORDER_OUT,\n                LIST_STATUSES.STATUS_DESCRIPTION, LIST_STATUSES.STATUS_NUM, O.FACT_DATE_FIRSTSAVE, C.IS_PREPAID,\n                O.COLOR_TYPE, O.COLOR_PATINA, O.PRIMECH  \n        from ORDERS O\n        left join CLIENTS C on O.CLIENT = C.CLIENTNAME\n        left join LIST_STATUSES on LIST_STATUSES.STATUS_NUM = O.ORDER_STATUS\n        left join ORDERS_ELEMENTS L on (L.ORDER_ID = O.ID)\n        where O.ORDER_STATUS > -3 ${extrQ ? 'and ' + extrQ : ''}\n        order by O.ID desc;`;\n}\n\nlet formatNameElements = (nameElement, abbrev = false) => {\n    if (!nameElement) return '';\n    nameElement = nameElement.replace(new RegExp('>', 'g'), '&gt');\n    nameElement = nameElement.replace(new RegExp('<', 'g'), '&lt');\n    if (abbrev) {\n        nameElement = nameElement.replace(new RegExp('Фасад', 'g'), '');\n        nameElement = nameElement.replace(new RegExp('решеткой', 'g'), 'реш.');\n        nameElement = nameElement.replace(new RegExp('решетка', 'g'), 'реш.');\n        nameElement = nameElement.replace(new RegExp('Профиль', 'g'), 'проф.');\n        nameElement = nameElement.replace(new RegExp('диагональной', 'g'), 'диаг.');\n        nameElement = nameElement.replace(new RegExp('Дополнительные', 'g'), 'доп.');\n        nameElement = nameElement.replace(new RegExp('комбинированный', 'g'), 'комб.');\n        nameElement = nameElement.replace(new RegExp('балясинами', 'g'), 'бал.');\n        nameElement = nameElement.replace(new RegExp('фрезеровкой', 'g'), 'фрез.');\n        nameElement = nameElement.replace(new RegExp('фрезеровки', 'g'), 'фрез.');\n        nameElement = nameElement.replace(new RegExp('вогнутый', 'g'), 'вогн.');\n    }\n    nameElement = nameElement.trim();\n    try {nameElement = nameElement[0].toUpperCase() + nameElement.slice(1);} catch (error) {return nameElement;}\n    return nameElement;\n}\n\napp.users.openUser(originalMessage.text, (err, u) => {\n    if (u) {\n        user.editableUser = undefined;\n        user.editableUser = u;\n        user.setMode(1, 100);\n        originalMessage.text = '';\n        app.switcher(user);\n    }else{\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openDoc(originalMessage.text, (err, d) => {\n    if (d) {\n        user.setMode(2, 100);\n        originalMessage.text = '';\n        user.editableDocument = undefined;\n        user.editableDocument = d;\n        app.switcher(user);\n    }else{\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openStage(originalMessage.text, (err, s) => {\n    if (s) {\n        user.editableStage = undefined;\n        user.editableStage = s;\n        user.setMode(2, 200);\n        originalMessage.text = '';\n        app.switcher(user);\n    } else {\n        if (err) {\n            user.sendMessage(err + ' Ошибка [311]');\n            originalMessage.text = '';\n        }\n    }\n\n});\n\nswitch (originalMessage.text) {\n    case buttons.comeBackMenu.name:\n        // Кнопка \"Назад\".\n        let mode = user.getLastKeyPoint();\n        user.mode = mode;\n        originalMessage.text = mode.msg;\n        app.switcher(user);\n        return null;\n        break;\n    case buttons.homeMenu.name:\n        // Кнопка \"Главное меню\".\n        user.reset();\n        originalMessage.text = '';\n        app.switcher(user);\n        return null;\n        break;\n    default:\n        break;\n}\n\nif (originalMessage.text.match(ORDER_ID_PREFIX)) {\n    let [command, id] = originalMessage.text.split(ORDER_ID_PREFIX);\n    originalMessage.text = id;\n    user.setMode(3, 21);\n}\n\nif (originalMessage.text.match(PROF_INDEX_PREFIX)) {\n    let [command, id] = originalMessage.text.split(PROF_INDEX_PREFIX);\n    originalMessage.text = id;\n    user.setMode(3, 41);\n}\n\nswitch (user.mode.step) {\n    case 0:\n        break;\n    case 1:\n        break;\n    case 2:\n        break;\n    case 3:\n        break;\n    case 4:\n        break;\n    case 5:\n        break;\n    case 6:\n        break;\n    case 7:\n        // Контроль ошибок.  \n        userKeyboards = keyboards.get(buttons.orders.errorsOrders.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards, \n                buttons.homeMenu.name + ' > ' + \n                buttons.menu.orders.name + ' > ' + \n                buttons.orders.errorsOrders.name);\n        user.setMode(ID, WAITING_STEP, true, originalMessage.text);\n        break;\n    case 8:\n        break;\n    case 9:\n        break;\n    case 10:\n        break;\n    case 20:\n        txt = 'Введи ID заказа:';\n        user.sendMessage(txt, true);\n        user.setMode(ID, 21);\n        break;\n    case 21: \n        if (!isNaN(originalMessage.text)) {\n            user.sendMessage(`Открываю заказ ID ${originalMessage.text}...`, false, (content, messageId) => {\n                (async function (orderId, u, msgId) {\n                    let query;\n                    let order = {};\n                    order.id = orderId;\n                    try {\n                        query = `select * from ORDERS O left join LIST_STATUSES S on (S.STATUS_NUM = O.ORDER_STATUS) where O.ID = ${orderId}`;\n                        tempData = (await app.db.executeRequest(u, 'itm', query)).result;\n                        if (tempData && tempData.length > 0) {\n                            let orderDataTitle = tempData[0];\n                            query =`select * from ORDERS_ELEMENTS L where L.ORDER_ID = ${orderId}`;\n                            let orderDataElements = (await app.db.executeRequest(u, 'itm', query)).result;\n                            query =`select * from orders_date_plan p where p.order_id = ${orderId} order by p.date3, p.id`;\n                            let orderDataPlans = (await app.db.executeRequest(u, 'itm', query)).result;\n                            query =`select O.ID,\n                                        JS.DATE_GEN_ORDER_END as SHLIF_DATE, JS.FREEZE_FLAG as SHLIF_FREEZE_FLAG, JS.comment as SHLIF_COMMENT,\n                                        JL.lack_date as LACK_DATE, jl.freeze_flag as LACK_FREEZE_FLAG, JL.COMMENT as LACK_COMMENT,\n                                        JU.date_pack as UPACK_DATE, JO.pack_type, JO.fact_date_out\n                                        from ORDERS O\n                                        left join JOURNAL_LACK JL on (JL.ORDER_ID = O.ID)\n                                        left join JOURNAL_SHLIF JS on (JS.ORDER_ID = O.ID)\n                                        left join JOURNAL_UPACK JU on (JU.ORDER_ID = O.ID)\n                                        left join JOURNAL_OUT JO on (JO.ORDER_ID = O.ID)\n                                        where O.ID = ${orderId}`;\n                            let orderDataExecutionPlan = (await app.db.executeRequest(u, 'itm', query)).result[0];\n                            query =`select first 10 S.MANAGER, S.DESCRIPTION from ORDER_STATUSES S where S.ORDER_ID = ${orderId} order by S.TIME_STAMP desc`;\n                            let RecentActionsWithOrder = (await app.db.executeRequest(u, 'itm', query)).result;\n    \n                            order.orderDataTitle = orderDataTitle; \n                            order.orderDataElements = orderDataElements;\n                            order.orderDataPlans = orderDataPlans;\n                            order.orderDataExecutionPlan = orderDataExecutionPlan;\n                            order.RecentActionsWithOrder = RecentActionsWithOrder; \n    \n                            order.expandDataTitle = true;\n                            order.expandExtraDataTitle = false;\n                            order.expandElementList = false;\n                            order.expandPlan = false;\n                            order.expandShowSumElement = false;\n                            order.expandShowSumOrder = false;\n                            order.expandExecutionPlan = false;\n                            order.expandActionsWithOrder = false;\n                            order.trimNameElement = true;\n                            \n                            u.temporaryData.order = order;\n                            u.temporaryData.messageId = msgId;\n                            u.setMode(ID, 23);\n                            app.switcher(u);\n                        }else{user.sendMessage(`Заказ с ID ${orderId} не найден в базе данных.`);}\n                    } catch (error) {\n                        user.sendMessage('Ошибка выполнения запроса, возможно база данных не доступна.'); \n                        node.error(error); \n                    }\n                })(originalMessage.text, user, messageId);\n            });\n        }else{\n            user.sendMessage('Не корректный ID заказа.');\n        }\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 23:\n        /**\n             *  O.ID, O.MANAGER, O.CLIENT, O.ORDERNUM, O.ITM_ORDERNUM, O.FASAD_MAT, O.FASAD_MODEL, O.FASAD_PG_WIDTH, O.TEXTURE,\n                O.FIL_MAT, O.FIL_MODEL, O.COLOR, O.FIL_COLOR, O.COLOR_TYPE, O.COLOR_LAK, O.COLOR_PATINA, O.ORDER_GENERALSQ,\n                O.ORDER_FASADSQ, O.GLASS, O.PRIMECH, O.ORDER_COST_PRICECOLUMN, O.ORDER_COST, O.ORDER_PAY, O.ORDER_TOTAL_COST,\n                O.ORDER_DISCOUNT, O.ORDER_DISCOUNT_COMMENT, O.ORDER_COSTUP, O.ORDER_COSTUP_COMMENT, O.ORDER_COST_PACK,\n                O.ORDER_COST_GLASS, O.FACT_DATE_RECEIVE, O.FACT_DATE_FIRSTSAVE, O.FACT_DATE_LASTSAVE, O.FACT_DATE_CALCCOST,\n                O.FACT_DATE_PACK, O.FACT_DATE_ORDER_OUT, O.ORDER_TYPE, O.TEXTURE_COMMENT, O.COLOR_LAK_COMMENT,\n                O.COLOR_PATINA_COMMENT, O.ORDER_STATUS, O.ASSEMBLY_ANGLE, O.TERMOSHOV, O.PLAN_DATE_PACK, O.PLAN_DATE_FIRSTSTAGE,\n                O.PRISAD, S.STATUS_DESCRIPTION\n             */\n        (async function (u, order) {\n            let massageMax = 3500; // Максимальное кол-во символов в одном сообщении.\n            let listUsersWithAccessSum = [6, 7]; // Список пользователй с доспупом к суммам\n            let massageArr = [];\n            let tempInlineArr = [];\n            let inlineKeyboard = [];\n            \n            let tempArr = [];\n            let text =``;\n            let formatElementParams = (h, w, a) => {\n                let t ='';\n                if (h) t += ` ${h}`;\n                if (w && t == '') t += `${w}`;\n                if (w && t != '') t += ` x ${w}`;\n                t += ` - ${a}`;\n                return t;\n            }\n            let getIcoStatus = (currentItem, planArr, executeData) => {\n\n            }\n            if (order && order.orderDataTitle) {\n                try {\n                    let orderDataElements = order.orderDataElements\n                    let orderDataPlans = order.orderDataPlans;\n                    \n                    text += `🆔 ${order.orderDataTitle.ITM_ORDERNUM}`;\n                    text += `\\n⚛️ <code>${order.orderDataTitle.STATUS_DESCRIPTION}</code>`;\n                    text += `\\n🚻 <b>${order.orderDataTitle.CLIENT}</b>`;\n                    \n                    text += '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n                    //text += `\\n${(order.expandDataTitle ? '➖ <u>Свернуть шапку</u> [/otcoll]' : '➕ <u>Развернуть шапку</u> [/otexp]')}`;\n                    tempInlineArr.push({\"text\":(order.expandDataTitle ? '➖Шапка' : '➕Шапка'), \"callback_data\": (order.expandDataTitle ? '/otcoll' : '/otexp')});\n\n                    if (order.expandDataTitle) {\n                        text += (order.orderDataTitle.MANAGER ? '\\n🔹 Менеджер: <i>' + order.orderDataTitle.MANAGER + '</i>' : '') +\n                                (order.orderDataTitle.ORDER_TYPE ? '\\n🔹 Тип заказа: <i>' + order.orderDataTitle.ORDER_TYPE + '</i>' : '') +\n                                (order.orderDataTitle.FASAD_MAT ? '\\n🔹 Материал: <i>' + order.orderDataTitle.FASAD_MAT + '</i>' : '') +\n                                (order.orderDataTitle.FASAD_MODEL ? '\\n🔹 Фасад: <i>' + order.orderDataTitle.FASAD_MODEL + (order.orderDataTitle.FASAD_PG_WIDTH ? ' (W: ' + order.orderDataTitle.FASAD_PG_WIDTH + ' мм.)': '') + '</i>' : '') +\n                                (order.orderDataTitle.FIL_MODEL ? '\\n🔹 Филёнка: <i>' + order.orderDataTitle.FIL_MODEL + (order.orderDataTitle.FIL_MAT ? ' (' + order.orderDataTitle.FIL_MAT + ')' : '') + '</i>' : '') +\n                                (order.orderDataTitle.TEXTURE ? '\\n🔹 Текстура: <i>' + order.orderDataTitle.TEXTURE + (order.orderDataTitle.TEXTURE_COMMENT ? ' (' + order.orderDataTitle.TEXTURE_COMMENT + ')' : '') + '</i>' : '') +\n                                (order.orderDataTitle.COLOR ? '\\n🔹 Цвет: <i>' + order.orderDataTitle.COLOR + '</i>' : '') +\n                                (order.orderDataTitle.COLOR_PATINA ? '\\n🔹 Патина: <i>' + order.orderDataTitle.COLOR_PATINA + (order.orderDataTitle.COLOR_PATINA_COMMENT ? ' (' + order.orderDataTitle.COLOR_PATINA_COMMENT + ')' : '') + '</i>' : '') +\n                                (order.orderDataTitle.COLOR_LAK ? '\\n🔹 Лак: <i>' + order.orderDataTitle.COLOR_LAK + (order.orderDataTitle.COLOR_LAK_COMMENT ? ' (' + order.orderDataTitle.COLOR_LAK_COMMENT + ')' : '') + '</i>' : '') +\n                                (order.orderDataTitle.TERMOSHOV ? '\\n🔹 Термошов: <i>' + order.orderDataTitle.TERMOSHOV + '</i>' : '') +\n                                (order.orderDataTitle.PRISAD ? '\\n🔹 Присадка: <i>' + order.orderDataTitle.PRISAD + '</i>' : '');\n\n                        //text += `\\n${(order.expandExtraDataTitle ? '➖ <u>Скрыть доп. парам.</u> [/otecoll]' : '➕ <u>Показать доп. парам.</u> [/oteexp]')}`;\n\n                        if (order.expandExtraDataTitle) {\n                            //Если есть доступ, то показываем суммы\n                            if (listUsersWithAccessSum.find(item => item == u.groupId) && user.chatId !== 111 ) {\n                                text += (order.orderDataTitle.ORDER_COST ? '\\n💰 ' + app.formatMonetary(order.orderDataTitle.ORDER_TOTAL_COST) + \n                                        ' / ' + (order.orderDataTitle.ORDER_PAY ? app.formatMonetary(order.orderDataTitle.ORDER_PAY) : app.formatMonetary(0)) : '');\n                            }\n                            text += (order.orderDataTitle.ORDER_GENERALSQ ? '\\n▪️ S: <code>' + order.orderDataTitle.ORDER_GENERALSQ.toFixed(3) + '</code>  м. кв.' : '\\n0.000 м.кв.') +\n                                    (order.orderDataTitle.ORDER_FASADSQ ? ' / S фас: <code>' + order.orderDataTitle.ORDER_FASADSQ.toFixed(3) + '</code>' : '0.000 м. кв.') +  \n                                    (order.orderDataTitle.FACT_DATE_FIRSTSAVE ? '\\n📆 Создан: ' + app.formatDate(app.stringToDate(order.orderDataTitle.FACT_DATE_FIRSTSAVE.substr(0, 10))) : '') +    \n                                    (order.orderDataTitle.FACT_DATE_CALCCOST ? '\\n📆 Посчитан: ' + app.formatDate(app.stringToDate(order.orderDataTitle.FACT_DATE_CALCCOST.substr(0, 10))) : '') +  \n                                    (order.orderDataTitle.FACT_DATE_LASTSAVE ? '\\n📆 Изменен: ' + app.formatDate(app.stringToDate(order.orderDataTitle.FACT_DATE_LASTSAVE.substr(0, 10))) : '');  \n                        }else{text += '\\nДоп. парам. скрыты...';}\n                    }else{text += '\\nШапка скрыта...';}\n                    // Вывод элементов заказа\n                    text += '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n                    //text += `\\n${(order.expandElementList ? '➖ <u>Скрыть список</u> [/olcoll]' : '➕ <u>Показать список</u> [/olexp]')}`;\n                    tempInlineArr.push({\"text\":(order.expandElementList ? '➖Список' : '➕Список'), \"callback_data\": (order.expandElementList ? '/olcoll' : '/olexp')});\n                    if (order.expandElementList) {\n                        //text += `\\n${(order.trimNameElement ? '<u>Полные названия</u> [/olfn]' : '<u>Сокращенные названия</u> [/olan]')}`;\n                        tempArr =  orderDataElements.map((item, index) => {\n                            let t = `${index + 1}. <b>${formatNameElements(item.NAME, order.trimNameElement)}${formatElementParams(item.HEIGHT, item.WIDTH, item.EL_COUNT)}</b>`;\n                            if (!order.trimNameElement) t += (item.SQUARE ? ' (' + item.SQUARE.toFixed(3) + ')': '')\n                            return t;\n                        });\n                        for (const iterator of tempArr) {\n                            if (text.length >= massageMax) {\n                                massageArr.push(text);\n                                text = '';\n                            }\n                            text += `\\n${iterator}`;\n                        }\n                    } else {text += `\\nСписок. Скрыто элементов: ${orderDataElements.length}`;}\n                    if (orderDataPlans && orderDataPlans.length > 0) {\n                        text += '\\n' + \"—\".repeat(NUMBER_OF_LINES);\n                        //text += `\\n${(order.expandPlan ? '➖ <u>Скрыть планы</u> [/opcoll]' : '➕ <u>Показать планы</u> [/opexp]')}`;\n                        tempInlineArr.push({\"text\":(order.expandPlan ? '➖Планы' : '➕Планы'), \"callback_data\": (order.expandPlan ? '/opcoll' : '/opexp')});\n                        if (order.expandPlan) {\n                            tempArr = orderDataPlans.map((item, index) => {\n                                let t = `[${index + 1}] ${item.DATE_SECTOR}: ${app.formatDate(item.DATE3)}`;\n                                return t;\n                            });\n                            for (const iterator of tempArr) {\n                                if (text.length >= massageMax) {\n                                    massageArr.push(text);\n                                    text = '';\n                                }\n                                text += `\\n${iterator}`;\n                            }\n                        } else {text += `\\nПланы. Скрыто элементов: ${orderDataPlans.length}`;}\n                    }\n                    //u.sendMessage(text);\n                    inlineKeyboard.push(tempInlineArr);\n                    tempInlineArr = [];\n                    if (order.expandDataTitle)  tempInlineArr.push({\"text\":(order.expandExtraDataTitle ? '➖Доп. парам' : '➕Доп. парам'), \"callback_data\": (order.expandExtraDataTitle ? '/otecoll' : '/oteexp')});\n                    if (order.expandElementList) tempInlineArr.push({\"text\": (order.trimNameElement ? 'Полные названия' : 'Сокращенные названия'), \"callback_data\": (order.trimNameElement ? '/olfn' : '/olan')});\n\n                    inlineKeyboard.push(tempInlineArr);\n                    if (user.temporaryData.ordersArr.length > 1) {\n                        inlineKeyboard.push([{\n                            \"text\": \"⬅️ К списку.\",\n                            \"callback_data\": \"/backtolist\"\n                        }]);\n                    }\n                    if (u.temporaryData.messageId) {\n                        app.msgBank.editMessage(u, text, false, u.temporaryData.messageId, inlineKeyboard);\n                        \n                    }else{\n                        u.sendMessage(text);\n                    }\n                } catch (error) {\n                    node.error(error);\n                    u.sendMessage(`Не удалось отобразить данные по заказу ID ${order.id}.`);\n                }\n            }else{\n                u.sendMessage(`Не удалось открыть заказ...`);\n            }\n        })(user, user.temporaryData.order, originalMessage);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 30:\n        \n        txt = 'Введи номер заказа:';\n        user.sendMessage(txt, true);\n        user.setMode(ID, 31);\n        break;\n    case 31:\n        if (!isNaN(originalMessage.text)) {\n            (async function () {\n                let query = `select O.ID, O.MANAGER, O.CLIENT, O.ORDERNUM, O.ORDER_TYPE, L.STATUS_DESCRIPTION\n                from ORDERS O\n                left join LIST_STATUSES L on (O.ORDER_STATUS = L.STATUS_NUM)\n                where O.ID = ${originalMessage.text}`;\n                try {\n                    let queryObject = await app.db.executeRequest(user, 'itm', query);\n                    tempData = queryObject.result[0];\n                    txt = 'Заказ №: ' + '<code>' + tempData.ID + ' ' + tempData.CLIENT + ' ' + tempData.ORDERNUM + '</code>' +\n                        '\\nСтатус: ' + tempData.STATUS_DESCRIPTION + \n                        '\\nТип заказа: ' + tempData.ORDER_TYPE + \n                        '\\nМенеджер: ' + tempData.MANAGER;\n                    txt += '\\n' + \"—\".repeat(16);\n                    txt += '\\nВведите текст ошибки (не более 128 символов):';\n                    user.tempData = tempData;\n                    user.sendMessage(txt, true);\n                    user.setMode(ID, 32);\n                } catch(err) {\n                    node.error(err);\n                    user.sendMessage('Не существует заказа с ID или база данных не доступна.', true);\n                    user.setMode(0, 0);\n                    app.switcher(user);\n                }\n            })();\n        }else{\n            user.sendMessage('Не корректный номер заказа, введи ID (число)', true);\n        }\n        break;\n    case 32:\n        if (user.tempData) {\n            tempData = user.tempData;\n            user.tempData = undefined;\n            txt = 'Менеджер ' + tempData.MANAGER + ' будет отшлепан(а), по причине: ' + \n            originalMessage.text;\n            user.sendMessage(txt);\n            user.setMode(0, 0);\n            app.switcher(user);\n        }\n        break;\n    case 40:\n        (async function (u) {\n            try {\n                if (u.temporaryData.profileArr && u.temporaryData.profileArr.length > 0) {\n                    let profileArrPosition = u.temporaryData.profileArrPosition;\n                    let countProfileMax = u.temporaryData.countProfileMax;\n                    let allCount = u.temporaryData.profileArr.length;\n                    let arr = u.temporaryData.profileArr.slice(profileArrPosition, profileArrPosition + countProfileMax);\n                    if (arr.length > 0) {\n                        txt = `Показаны ${allCount >= (profileArrPosition + countProfileMax) ? (profileArrPosition + countProfileMax) : allCount} из ${allCount} отправок:`;\n                        txt += '\\n\\n' + arr.map((item, i) => {\n                            return '<i>' + (i + profileArrPosition + 1) + '</i>' + ') ' + app.formatDate(item.FACT_DATE_OUT) + \n                                ' открыть [' + PROF_INDEX_PREFIX + (u.temporaryData.profileArr.findIndex((it1) => {return it1.FACT_DATE_OUT == item.FACT_DATE_OUT && it1.DRIVER_NAME == item.DRIVER_NAME}) ) + ']' +\n                                '\\nводитель ' + item.DRIVER_NAME +\n                                ' ' + item.BOX + ' уп. на сумму ' + app.formatMonetary(item.AMOUNT); \n                        }).join('\\n\\n');\n\n                        if (allCount - (profileArrPosition + countProfileMax) > 0) {\n                            txt += '\\n' + \"—\".repeat(NUMBER_OF_LINES) + '\\nСледующая стр. [/nextp]';\n                        }\n                    }else{\n                        txt = 'Нет данных, конец списка.'\n                    }\n                }else{\n                    txt = 'Нет данных.'\n                }\n                u.sendMessage(txt);\n            } catch (error) {\n                node.error();\n                u.sendMessage('Ошибка отображения поставки');\n                u.setMode(ID, WAITING_STEP);\n            }\n        })(user);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 41:\n        (async function (index, u) {\n            if (u.temporaryData.profileArr && u.temporaryData.profileArr.length > 0) {\n                let shipment = u.temporaryData.profileArr[index];\n                let profiler = '!= 1';\n                if (u.temporaryData.shipmentType == buttons.shipments.shipmentsProfile.name) profiler = '= 1';\n                if (shipment) {\n                    try {\n                        let query = `select O.ID,\n                                    C.CLIENTNAME,\n                                    J.BOX_COUNT,\n                                    o.order_total_cost as AMOUNT\n                                from ORDERS_ELEMENTS E\n                                left join ORDERS O on (E.ORDER_ID = O.ID)\n                                left join JOURNAL_OUT J on (J.ORDER_ID = O.ID)\n                                left join CLIENTS C on (O.CLIENT = C.CLIENTNAME)\n                                where C.PROFILER ${profiler} and\n                                    upper(J.DRIVER_NAME) = '${shipment.DRIVER_NAME.toUpperCase()}' and\n                                    J.FACT_DATE_OUT = '${app.formatDateToDb(shipment.FACT_DATE_OUT)}'\n                                group by O.ID, o.order_total_cost, C.CLIENTNAME, J.BOX_COUNT`;   \n                        let queryObject = await app.db.executeRequest(u, 'itm', query);\n                        let res = queryObject.result; \n                        if (res.length > 0) {\n                            let orderUniqueID = [...new Set(res.map((item) => {return item.ID;}))]; \n                            let clientUniqueName = [...new Set(res.map((item) => {return item.CLIENTNAME;}))]; \n                            txt = `Отправка от ${app.formatDate(shipment.FACT_DATE_OUT)} водитель ${shipment.DRIVER_NAME}`;\n                            txt += `\\nВсего уп. ${shipment.BOX}, сумма: ${app.formatMonetary(shipment.AMOUNT)}`;\n                            txt += '\\n' + clientUniqueName.map((c, indexClient) => {\n                                let t = \"—\".repeat(16) + `\\n👨🏼‍💼 <b>${c}</b> (${res.filter(i => i.CLIENTNAME == c).reduce((total, item) => {return total + item.BOX_COUNT;}, 0)} уп. / ${app.formatMonetary(res.filter(i => i.CLIENTNAME == c).reduce((total, item) => {return total + item.AMOUNT;}, 0))})\\n` + \"—\".repeat(16);\n                                t += '\\n' + orderUniqueID.filter(orderId => {\n                                    let tempItem = res.find(o => o.ID == orderId);\n                                    if (tempItem) return tempItem.CLIENTNAME == c;\n                                    return false;\n                                }).map((orId, indexOrder) => {\n                                    return (indexOrder + 1) + '. Заказ № ' + orId + (' (' + res.find(ord2 => ord2.ID == orId).BOX_COUNT) + ' уп / ' + app.formatMonetary(res.find(ord2 => ord2.ID == orId).AMOUNT) + ')' +\n                                        '\\n📂 [' + ORDER_ID_PREFIX + orId + ']';\n                                }).join('\\n');\n                                return t;\n                            }).join('\\n\\n');\n                            txt += `\\n\\n◀️ Вернуться [/backp]`;\n                        } else {\n                            txt = 'Отправка по данному адресу не обнаружена.';\n                        }\n                        u.sendMessage(txt);\n                    } catch (error) {\n                        node.error(error);\n                        u.sendMessage('Возникла шибка при попытке открыть поставку.');\n                    }        \n                } else {\n                    txt = 'Отправка по данному адресу не обнаружена.';\n                }\n            } else {\n                txt = 'Нет данных.';\n            }\n        })(originalMessage.text, user);\n        user.sendMessage('Обработка данных...');\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 50:\n        (async function (u, messageId) {\n            let tempInlineArr = [];\n            try {\n                if (u.temporaryData.ordersArr && u.temporaryData.ordersArr.length > 0) {\n                    let orderArrPosition = u.temporaryData.orderArrPosition;\n                    let countOrderMax = u.temporaryData.countOrderMax;\n                    let allCount = u.temporaryData.ordersArr.length;\n                    let ordersArr = u.temporaryData.ordersArr.slice(orderArrPosition, orderArrPosition + countOrderMax);\n                    let tempIcoFun = (statusNum, datePack) => {\n                        if (datePack) {\n                            if ((statusNum >= 5 && statusNum < 8) && (new Date() > datePack)) {\n                                return '📕'; // просрачка\n                            } \n                        }\n                        if (statusNum < 5) return '📘'; // На оформлении\n                        if (statusNum >= 5 && statusNum < 8) return '📗'; // в работе\n                        if (statusNum >=8 && statusNum < 10) return '📦'; // упакован\n                        if (statusNum >= 10) return '📓'; // отгружен\n                        return '🗳';\n                    }\n                    let tempIcoDebtFun = (totalCost, orderDebt, statusNum, isPrepaid) => {\n                        if (totalCost > 0 && orderDebt >=0) return '💵 ';\n                        if ((totalCost > 0 && orderDebt < 0) && ((isPrepaid === 0 && statusNum >=8) || (isPrepaid != 0 && (totalCost + orderDebt) >= (totalCost / 1.95)))) return '❗️ ';\n                        return '';\n                    }\n                    if (ordersArr.length > 0) {\n                        txt = `Показано ${allCount >= (orderArrPosition + countOrderMax) ? (orderArrPosition + countOrderMax) : allCount} из ${allCount} заказов:`;\n                        txt += '\\n' + ordersArr.map((itemOrder, itemIndex, itemArr) => {\n                            let tempText = `\\n** Заказчик: <b>${itemOrder.CLIENTNAME}</b> **`;\n                            tempText += `\\n${(itemIndex + 1 + orderArrPosition)}. ${tempIcoFun(itemOrder.STATUS_NUM, itemOrder.PLAN_DATE_PACK)} [${ORDER_ID_PREFIX}${itemOrder.ID}] (<i>${itemOrder.STATUS_DESCRIPTION}</i>)`;\n                            tempText += `\\n${tempIcoDebtFun(itemOrder.ORDER_TOTAL_COST, itemOrder.ORDER_DEBT, itemOrder.STATUS_NUM, itemOrder.IS_PREPAID)}<b>${(itemOrder.CITY ? (itemOrder.CITY.charAt(0).toUpperCase() == 'Г' ? '' : 'г. ') + itemOrder.CITY.trim() + ',' : '')}`;\n                            tempText += `${(itemOrder.ORDERNUM ? ' ' + itemOrder.ORDERNUM : '')}</b>`;\n                            tempText += `\\nМенеджер: <b>${itemOrder.MANAGER}</b>, создан: <code>${itemOrder.FACT_DATE_FIRSTSAVE ? app.formatDate(app.stringToDate(itemOrder.FACT_DATE_FIRSTSAVE.substr(0, 10))): 'Дата не известна'}</code>`\n                            return tempText;\n                        }).join('\\n');\n                        txt += '\\n';\n                    }\n                    if ((orderArrPosition - countOrderMax) >= 0) {\n                        tempInlineArr.push({\n                            \"text\": \"⬅️ Предыдущая\",\n                            \"callback_data\": \"/prevo\"\n                        });\n                        //txt += `\\n⬅️ [/prevo] Предыдущая страница`;\n                    }\n\n                    if (allCount - (orderArrPosition + countOrderMax) > 0) {\n                        tempInlineArr.push({\n                            \"text\": \"Следующая ➡️\",\n                            \"callback_data\": \"/nexto\"\n                        });\n                        //txt += `\\n➡️ Следующая страница  [/nexto]`;\n                    }\n                    txt += `\\nПоказано ${allCount >= (orderArrPosition + countOrderMax) ? (orderArrPosition + countOrderMax) : allCount} из ${allCount} заказов:`;\n                    \n                }else{\n                    txt = 'Нет данных, конец списка.';\n                }\n                if (messageId) {\n                    let inlineKeyboard;\n                    if (tempInlineArr.length > 0) inlineKeyboard = [tempInlineArr];\n                    app.msgBank.editMessage(u, txt, false, messageId, inlineKeyboard);\n                }else{\n                    u.sendMessage(txt);\n                }\n            } catch (error) {\n                node.error(error);\n                    user.sendMessage('Ошибка вывода списка заказов.');\n            }\n        })(user, user.temporaryData.messageId);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 1000:\n        /**\n                     * /otcoll\n                     * /otexp\n                     * /otecoll\n                     * /oteexp\n                     * /olcoll\n                     * /olexp\n                     * /olfn\n                     * /olan\n                     * order.expandDataTitle = true; +\n                        order.expandExtraDataTitle = true; +\n                        order.expandElementList = true; +\n                        order.expandPlan = false;\n                        order.expandShowSumElement = false;\n                        order.expandShowSumOrder = false;\n                        order.expandExecutionPlan = false;\n                        order.expandActionsWithOrder = false;\n                        order.trimNameElement = true; +\n                        \n                     */\n\n        switch (originalMessage.text) {\n            case '/otcoll':\n            case '/otexp':\n            case '/otecoll':\n            case '/oteexp':\n            case '/olcoll':\n            case '/olexp':\n            case '/olfn':\n            case '/olan':\n            case '/opcoll':\n            case '/opexp':\n                (async function (u, order, text) {\n                    if (!order){\n                        u.sendMessage('Нет текущего заказа.');\n                        return null;\n                    } \n                    if (text == '/otcoll') order.expandDataTitle = false;\n                    if (text == '/otexp') order.expandDataTitle = true; \n                    if (text == '/otecoll') order.expandExtraDataTitle = false;\n                    if (text == '/oteexp') order.expandExtraDataTitle = true;\n                    if (text == '/olcoll') order.expandElementList = false;\n                    if (text == '/olexp') order.expandElementList = true;\n                    if (text == '/olfn') order.trimNameElement = false;\n                    if (text == '/olan') order.trimNameElement = true;\n                    if (text == '/opcoll') order.expandPlan = false;\n                    if (text == '/opexp') order.expandPlan = true;\n                    u.setMode(ID, 23);\n                    app.switcher(u);\n                })(user, user.temporaryData.order, originalMessage.text)\n                break;\n            case '/backtolist':\n                if (user.temporaryData.ordersArr.length > 1) {\n                    user.setMode(ID, 50);\n                    app.switcher(user);\n                }\n                break;\n            case buttons.orders.myOrders.name: // мои заказы\n            case buttons.orders.generalOrders.name: // все заказы\n            case buttons.orders.packagedOrders.name: // упакованрые заказы\n            case buttons.orders.packagedOrdersWithDebt.name: // упакованные с долгом\n            case buttons.orders.ordersWithDebt.name: // заказы с долгом\n            \n            user.sendMessage('Обработка запроса...', false, (content, messageId) => {\n                (async function (u, text) {\n                    let countOrderMax = 5;\n                    let query;\n                    let queryObject;\n                    let extrQuery = '';\n                    let userNameItm;\n                    try {\n                        if (text == buttons.orders.myOrders.name) {\n                            query = `select first 1 e.itm_id from TG_USERS U left join employees e on (e.tg_id = U.id) where U.ID = ${u.id} and e.itm_id is not null`;\n                            queryObject = await app.db.executeRequest(u, 'cubic', query);\n                            let userItmID = (queryObject.result[0] ? queryObject.result[0].ITM_ID : undefined);\n                            if (userItmID) {\n                                query = `select e.name from employers e where e.id = ${userItmID}`;\n                                queryObject = await app.db.executeRequest(u, 'itm', query);\n                                userNameItm = await queryObject.result[0].NAME;\n                            }\n                            if (userItmID && userNameItm) {\n                                extrQuery = `upper(O.MANAGER) like '%${userNameItm.toUpperCase()}%'`;\n                            }else{\n                                u.sendMessage('Имя менеджера не определено, возможно имя не привязано к базе телеграма.');\n                                return null;\n                            }\n                        }\n                        if (text == buttons.orders.packagedOrders.name) extrQuery =`O.ORDER_STATUS = 8`;\n                        if (text == buttons.orders.packagedOrdersWithDebt.name) extrQuery =`O.ORDER_STATUS = 8 and C.IS_PREPAID is null and (O.ORDER_TOTAL_COST - coalesce(O.ORDER_PAY, 0)) * -1 < 0`;\n                        if (text == buttons.orders.ordersWithDebt.name) extrQuery = `(coalesce(O.ORDER_TOTAL_COST, 0) - coalesce(O.ORDER_PAY, 0)) * -1 < 0`;\n\n                        query = queryGetOrder(extrQuery);\n                        u.temporaryData = {};\n                        queryObject = await app.db.executeRequest(u, 'itm', query);\n                        let res = queryObject.result;\n                        u.temporaryData.queryType = text;\n                        u.temporaryData.ordersArr = res;\n                        u.temporaryData.orderArrPosition = 0;\n                        u.temporaryData.countOrderMax = countOrderMax;\n                        u.temporaryData.messageId = messageId;\n                        u.setMode(ID, 50);\n                        app.switcher(u);\n                    } catch (error) {\n                        node.error(error);\n                        u.sendMessage('Во время выполнения запроса, произошла ошибка.');\n                    }\n                })(user, originalMessage.text);\n            });\n                break;\n            case '/backp':\n                user.setMode(ID, 40);\n                app.switcher(user);\n                break;\n            case buttons.shipments.shipmentsProfile.name:\n            case buttons.shipments.shipmentsFasade.name:\n                (async function (u, text) {\n                    let profiler = '!= 1';\n                    if (originalMessage.text == buttons.shipments.shipmentsProfile.name) profiler = '= 1';\n                    try {\n                        let countProfileMax = 5; // Количество выводимых заказов\n                        u.temporaryData = {};\n                        let query = `select J.FACT_DATE_OUT, \n                                    J.DRIVER_NAME, \n                                    sum(J.BOX_COUNT) as BOX, \n                                    sum(O.ORDER_TOTAL_COST) as AMOUNT\n                                from ORDERS O\n                                left join JOURNAL_OUT J on (J.ORDER_ID = O.ID)\n                                left join CLIENTS C on (O.CLIENT = C.CLIENTNAME)\n                                where C.PROFILER ${profiler}\n                                group by J.FACT_DATE_OUT, J.DRIVER_NAME\n                                order by J.FACT_DATE_OUT desc`;\n                        let queryObject = await app.db.executeRequest(u, 'itm', query);\n                        let res = queryObject.result;\n                        u.temporaryData.shipmentType = originalMessage.text;\n                        u.temporaryData.profileArr = res;\n                        u.temporaryData.profileArrPosition = 0;\n                        u.temporaryData.countProfileMax = countProfileMax;\n                        u.setMode(ID, 40);\n                        app.switcher(u);\n                    } catch (error) {\n                        node.error(error);\n                        u.sendMessage('Ошибка запроса...');\n                    } \n                })(user, originalMessage.text);\n                user.sendMessage('Идет поиск последних отправок...');\n                break;\n            case '/nexto':\n                if (user.temporaryData.ordersArr && user.temporaryData.ordersArr.length > 0) {\n                    user.temporaryData.orderArrPosition += user.temporaryData.countOrderMax;\n                    user.setMode(ID, 50);\n                    app.switcher(user);\n                }else{\n                    user.sendMessage('Выполни поиск поставок, для отображения отправок.');\n                }\n                break;\n            case '/nextp':\n                if (user.temporaryData.profileArr && user.temporaryData.profileArr.length > 0) {\n                    user.temporaryData.profileArrPosition += user.temporaryData.countProfileMax;\n                    user.setMode(ID, 40);\n                    app.switcher(user);\n                }else{\n                    user.sendMessage('Выполни поиск поставок, для отображения отправок.');\n                }\n                break;\n            case '/prevo':\n                if (user.temporaryData.ordersArr && user.temporaryData.ordersArr.length > 0) {\n                    if ((user.temporaryData.orderArrPosition - user.temporaryData.countOrderMax) <= 0) {\n                        user.temporaryData.orderArrPosition = 0;\n                    } else {\n                        user.temporaryData.orderArrPosition = user.temporaryData.orderArrPosition - user.temporaryData.countOrderMax;\n                    }\n                    user.setMode(ID, 50);\n                    app.switcher(user);\n                }else{\n                    user.sendMessage('Выполни поиск поставок, для отображения отправок.');\n                }\n                break;\n            case '/prevp':\n                if (user.temporaryData.profileArr && user.temporaryData.profileArr.length > 0) {\n                    if ((user.temporaryData.profileArrPosition - user.temporaryData.countProfileMax) <= 0) {\n                        user.temporaryData.profileArrPosition = 0;\n                    } else {\n                        user.temporaryData.profileArrPosition = user.temporaryData.profileArrPosition - user.temporaryData.countProfileMax;\n                    }\n                    user.setMode(ID, 40);\n                    app.switcher(user);\n                }else{\n                    user.sendMessage('Выполни поиск поставок, для отображения отправок.');\n                }\n                break;\n            case buttons.orders.errorsOrders.name:\n                // Контроль ошибок\n                user.setMode(ID, 7);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.orders.errorsRegister.name:\n                user.setMode(ID, 30);\n                app.switcher(user);\n                break;\n            case buttons.orders.informationAboutOrder.name:\n                user.setMode(ID, 20);\n                app.switcher(user);\n                break;\n            case '/nextPage':\n                if (user.temporaryData.orderArr && user.temporaryData.orderArr.length > 0) {\n                    let tempStart = user.temporaryData.orderArrPosition + user.temporaryData.countOrdersMax;\n                    let arr = user.temporaryData.orderArr.slice(tempStart - 1, tempStart + user.temporaryData.countOrdersMax - 1);\n                    if (arr.length > 0){\n                        txt = 'Показано <i>' + (Number(tempStart) + Number(arr.length)) + '</i> из <i>' + (user.temporaryData.orderArr.length) + '</i> результатов.';\n                        txt += '\\n' + arr.map((item, i) => {\n                            return (i + tempStart + 1) + '. [' + ORDER_ID_PREFIX + item.ID + ']\\nID: <b>' + item.ITM_ORDERNUM + '</b> ' + (item.CITY ? '(г.' + item.CITY + ').' : '.') +\n                                    '\\nСтатус: <i>' + item.STATUS_DESCRIPTION + '</i> '\n                        }).join('\\n\\n');\n                        if ((user.temporaryData.orderArr.length - (tempStart + user.temporaryData.countOrdersMax))>= 0) txt += '\\n\\n*******************\\nПоказать еще [/nextPage]';\n                        user.temporaryData.orderArrPosition = tempStart;\n                        user.sendMessage(txt);\n                    }else{\n                        user.sendMessage('Заказы не найдены, конец списка.');\n                    }\n                }\n                break;\n            default:\n                user.sendMessage('🧐 ищу...', false, (content, msgId) => {\n                    user.temporaryData.messageId = undefined;\n                    (async function (txt, messageId) {\n                        try {\n                            let countOrdersMax = 5; // Количество выводимых заказов\n                            let fCode = 0;\n                            let extQ = '';\n                            let tempArr;\n                            let isNum = (n) => {return !isNaN(parseFloat(n)) && isFinite(n);}\n                            let getRes = async (u, text) => {\n                                let resQ;\n                                \n                                tempData = app.stringToDate(text);\n                                if (app.isValidDate(tempData)) {\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(`cast(cast(O.FACT_DATE_FIRSTSAVE as timestamp) as date)  = '${app.formatDateToDb(tempData)}'`))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                }\n\n                                if (isNum(text)) {\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(`O.ID = ${text} or upper(O.ITM_ORDERNUM) like '%${text.toUpperCase()}%'`))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                }\n                                // Долг\n                                if (txt.toUpperCase().includes('долг'.toUpperCase()) || \n                                        txt.toUpperCase().includes('задол'.toUpperCase()) || \n                                        txt.toUpperCase().includes('не опла'.toUpperCase()) ||\n                                        txt.toUpperCase().includes('нет опла'.toUpperCase()) || \n                                        txt.toUpperCase().includes('неопла'.toUpperCase())) {\n                                    app.msgBank.editMessage(u, 'Посмотрим по долгам...', false, messageId);\n                                    let q1 = `O.ORDER_TOTAL_COST > 0 and (- O.ORDER_TOTAL_COST + coalesce(O.ORDER_PAY, 0)) < 0 and \n                                                ((C.IS_PREPAID = 0 and LIST_STATUSES.STATUS_NUM >= 8) or \n                                                (C.IS_PREPAID != 0 and LIST_STATUSES.STATUS_NUM >= 5 and LIST_STATUSES.STATUS_NUM < 8 and \n                                                    (O.ORDER_TOTAL_COST + (- O.ORDER_TOTAL_COST + coalesce(O.ORDER_PAY, 0))) >= (O.ORDER_TOTAL_COST / 1.95)) or\n                                                (C.IS_PREPAID != 0 and LIST_STATUSES.STATUS_NUM >= 8))`;\n                                                \n                                    tempArr =  txt.split(' ');\n                                    tempArr.forEach((e, i, arr) => {\n                                        if (e.toUpperCase().includes('долг'.toUpperCase()) || \n                                            e.toUpperCase().includes('задол'.toUpperCase()) || \n                                            e.toUpperCase() == ('нет'.toUpperCase()) || \n                                            e.toUpperCase() == ('не'.toUpperCase())) {\n                                                tempArr.splice(i, 1);\n                                            } \n                                    });\n                                    if (tempArr.length > 0) {\n                                        tempArr.forEach(e => {\n                                            if (e) q1 += `\\nand upper(O.ITM_ORDERNUM || C.CITY || LIST_STATUSES.STATUS_DESCRIPTION || O.ORDER_TYPE || O.MANAGER || O.FASAD_MAT || O.FASAD_MODEL) like '%${e.replace(/\\,/g, '').toUpperCase()}%'`\n                                        });\n                                    }\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(q1))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                }\n                                // Долг конец\n                                // Просрочка\n                                if (txt.toUpperCase().includes('просро'.toUpperCase()) || \n                                        txt.toUpperCase().includes('просра'.toUpperCase())) {\n                                    app.msgBank.editMessage(u, 'Что там по просрочке...', false, messageId);\n                                    let q1 = `LIST_STATUSES.STATUS_NUM < 8 and '${app.formatDateToDb(new Date())}' > O.PLAN_DATE_PACK`;\n                                    tempArr =  txt.split(' ');\n                                    tempArr.forEach((e, i, arr) => {\n                                        if (e.toUpperCase().includes('просро'.toUpperCase()) || \n                                            e.toUpperCase().includes('просра'.toUpperCase())) {\n                                                tempArr.splice(i, 1);\n                                            } \n                                    });\n                                    if (tempArr.length > 0) {\n                                        tempArr.forEach(e => {\n                                            if (e) q1 += `\\nand upper(O.ITM_ORDERNUM || C.CITY || LIST_STATUSES.STATUS_DESCRIPTION || O.ORDER_TYPE || O.MANAGER || O.FASAD_MAT || O.FASAD_MODEL) like '%${e.replace(/\\,/g, '').toUpperCase()}%'`\n                                        });\n                                    }\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(q1))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                }\n                                // Просрочка конец\n                                let q3 ='';\n                                tempArr = txt.split(' ');\n                                if (tempArr.length > 1) {\n                                    tempArr.forEach((e, i) => {\n                                        if (e.toUpperCase() == 'в'.toUpperCase() ||\n                                                e.toUpperCase() == 'нет'.toUpperCase() ||\n                                                e.toUpperCase() == 'не'.toUpperCase() ||\n                                                e.toUpperCase() == 'на'.toUpperCase() ||\n                                                e.toUpperCase() == 'с'.toUpperCase() ||\n                                                e.toUpperCase() == 'и'.toUpperCase()) {\n                                                    tempArr.splice(i, 1);\n                                        }\n                                    });\n                                    if (tempArr.length > 0) {\n                                        tempArr.forEach((e, i) => {\n                                            q3 += `${(i == 0 ? '' : ' \\nand ')}` + `upper(O.ITM_ORDERNUM || \n                                                coalesce(C.CITY, '') || \n                                                coalesce(LIST_STATUSES.STATUS_DESCRIPTION, '')  || \n                                                coalesce(O.ORDER_TYPE, '')  || \n                                                coalesce(O.MANAGER, '')  || \n                                                coalesce(O.FASAD_MAT, '')  || \n                                                coalesce(O.FASAD_MODEL, '')) like '%${e.replace(/\\,/g, '').toUpperCase()}%'`;\n                                        });\n                                    }\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(q3))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                    app.msgBank.editMessage(u, '🤢 ищу сильнее...', false, messageId);\n                                    q3 ='';\n                                    if (tempArr.length > 0) {\n                                        tempArr.forEach((e, i) => {\n                                            q3 += `${(i == 0 ? '' : ' \\nand ')}` + \n                                                `upper(O.ITM_ORDERNUM || ' ' ||\n                                                coalesce(C.CITY, '') || ' ' ||\n                                                coalesce(LIST_STATUSES.STATUS_DESCRIPTION, '') || ' ' ||\n                                                coalesce(O.ORDER_TYPE, '') || ' ' ||\n                                                coalesce(O.MANAGER, '') || ' ' ||\n                                                coalesce(O.FASAD_MAT, '') || ' ' ||\n                                                coalesce(O.FASAD_MODEL, '') || ' ' ||\n                                                coalesce(O.COLOR, '') || ' ' ||\n                                                coalesce(O.COLOR_TYPE, '') || ' ' ||\n                                                coalesce(O.PRIMECH, '') || ' ' ||\n                                                coalesce(L.NAME, '') || ' ' ||\n                                                coalesce(L.HEIGHT, '') || ' ' ||\n                                                coalesce(L.comment, '')) like '%${e.replace(/\\,/g, '').toUpperCase()}%'`;\n                                        });\n                                    }\n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrderToElement(q3))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n                                }else{\n                                    let q2 = `upper(O.ITM_ORDERNUM || \n                                        coalesce(C.CITY, '') || \n                                        coalesce(LIST_STATUSES.STATUS_DESCRIPTION, '')  || \n                                        coalesce(O.ORDER_TYPE, '')  || \n                                        coalesce(O.MANAGER, '')  || \n                                        coalesce(O.FASAD_MAT, '')  || \n                                        coalesce(O.FASAD_MODEL, '')) like '%${text.toUpperCase()}%'`;\n        \n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrder(q2))).result;\n                                    if (resQ && resQ.length > 0) return resQ;\n        \n        \n                                    resQ = (await app.db.executeRequest(u, 'itm', queryGetOrderToElement(`upper(L.NAME) like '%${text.toUpperCase()}%' or upper(L.comment) like '%${text.toUpperCase()}%'`))).result;\n                                    return resQ;\n                                }\n                                return null;\n                            }\n                            //.includes\n                            user.temporaryData = {};\n                            let res = await getRes(user, txt);\n                            if (res && res.length > 0) {\n                                app.temporaryData.findOrderTxt = txt;\n                                user.temporaryData.queryType = txt;\n                                user.temporaryData.ordersArr = res;\n                                user.temporaryData.orderArrPosition = 0;\n                                user.temporaryData.countOrderMax = countOrdersMax;\n                                app.msgBank.editMessage(user, 'Нашел! Заливаю...', false, messageId);\n                                user.temporaryData.messageId = messageId;\n                                if (res.length == 1) {\n                                    originalMessage.text = String(res[0].ID);\n                                    user.setMode(ID, 21);\n                                }else{\n                                    user.setMode(ID, 50);\n                                }\n                                app.switcher(user);\n                            }else{\n                                app.msgBank.editMessage(user, app.generators.autoAnswer.notFoundComand, false, messageId);\n                            }\n                        } catch (error) {\n                            app.msgBank.editMessage(user, 'Ой, ошибочка вышла, зовите программиста.\\nУстал...', false, messageId);\n                            //user.sendMessage('Ой, ошибочка вышла, зовите программиста.\\nУстал...');\n                            node.error('Ошибка поиска заказа');\n                            node.error(error);\n                        }\n                    })(originalMessage.text, msgId);\n                });\n                \n                break;\n        }\n        break;\n    default:\n        break;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 560,
        "wires": [
            [
                "8b7ea3a.b3ace6"
            ]
        ]
    },
    {
        "id": "c7b63056.0101f",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Step 0",
        "func": "let ID = 0; // Меню.\nlet WAITING_STEP = 100;\n\nlet app = msg.app;\nlet errorsBank = app.errorsBank;\nlet originalMessage = msg.originalMessage;\n\nlet user = app.user;\nlet users = app.users;\nlet documents = app.documents;\nlet db = app.db;\n\nlet buttons = app.buttons;\nlet keyboards = app.keyboards;\n\nlet userKeyboards = undefined;\nlet txt = '';\n\nfunction ucFirst(str) {\n    if (!str) return str;\n\n    return str[0].toUpperCase() + str.slice(1);\n}\n\nfunction shortYear (date) {\n    return `${date.slice(0, -4)}${date.slice(-2)}`\n}\n\n\napp.users.openUser(originalMessage.text, (err, u) => {\n    if (u) {\n        user.editableUser = undefined;\n        user.editableUser = u;\n        user.setMode(1, 100);\n        originalMessage.text = '';\n        app.switcher(user);\n    } else {\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openDoc(originalMessage.text, (err, d) => {\n    if (d) {\n        user.setMode(2, 100);\n        originalMessage.text = '';\n        user.editableDocument = undefined;\n        user.editableDocument = d;\n        app.switcher(user);\n    } else {\n        if (err) {\n            user.sendMessage(err);\n            originalMessage.text = '';\n        }\n    }\n});\n\ndocuments.openStage(originalMessage.text, (err, s) => {\n    if (s) {\n        user.editableStage = undefined;\n        user.editableStage = s;\n        user.setMode(2, 200);\n        originalMessage.text = '';\n        app.switcher(user);\n    } else {\n        if (err) {\n            user.sendMessage(err + ' Ошибка [311]');\n            originalMessage.text = '';\n        }\n    }\n});\n\nswitch (originalMessage.text) {\n    case buttons.comeBackMenu.name:\n        // Кнопка \"Назад\".\n        let mode = user.getLastKeyPoint();\n        user.mode = mode;\n        originalMessage.text = mode.msg;\n        app.switcher(user);\n        return null;\n        break;\n    case buttons.homeMenu.name:\n        // Кнопка \"Главное меню\".\n        if (user.editableUser) user.editableUser.reload();\n        user.reset();\n        originalMessage.text = '';\n        app.switcher(user);\n        return null;\n        break;\n    default:\n        break;\n}\n//Если гость, то в режим ожидания\nif (user.groupId == 1) {\n    user.setMode(0, 100);\n}\n\nswitch (user.mode.step) {\n    case 0:\n        // Главное меню.  \n        userKeyboards = keyboards.get(buttons.homeMenu.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name);\n\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 1:\n        // Документы.  \n        userKeyboards = keyboards.get(buttons.menu.documents.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name + ' > ' +\n            buttons.menu.documents.name);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 2:\n        // Пользователи.  \n        userKeyboards = keyboards.get(buttons.menu.users.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name + ' > ' +\n            buttons.menu.users.name);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 3:\n        // Заказы.  \n        userKeyboards = keyboards.get(buttons.menu.orders.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name + ' > ' +\n            buttons.menu.orders.name + '\\n\\nℹ️ Для поиска заказа, набери текст, например: <i>' +\n            (app.temporaryData.findOrderTxt ? app.temporaryData.findOrderTxt : 'Галерея') + '</i>');\n        user.setMode(3, 1000);\n        break;\n    case 4:\n        // Отправки.\n        userKeyboards = keyboards.get(buttons.menu.shipments.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name + ' > ' +\n            buttons.menu.shipments.name);\n        user.setMode(3, 1000);\n        break;\n    case 5:\n        // Подписки.\n        userKeyboards = keyboards.get(buttons.menu.newsletters.name, user.group().id);\n        if (userKeyboards) user.sendKeyboard(userKeyboards,\n            buttons.homeMenu.name + ' > ' +\n            buttons.menu.newsletters.name);\n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 6:\n        user.setMode(ID, WAITING_STEP);\n        if ((user.id == 18 || user.id == 48 || user.id == 63) && false) {\n            user.sendMessage('Запрос отклонен.');\n        } else {\n            app.db.queryCallback(user, 'itm', 'SELECT AMOUNT FROM GET_BALANSE_CASSA')\n                .then(queryObject => {\n                    if (user.chatId == 199688987 || user.chatId == 582657818 || user.chatId == 1805605563) user.sendMessage('🥬 <code>' + queryObject.result[0].AMOUNT + '</code>');\n\n                    app.msgBank.sendMessage(users.userList.filter((item) => {\n                        return (item.chatId == 199688987 || item.chatId == 582657818 || item.chatId == 1805605563) && item.chatId != user.chatId;\n                    }), '🥬 Информацию запросил: <u>' + user.first_name + '</u>');\n\n                });\n        }\n        break;\n    case 7:\n        /**\n         * ID         INTEGER NOT NULL,\n    FACT_DATE  DATE,\n    CATEGORY   VARCHAR(50),\n    PURPOSE    VARCHAR(100),\n    MONEYSUM   INTEGER,\n    COMMENT    VARCHAR(100),\n    TS         TIMESTAMP,\n    DELETED    SMALLINT\n         */\n        user.setMode(ID, WAITING_STEP);\n \n /* Код от ИИ */\n\n\n \nif ((user.id == 18 || user.id == 48 || user.id == 63) && false) {\n    user.sendMessage('Запрос отклонен.');\n} else {\n    const today = new Date();\n    const sevenDaysAgo = new Date();\n    sevenDaysAgo.setDate(today.getDate() - 7);\n\n    // Форматируем даты в нужный формат для SQL\n    const todayFormatted = today.toISOString().split('T')[0]; // YYYY-MM-DD\n    const sevenDaysAgoFormatted = sevenDaysAgo.toISOString().split('T')[0]; // YYYY-MM-DD\n\n    app.db.queryCallback(user, 'itm', `SELECT * FROM JOURNAL_CASHFLOW J WHERE J.category !='#СВЕРКА#' AND J.fact_date >= '${sevenDaysAgoFormatted}' AND J.fact_date <= '${todayFormatted}' ORDER BY J.ID DESC`)\n        .then(queryObject => {\n            if (user.chatId == 199688987 || user.chatId == 582657818 || user.chatId == 1805605563) {\n                let resultMsg = `Кассовые операции за последние 7 дней: \\n`;\n                let c = 1;\n                let rows = (queryObject.result || []);\n                for (const row of rows) {\n                    resultMsg += '---------------------------------------------\\n';\n                    resultMsg += `${c}.${row.MONEYSUM > 0 ? \"🔹\" : \"🔻\"}${shortYear(new Date(row.FACT_DATE).toLocaleDateString())}💰 <b>${Number(row.MONEYSUM)\n                        .toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n                    resultMsg += `▪️ ${ucFirst(row.CATEGORY)}; `;\n                    resultMsg += `<u>${ucFirst(row.PURPOSE)}</u>; `;\n                    resultMsg += `<i>${ucFirst(row.COMMENT)}</i>\\n`;\n                    c++;\n                }\n                if (!rows.length) {\n                    resultMsg = `За последние 7 дней нет кассовых операций.`;\n                } else {\n                    resultMsg += '---------------------------------------------\\n';\n\n                    resultMsg += '<u>Итого за последние 7 дней:</u>\\n';\n                    resultMsg += `🔹 Приход: <b>${rows.reduce((acc, r) => {\n                        if (Number(r.MONEYSUM) > 0) acc += Number(r.MONEYSUM);\n                        return acc;\n                    }, 0).toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n                    resultMsg += `🔻 Расход: <b>${rows.reduce((acc, r) => {\n                        if (Number(r.MONEYSUM) < 0) acc += Number(r.MONEYSUM);\n                        return acc;\n                    }, 0).toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n                }\n                user.sendMessage(resultMsg);\n            }\n        });\n}\n\n\n//Старый код\n /* \n        if ((user.id == 18 || user.id == 48 || user.id == 63) && false) {\n            user.sendMessage('Запрос отклонен.');\n        } else {\n            app.db.queryCallback(user, 'itm', `SELECT * FROM JOURNAL_CASHFLOW J WHERE J.category !='#СВЕРКА#' and j.fact_date = '${new Date().toLocaleDateString()}'  ORDER BY J.ID DESC`)\n                .then(queryObject => {\n                    if (user.chatId == 199688987 || user.chatId == 582657818 || user.chatId == 1805605563) {\n                        let resultMsg = `Кассовые операции: \\n`\n                        let c = 1\n                        let rows = (queryObject.result || []);\n                        for (const row of rows) {\n                            resultMsg += '---------------------------------------------\\n';\n                            resultMsg += `${c}.${row.MONEYSUM > 0 ? \"🔹\" : \"🔻\"}${shortYear(new Date(row.FACT_DATE).toLocaleDateString())}💰 <b>${Number(row.MONEYSUM)\n                                .toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n                            resultMsg += `▪️ ${ucFirst(row.CATEGORY)}; `;\n                            resultMsg += `<u>${ucFirst(row.PURPOSE)}</u>; `;\n                            resultMsg += `<i>${ucFirst(row.COMMENT)}</i>\\n`;\n                            c++;\n                        }\n                        if (!rows.length) {\n                            resultMsg = `На дату: ${shortYear(new Date().toLocaleDateString())} нет кассовых операций.`\n                        } else {\n                            resultMsg += '---------------------------------------------\\n';\n\n                            resultMsg += '<u>Итого на : ' + shortYear(new Date().toLocaleDateString()) + '</u>\\n';\n                            resultMsg += `🔹 Приход: <b>${rows.reduce((acc, r) => {\n                                if (Number(r.MONEYSUM) > 0) acc += Number(r.MONEYSUM);\n                                return acc;\n                            }, 0).toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n                            resultMsg += `🔻 Расход: <b>${rows.reduce((acc, r) => {\n                                if (Number(r.MONEYSUM) < 0) acc += Number(r.MONEYSUM);\n                                return acc;\n                            }, 0).toLocaleString(\"ru-Ru\", { style: 'currency', currency: 'RUB' })}</b>\\n`;\n\n                        }\n                        user.sendMessage(resultMsg);\n                    }\n\n\n\n                    // app.msgBank.sendMessage(users.userList.filter((item) => {\n                    //     return (item.chatId == 199688987 || item.chatId == 582657818 || item.chatId == 1805605563) && item.chatId != user.chatId;\n                    // }), '🥬 Информацию запросил: <u>' + user.first_name + '</u>');\n                });\n        } \n        \n        \n        \n        */\n        break;\n    case 8:\n    case 9:\n        // Главное меню. (Временно) \n        user.setMode(ID, WAITING_STEP);\n        break;\n    case 10:\n        break;\n    case 100:\n        switch (originalMessage.text) {\n            case buttons.interesting.name:\n                user.sendMessage(app.generators.autoAnswer.answerToGuest);\n                break;\n            case buttons.orders.samples.name:\n                user.sendMessage('Функция в разработке.');\n                break;\n            case buttons.menu.documents.name:\n                user.setMode(ID, 1);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.users.name:\n                user.setMode(ID, 2);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.orders.name:\n                user.setMode(ID, 3);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.shipments.name:\n                user.setMode(ID, 4);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.newsletters.name:\n                user.setMode(ID, 5);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.money.name:\n                // Капуста\n                user.setMode(ID, 6);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.cashTransactions.name:\n                // Капуста\n                user.setMode(ID, 7);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.menu.profile.name:\n                break;\n            case buttons.users.registeredUsers.name:\n                // Зарегистрированные.\n                user.setMode(1, 0);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.users.awaitingRegistration.name:\n                // Ожидают регистрацию.\n                user.setMode(1, 1);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.users.listContractors.name:\n                //Список контрагентов\n                user.setMode(1, 3);\n                app.switcher(user);\n                break;\n            case buttons.users.myData.name:\n                // Мои данные.\n                user.editableUser = user;\n                //node.warn(app.phoneMask('79884770946')); \n                user.setMode(1, 100);\n                app.switcher(user);\n                break;\n            case buttons.users.createUser.name:\n                // Создать пользователя.\n                user.setMode(1, 2);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.users.createCounterparty.name:\n                // Добавить контрагента.\n                user.setMode(1, 4);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.documents.allDocuments.name:\n            case buttons.documents.myDocuments.name:\n            case buttons.documents.closedDocuments.name:\n            case buttons.documents.currentDocuments.name:\n            case buttons.documents.unpaidDocuments.name:\n            case buttons.documents.unpaidStages.name:\n\n                user.setMode(2, 0, false, originalMessage.text);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.documents.createDocument.name:\n                user.setMode(2, 20);\n                app.switcher(user);\n                return null;\n                break;\n            case buttons.test.name:\n                user.setMode(2, 10);\n                app.switcher(user);\n                break;\n            case 'test':\n                let d = documents.documentList.find(d => d.id == 5);\n                user.sendMessage(d.summ());\n                user.sendMessage(d.AmountOfPayments());\n                node.warn(d.summ())\n                break;\n            case 'Обновление':\n                if (user.chatId == 1836157332 || user.chatId == 199688987) {\n                    txt = `Обновление от ${app.formatDateAndTime(new Date())}` +\n                        '\\n▫️ Добавлено поле \"Владелец карты\"' +\n                        '\\n▫️ Добавлена возможность редактирования этапа.';\n                    users.sendMessageToAllUsers(txt);\n                }\n                break;\n            case 'Перезагрузка':\n                if (user.chatId == 199688987 || user.chatId == 582657818) {\n                    txt = `Добрый день!\\nДля идентификации пользователя, воспользуйтесь кнопкой \"Указать номер телефона\"`;\n\n                    users.getUserToId(73).sendKeyboard([[{ text: 'Отправить свой номер телефона', request_contact: true }]], txt);\n                    users.getUserToId(73).setMode(1, 114, true, originalMessage.text);\n                    users.getUserToId(73).editableUser = users.getUserToId(73);\n                    //users.sendMessageToAllUsers(txt);\n\n                    user.sendKeyboard([[{ text: 'Отправить свой номер телефона', request_contact: true }]], txt);\n                }\n                break;\n            default:\n                txt = originalMessage.text;\n                if (txt) {\n                    user.sendMessage(app.generators.autoAnswer.unknownComand);\n                }\n                break;\n        }\n        break;\n    default:\n        break;\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 440,
        "wires": [
            [
                "8ab02347.929cc"
            ]
        ]
    },
    {
        "id": "8ab02347.929cc",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "D 0",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "app",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 440,
        "wires": []
    },
    {
        "id": "ff542764.a4d178",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "D 1",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "app",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 480,
        "wires": []
    },
    {
        "id": "eb3df53d.c859a8",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "D 2",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 520,
        "wires": []
    },
    {
        "id": "8b7ea3a.b3ace6",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "D 3",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "app",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1090,
        "y": 560,
        "wires": []
    },
    {
        "id": "9d921afc.935658",
        "type": "catch",
        "z": "e2619ce4.622d3",
        "name": "Catch Sender",
        "scope": [
            "2df294b1.982a4c"
        ],
        "uncaught": false,
        "x": 790,
        "y": 40,
        "wires": [
            [
                "ffbe929d.40a89"
            ]
        ]
    },
    {
        "id": "2c8ce374.26251c",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Comands",
        "func": "let app = msg.app;\nlet errorsBank  = app.errorsBank;\nlet originalMessage = msg.originalMessage;\nlet user = app.user;\n\nif (!app.temporaryData) {app.temporaryData = {};}\n\nif (originalMessage.text == '/start') {\n    user.reset();\n    //user.setMode(0, 0);\n}\n\nif (originalMessage.text == '/uved') {\n     \n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 500,
        "wires": [
            [
                "6d26324f.65290c"
            ]
        ]
    },
    {
        "id": "ffbe929d.40a89",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1060,
        "y": 40,
        "wires": []
    },
    {
        "id": "8a2f32b2.b026c",
        "type": "function",
        "z": "e2619ce4.622d3",
        "name": "Database Synchronization",
        "func": "let t = 120; // Частота синхронизации с базой данных в секундах.\nlet STAGE_ID_PREFIX = '/stg'; \nlet deltatime = flow.get('deltatime');\nif (!deltatime) flow.set('deltatime', msg.deltatime);\n\nif (((Date.now() - deltatime)/1000) > t) {\n    let errorsBank  = flow.get(\"ErrorsBank\");\n    let app = flow.get('App');\n    if (app) {\n        app.documents.loadingSettings();\n        app.documents.loading((err, docs) => {\n        });\n        let stages = app.documents.stageList.filter((s) => {\n            return s.id > 0 && s.isNotification != -1 && s.firstElement();\n        });\n        stages.forEach(s => {\n            try {\n                let txt = s.author().first_name + ' добавил (а) новый этап ' + s.dynamicName() + ' в документ № ' + s.document().id;\n                txt += '\\nОткрыть: [' + STAGE_ID_PREFIX + s.id + ']'; \n                app.users.sendMsgToGroupId(7, txt, false, s.author().id);\n                app.users.sendMsgToGroupId(5, txt, false, s.author().id);\n                if (s.document().author().groupId != 5 && s.document().author().groupId != 7) {\n                    s.document().author().sendMessage(txt);\n                }\n                if (s.firstElement().type().groupId == 1) app.users.getUserToId(70).sendMessage(txt);\n            } catch (error) {\n                node.error(error);\n            }\n            s.notificationComplit();\n        });\n        (async function (app) {\n            try {\n                let db = app.db;\n                let key = 'last packed order';\n                let managers = [];\n                let [lastPacked] = (await db.executeRequest(null, 'itm', \n                    `select d.value_data from telegram_data d where upper(d.name_data) = upper('${key}')`)).result;\n                if (!lastPacked) {\n                    [lastPacked] = (await db.executeRequest(null, 'itm', `select max(p.id) as ID from journal_upack p`)).result;\n                    await db.executeRequest(null, 'itm', `select ID from SET_TELEGRAM_DATA ('${key}', '${lastPacked.ID}')`);\n                    return;\n                }\n                let query = `select distinct P.ID, O.ID as ID_ORDER, O.ITM_ORDERNUM, \n                                P.PACK_TYPE, P.BOX_COUNT,\n                                E.ID as ID_MANAGER, O.MANAGER, O.CLIENT, C.PHONE,\n                                coalesce(O.ORDER_TOTAL_COST, 0) as ORDER_TOTAL_COST,\n                                coalesce(O.ORDER_PAY, 0) as ORDER_PAY, C.PROFILER \n                                from JOURNAL_UPACK P\n                                left join ORDERS O on (P.ORDER_ID = O.ID)\n                                left join CLIENTS C on (O.CLIENT = C.CLIENTNAME)\n                                left join EMPLOYERS E on (O.MANAGER = E.NAME)\n                                where P.ID > ${lastPacked.VALUE_DATA}\n                                order by P.ID desc`;\n    \n                let orders = (await db.executeRequest(null, 'itm', query)).result;\n                if (!orders || orders.length == 0) return;\n                let managersId = [...new Set(orders.map(item => item.ID_MANAGER))];\n                if (managersId && managersId.length > 0) {\n                    query = `\n                            select U.ID, E.ITM_ID\n                            from TG_USERS U\n                            left join EMPLOYEES E on (E.TG_ID = U.ID)\n                            where E.ITM_ID in (${managersId.join(', ')})`;\n                    managers = (await db.executeRequest(null, 'cubic', query)).result;\n                }\n                let [lastItem] = orders;\n                if (orders){\n                   await db.executeRequest(null, 'itm', `select ID from SET_TELEGRAM_DATA ('${key}', '${lastItem.ID}')`);\n                   for (const order of orders) {\n                        let txt ='';\n                        let debt = Math.abs(order.ORDER_TOTAL_COST) - Math.abs(order.ORDER_PAY);\n                        let messageToClient = (debt > 0 && order.PROFILER != 1)\n                        ? `Добрый%20день!%20Заказ%20${order.ID_ORDER}%20упакован%20и%20ожидает%20оплаты%20в%20размере%20${debt}%20р.%20`\n                        : `Добрый%20день!%20Заказ%20${order.ID_ORDER}%20упакован.%20`;\n\n                        txt += `▫️ <b>${order.ITM_ORDERNUM}</b>\\n▫️ <u>Упакован ${order.PACK_TYPE} (${order.BOX_COUNT} уп.)</u>`;\n                        txt += `\\n💵 ${app.formatMonetary(order.ORDER_TOTAL_COST)} / ${app.formatMonetary(order.ORDER_PAY)}${debt > 0 ? '\\n⚠️ Долг: ' + app.formatMonetary(debt) : ' ✅'}`;\n\n                        if (order.PHONE) {\n                            let phone =  order.PHONE.charAt(0) == '8' ? '+7' + order.PHONE.slice(1) : order.PHONE;\n                            txt += '\\n' + \"—\".repeat(16) + `\\n📨 <a href=\"https://api.whatsapp.com/send?phone=${phone}&text=${messageToClient}\">Уведомить в WhatsApp</a>`;\n                        } \n                        \n                        let tgId = managers.find(m => m.ITM_ID == order.ID_MANAGER);\n                        let manager = app.users.getUserToId(tgId ? tgId.ID : null);\n                        // {\"text\": \"WhatsApp\", \"url\": `https://api.whatsapp.com/send?phone=${phone}&text=${messageToClient}`}\n                        let inlineKeyboard = [[\n                            {\"text\": \"Выполнено\", \"callback_data\": \"/donePackedNotification\"}\n                        ]];\n                        if (manager) {\n                            let arrMsg = [\n                                `Привет ${order.MANAGER}!\\n Хорошие новости:\\n`,\n                                `${order.MANAGER}, один из твоих заказов упакован:\\n`,\n                                `${order.MANAGER}, я нашел упакованный заказ,\\nможно уведомить клиента.\\n`,\n                                `${order.MANAGER}, ${order.CLIENT} ожидает свой заказ, он упакован:\\n`,\n                                `${order.MANAGER}, есть желание поработать? 😉\\n Отправь уведомление клиенту!\\n`,\n                                `${order.MANAGER}, смотри что я нашел... \\nУпакованный заказ!\\n`,\n                                `${order.MANAGER}, заказ № ${order.ID_ORDER} упаковали\\n`,\n                                `${order.MANAGER}, наконец - то заказ № ${order.ID_ORDER} упакован\\n`,\n                                `${order.MANAGER}, у меня важная информация:\\n`,\n                                `${order.MANAGER}, силами нашей разведки, зафиксирован упакованный заказ:\\n`,\n                                `${order.CLIENT}, хотел знать, когда его ${order.BOX_COUNT} пачек, будут упакованы:\\n`,\n                                `Бот на связи! ${order.MANAGER}, заказ № ${order.ID_ORDER} успешно упакован!\\n`,\n                                `Прошу прощения за беспокойство ${order.MANAGER}, но у нас тут упакованный заказ:\\n `,\n                                `${order.MANAGER}, там заказ упаковали, а ты не знаешь. 😉 Что - бы вы без меня делали?\\n`\n                            ]\n                            //arrMsg[Math.floor(Math.random()*arrMsg.length)];\n                            let randMsg = arrMsg[Math.floor(Math.random()*arrMsg.length)];\n\n                            manager.sendKeyboardInLine(randMsg + txt, false, inlineKeyboard);\n                            //`Привет ${order.MANAGER}!\\n Хорошие новости:\\n`\n\n                            let roma = app.users.getUserToId(18);\n                            // roma.sendKeyboardInLine(randMsg+ txt, false, inlineKeyboard);\n                        }\n                        else{\n                            let seniorManager = app.users.getUserToId(71);\n                            if (seniorManager) {\n                                seniorManager.sendKeyboardInLine(\n                                    `Привет!\\nВ связи с тем, что менеджер ${order.MANAGER} не зарегистрирован(а) в системе Telegram, сообщение об упакованом заказе № ${order.ID_ORDER}, отправляю тебе:\\n` +\n                                    '\\n' + \"—\".repeat(16) + '\\n' + txt,\n                                    false, inlineKeyboard\n                                );\n                            }\n                            let roma = app.users.getUserToId(18);\n                            roma.sendKeyboardInLine(\n                                `Привет!\\nВ связи с тем, что менеджер ${order.MANAGER} не зарегистрирован(а) в системе Telegram, сообщение об упакованом заказе № ${order.ID_ORDER}, отправляю тебе:\\n` +\n                                '\\n' + \"—\".repeat(16) + '\\n' + txt,\n                                false, inlineKeyboard\n                            );\n                        }\n                   }\n                }\n            } catch (error) {node.error(error);}\n        })(app)\n    }\n    flow.set('deltatime', msg.deltatime);\n}",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "ba2b95cb.d076f8",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1060,
        "y": 220,
        "wires": []
    },
    {
        "id": "1c5a795a.4ea477",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 350,
        "y": 760,
        "wires": []
    },
    {
        "id": "4af09b7.e738e64",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 620,
        "wires": []
    },
    {
        "id": "bfbdcb2.d911238",
        "type": "debug",
        "z": "e2619ce4.622d3",
        "name": "",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 300,
        "y": 440,
        "wires": []
    },
    {
        "id": "dbea59e9.dfd758",
        "type": "telegram receiver",
        "z": "e2619ce4.622d3",
        "name": "",
        "bot": "294d6779.f90188",
        "saveDataDir": "",
        "filterCommands": false,
        "x": 90,
        "y": 480,
        "wires": [
            [
                "5cf4d899.199d38",
                "bfbdcb2.d911238"
            ],
            []
        ]
    },
    {
        "id": "c71132ba.e1911",
        "type": "telegram command",
        "z": "e2619ce4.622d3",
        "name": "Restsrt",
        "command": "/reboot000",
        "description": "",
        "registercommand": false,
        "language": "",
        "bot": "294d6779.f90188",
        "strict": false,
        "hasresponse": true,
        "useregex": false,
        "removeregexcommand": false,
        "outputs": 2,
        "x": 70,
        "y": 260,
        "wires": [
            [
                "65e21ade.1eda94"
            ],
            []
        ]
    },
    {
        "id": "53fa5893.cf1818",
        "type": "telegram event",
        "z": "e2619ce4.622d3",
        "name": "",
        "bot": "294d6779.f90188",
        "event": "callback_query",
        "autoanswer": false,
        "x": 100,
        "y": 620,
        "wires": [
            [
                "5cf4d899.199d38",
                "1c5a795a.4ea477"
            ]
        ]
    },
    {
        "id": "2df294b1.982a4c",
        "type": "telegram sender",
        "z": "e2619ce4.622d3",
        "name": "",
        "bot": "294d6779.f90188",
        "haserroroutput": false,
        "outputs": 1,
        "x": 820,
        "y": 100,
        "wires": [
            [
                "2be58eef.40fb82"
            ]
        ]
    },
    {
        "id": "a0a739cc.ae7578",
        "type": "firebird-db",
        "z": "e2619ce4.622d3",
        "firebirddb": "bbe521c8.ab38c",
        "requesttype": "query",
        "name": "Itm Data Base",
        "x": 860,
        "y": 280,
        "wires": [
            [
                "18025ac2.65e7f5"
            ]
        ]
    },
    {
        "id": "d81baa48.b84e88",
        "type": "firebird-db",
        "z": "e2619ce4.622d3",
        "firebirddb": "5a2e1f7a.e61ff",
        "requesttype": "query",
        "name": "Cubic Data Base",
        "x": 870,
        "y": 320,
        "wires": [
            [
                "18025ac2.65e7f5"
            ]
        ]
    },
    {
        "id": "294d6779.f90188",
        "type": "telegram bot",
        "botname": "MassivYugBot",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "1000",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "botpath": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "sslterminated": false,
        "verboselogging": false
    },
    {
        "id": "bbe521c8.ab38c",
        "type": "firebird-database",
        "host": "192.168.2.101",
        "port": "3050",
        "db": "/mnt/2T/Archive/Work/FireBird DB/itm/data base/ITM_DB.FDB"
    },
    {
        "id": "5a2e1f7a.e61ff",
        "type": "firebird-database",
        "host": "192.168.2.101",
        "port": "3050",
        "db": "/mnt/2T/Archive/Work/FireBird DB/cubic 3/CUBIC.FDB"
    }
]